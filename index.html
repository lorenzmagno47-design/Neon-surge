<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Neon Surge Ã— Aura Roller</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Android / Chrome PWA -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#00d4ff">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

<!-- iOS Safari (fallback) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Neon Surge">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- SEO / social -->
<meta name="description" content="Roll rare auras and survive the neon surge. A fast-paced mobile action game.">
<meta name="application-name" content="Neon Surge">

<!-- Prevent address bar from showing on scroll -->
<meta name="format-detection" content="telephone=no">

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Raleway:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#04020f;
  --panel:rgba(255,255,255,0.03);
  --border:rgba(255,255,255,0.07);
  --accent:#c8a8ff;
}
*{ margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { width:100%; height:100%; overflow:hidden; }
body{
  background:var(--bg); color:#fff;
  font-family:'Raleway',sans-serif;
  touch-action:manipulation;
  user-select:none; -webkit-user-select:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAR BACKGROUND
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#stars{
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse at 20% 30%,rgba(80,0,120,.18) 0%,transparent 60%),
    radial-gradient(ellipse at 80% 70%,rgba(0,40,100,.18) 0%,transparent 60%);
}
#stars::before,#stars::after{
  content:''; position:absolute; inset:0;
  background-image:
    radial-gradient(1px 1px at 10% 15%,rgba(255,255,255,.6) 0%,transparent 100%),
    radial-gradient(1px 1px at 25% 45%,rgba(255,255,255,.4) 0%,transparent 100%),
    radial-gradient(1px 1px at 40% 20%,rgba(255,255,255,.7) 0%,transparent 100%),
    radial-gradient(1px 1px at 55% 60%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 70% 10%,rgba(255,255,255,.6) 0%,transparent 100%),
    radial-gradient(1px 1px at 85% 35%,rgba(255,255,255,.4) 0%,transparent 100%),
    radial-gradient(1px 1px at 15% 75%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 90% 80%,rgba(255,255,255,.7) 0%,transparent 100%);
  animation:twinkle 4s ease-in-out infinite alternate;
}
#stars::after{
  background-image:
    radial-gradient(1px 1px at 5%  55%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 30% 85%,rgba(255,255,255,.6) 0%,transparent 100%),
    radial-gradient(1px 1px at 60% 70%,rgba(255,255,255,.7) 0%,transparent 100%),
    radial-gradient(1px 1px at 80%  5%,rgba(255,255,255,.4) 0%,transparent 100%);
  animation-duration:6s; animation-delay:-2s;
}
@keyframes twinkle{from{opacity:.4}to{opacity:1}}

#mythicBg{
  position:fixed; inset:0; z-index:0; pointer-events:none;
  opacity:0; transition:opacity 1s;
  background:radial-gradient(ellipse at 50% 50%,rgba(80,0,150,.8),rgba(0,0,20,.95));
}
#mythicBg.active{opacity:1;}
#mythicPulse{
  position:fixed; inset:0; z-index:0; pointer-events:none; opacity:0;
  background:conic-gradient(from 0deg,#ff006630,#7700ff30,#00ffff30,#ff006630);
  animation:mythicSpin 3s linear infinite;
}
#mythicPulse.active{opacity:1;}
@keyframes mythicSpin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME CANVAS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameCanvas{ display:block; position:fixed; top:0; left:0; z-index:1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME HUD (in-game overlay)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameUI{ position:fixed; inset:0; z-index:10; pointer-events:none; }
#gameHUD{
  position:absolute; top:0; left:0; right:0;
  display:flex; justify-content:space-between; align-items:flex-start;
  padding:clamp(6px,2vw,14px) clamp(8px,2.5vw,18px);
  pointer-events:none;
}
.hud-left,.hud-right{ display:flex; flex-direction:column; gap:clamp(2px,0.6vh,5px); }
.bar-wrap{ display:flex; flex-direction:column; gap:2px; }
.bar-label{ font-size:clamp(6px,1.5vw,9px); letter-spacing:2px; color:#555; text-transform:uppercase; }
.bar-bg{
  width:clamp(80px,18vw,160px);
  height:clamp(5px,1.2vh,9px);
  background:rgba(255,255,255,.07); border-radius:4px; overflow:hidden;
}
.bar-fill{ height:100%; border-radius:4px; }
#healthFill{ background:linear-gradient(90deg,#ff2d55,#ff6b35); box-shadow:0 0 6px #ff2d55; transition:width .12s; }
#staminaFill{ background:linear-gradient(90deg,#00d4ff,#0060ff); box-shadow:0 0 6px #00d4ff; transition:width .08s; }
.hud-right{ text-align:right; }
#scoreDisplay{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(16px,4.5vw,36px);
  color:#fff; text-shadow:0 0 12px #00d4ff; letter-spacing:2px; line-height:1;
}
.score-lbl{ font-size:clamp(6px,1.3vw,9px); letter-spacing:3px; color:#333; }
#hiDisplay{ font-size:clamp(9px,2vw,14px); color:#ffbe00; text-shadow:0 0 6px #ffbe00; }
#levelDisplay{ font-size:clamp(7px,1.6vw,11px); letter-spacing:3px; color:#a855f7; text-shadow:0 0 6px #a855f7; }
#comboDisplay{ font-size:clamp(8px,1.8vw,12px); letter-spacing:2px; color:#ff00aa; text-shadow:0 0 8px #ff00aa; min-height:1em; }
#powerupDisplay{ font-size:clamp(7px,1.5vw,10px); color:#ffbe00; letter-spacing:1px; margin-top:2px; min-height:1em; }
#equippedAuraHUD{
  display:flex; align-items:center; gap:4px;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:7px; padding:3px 7px; margin-top:3px;
}
#equippedAuraHUD .ea-emoji{ font-size:clamp(10px,2.5vw,16px); }
#equippedAuraHUD .ea-info{ display:flex; flex-direction:column; }
#equippedAuraHUD .ea-name{ font-size:clamp(6px,1.4vw,10px); font-weight:700; color:var(--ea-col,#c8a8ff); }
#equippedAuraHUD .ea-buff{ font-size:clamp(5px,1.1vw,8px); color:rgba(255,255,255,.45); }
#diffBadgeHUD{
  padding:2px 8px; border-radius:999px;
  font-size:clamp(6px,1.3vw,9px); font-weight:700; letter-spacing:.1em;
  border:1px solid currentColor; margin-top:2px; text-align:center;
}

/* difficulty colours */
.diff-easy{color:#4dff91;border-color:#4dff91;}
.diff-medium{color:#00d4ff;border-color:#00d4ff;}
.diff-hard{color:#ffd700;border-color:#ffd700;}
.diff-hell{color:#ff6b35;border-color:#ff6b35;}
.diff-impossible{color:#ff0066;border-color:#ff0066;animation:impPulse .8s ease-in-out infinite alternate;}
@keyframes impPulse{from{box-shadow:none}to{box-shadow:0 0 12px #ff0066}}
@keyframes hpPulse{0%,100%{opacity:1}50%{opacity:.4}}
.hp-low{animation:hpPulse .6s infinite;}

/* boss / level banners */
#bossWarning{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:20;
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(18px,5vw,48px); font-weight:900; letter-spacing:4px;
  color:#ff0066; text-shadow:0 0 20px #ff0066,0 0 50px #ff0066;
  pointer-events:none; display:none; animation:warnFlash .4s infinite;
  white-space:nowrap; text-align:center;
}
@keyframes warnFlash{0%,100%{opacity:1}50%{opacity:0}}
#levelBanner{
  position:fixed; top:36%; left:50%; transform:translateX(-50%); z-index:20;
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(14px,4vw,32px); font-weight:900; letter-spacing:4px;
  color:#a855f7; text-shadow:0 0 20px #a855f7;
  pointer-events:none; display:none; text-align:center; white-space:nowrap;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE GAME CONTROLS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mobileControls{
  position:fixed; bottom:0; left:0; right:0;
  height:clamp(140px,26vmin,200px);
  pointer-events:none; display:none; z-index:15;
}
#joystickZone{
  position:absolute;
  bottom:clamp(10px,3vmin,20px); left:clamp(10px,3vmin,20px);
  width:clamp(100px,22vmin,148px); height:clamp(100px,22vmin,148px);
  pointer-events:all;
}
#joystickBase{
  position:absolute; inset:0; border-radius:50%;
  background:rgba(255,255,255,.04); border:2px solid rgba(255,255,255,.1);
}
#joystickKnob{
  position:absolute;
  width:clamp(36px,8vmin,52px); height:clamp(36px,8vmin,52px);
  border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#40e0ff,#0050ff);
  box-shadow:0 0 16px #00d4ff;
  top:50%; left:50%; transform:translate(-50%,-50%);
}
#dashBtn{
  position:absolute;
  bottom:clamp(12px,3vmin,26px); right:clamp(12px,3vmin,26px);
  width:clamp(64px,14vmin,88px); height:clamp(64px,14vmin,88px);
  border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#ff44cc,#7700ff);
  box-shadow:0 0 20px #ff00aa; border:none; color:#fff;
  font-size:clamp(7px,1.5vmin,10px); font-family:'Raleway',sans-serif; letter-spacing:1px;
  pointer-events:all; cursor:pointer;
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  transition:transform .08s,box-shadow .08s;
}
#dashBtn:active{transform:scale(.92);box-shadow:0 0 35px #ff00aa;}
.dash-icon{font-size:clamp(14px,4vmin,22px);}
#dashBtn.on-cooldown{opacity:.5;}
.top-mobile-btns{
  position:fixed; top:clamp(6px,1.5vw,12px); right:clamp(6px,1.5vw,12px);
  display:flex; gap:5px; z-index:20; pointer-events:all;
}
.top-mbtn{
  width:clamp(32px,8vw,44px); height:clamp(32px,8vw,44px);
  border-radius:8px; background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16);
  color:#fff; font-size:clamp(12px,3vw,17px); cursor:pointer; display:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY SCREENS  â€”  lobby / pause / gameover
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:fixed; inset:0; z-index:50;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  background:rgba(0,0,5,.92);
  overflow-y:auto; overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}
.screen.hidden{ display:none; }

/* Pause & Game-over centre their (small) content */
#pauseScreen, #gameOverScreen{
  justify-content:center;
}

/* Scrollable inner content column */
.screen-inner{
  position:relative; z-index:1;
  width:100%;
  max-width:min(520px, 100%);
  padding:clamp(12px,3vw,24px) clamp(12px,3vw,20px) clamp(24px,6vh,60px);
  display:flex; flex-direction:column; align-items:center;
  gap:clamp(8px,2vw,14px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME TITLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.game-title{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(28px,9vw,72px);
  font-weight:900; letter-spacing:clamp(3px,1.5vw,8px); color:#fff;
  text-shadow:0 0 20px #00d4ff,0 0 50px #00d4ff,0 0 100px #0050ff;
  text-align:center; animation:titlePulse 3s ease-in-out infinite; line-height:1.1;
}
@keyframes titlePulse{
  0%,100%{text-shadow:0 0 20px #00d4ff,0 0 50px #00d4ff,0 0 100px #0050ff;}
  50%{text-shadow:0 0 30px #00d4ff,0 0 70px #00d4ff,0 0 140px #0080ff;}
}
.game-subtitle{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(8px,2vw,13px); letter-spacing:clamp(3px,1vw,6px);
  color:#00d4ff; opacity:.7; text-align:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  padding:clamp(9px,2vh,14px) clamp(16px,4vw,34px);
  font-size:clamp(10px,2.5vw,15px); letter-spacing:clamp(2px,0.8vw,4px);
  font-family:'Cinzel Decorative',cursive; font-weight:700;
  border:2px solid #00d4ff; background:transparent; color:#00d4ff;
  cursor:pointer; text-transform:uppercase; transition:all .18s; margin:4px;
  border-radius:4px; position:relative; overflow:hidden; white-space:nowrap;
}
.btn::before{content:'';position:absolute;inset:0;background:#00d4ff;transform:scaleX(0);transform-origin:left;transition:transform .18s;z-index:-1;}
.btn:hover::before,.btn:active::before{transform:scaleX(1);}
.btn:hover,.btn:active{color:#000;box-shadow:0 0 25px #00d4ff;}
.btn-red{border-color:#ff2d55;color:#ff2d55;}
.btn-red::before{background:#ff2d55;}
.btn-red:hover,.btn-red:active{color:#fff;box-shadow:0 0 25px #ff2d55;}
.btn-gold{border-color:#ffd700;color:#ffd700;}
.btn-gold::before{background:#ffd700;}
.btn-gold:hover,.btn-gold:active{color:#000;box-shadow:0 0 25px #ffd700;}
.btn-purple{border-color:#a855f7;color:#a855f7;}
.btn-purple::before{background:#a855f7;}
.btn-purple:hover,.btn-purple:active{color:#fff;box-shadow:0 0 25px #a855f7;}
.btn-small{
  padding:clamp(6px,1.5vh,10px) clamp(10px,2.5vw,20px);
  font-size:clamp(9px,2vw,12px); letter-spacing:clamp(1px,0.5vw,2px); margin:3px;
}

.section-title{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(8px,2vw,12px); letter-spacing:.12em;
  color:rgba(255,255,255,.35); text-align:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR  (essence + daily)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top-bar{ width:100%; display:flex; gap:clamp(6px,1.5vw,10px); align-items:stretch; }
.essence-box{
  flex:1; background:var(--panel); border:1px solid rgba(255,200,50,.2);
  border-radius:10px; padding:clamp(6px,1.5vw,10px) clamp(8px,2vw,14px);
  display:flex; align-items:center; gap:clamp(6px,1.5vw,10px);
}
.essence-val{ font-family:'Cinzel Decorative',cursive; font-size:clamp(12px,3vw,20px); color:#ffd700; }
.essence-lbl{ font-size:clamp(7px,1.5vw,10px); letter-spacing:.12em; text-transform:uppercase; color:rgba(255,255,255,.3); }
.daily-btn{
  background:linear-gradient(135deg,#2d4a00,#1a2d00);
  border:1px solid rgba(100,200,50,.4); border-radius:10px;
  padding:clamp(6px,1.5vw,10px) clamp(8px,2vw,14px);
  font-family:'Raleway',sans-serif; font-size:clamp(9px,2vw,12px);
  font-weight:700; letter-spacing:.08em; color:#7fff6b;
  cursor:pointer; white-space:nowrap; transition:all .2s;
}
.daily-btn:disabled{ opacity:.35; cursor:not-allowed; }

/* boosts */
.boosts-row{
  display:flex; gap:clamp(4px,1vw,7px); flex-wrap:wrap;
  width:100%; justify-content:center; min-height:16px;
}
.boost-chip{
  background:rgba(77,255,145,.1); border:1px solid rgba(77,255,145,.3);
  border-radius:999px; padding:2px clamp(6px,1.5vw,10px);
  font-size:clamp(7px,1.6vw,10px); font-weight:700; color:#4dff91; letter-spacing:.06em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PITY / LUCK METERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.meters-row{ width:100%; display:flex; flex-direction:column; gap:clamp(3px,0.8vh,6px); }
.meter-row{ display:flex; align-items:center; gap:clamp(5px,1.2vw,9px); }
.meter-lbl{
  font-size:clamp(8px,1.8vw,11px); letter-spacing:.06em; text-transform:uppercase;
  color:rgba(255,255,255,.3); width:clamp(44px,10vw,58px); flex-shrink:0;
}
.meter-bar{
  flex:1; height:clamp(4px,0.9vh,7px);
  background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden;
}
.meter-fill{ height:100%; border-radius:999px; transition:width .6s cubic-bezier(.4,0,.2,1); }
.meter-fill.luck{background:linear-gradient(90deg,#4dff91,#7ef7ff);box-shadow:0 0 8px #4dff91;}
.meter-fill.pity-epic{background:linear-gradient(90deg,#8b5cf6,#c084fc);box-shadow:0 0 8px #8b5cf6;}
.meter-fill.pity-leg{background:linear-gradient(90deg,#f59e0b,#ffd700);box-shadow:0 0 8px #f59e0b;}
.meter-fill.pity-myth{background:linear-gradient(90deg,#ff0080,#ff80ff);box-shadow:0 0 8px #ff0080;}
.meter-val{
  font-size:clamp(8px,1.6vw,10px); color:rgba(255,255,255,.35);
  width:clamp(22px,5vw,28px); text-align:right; flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AURA ROLLER SECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.aura-section{
  width:100%; background:var(--panel);
  border:1px solid var(--border); border-radius:16px;
  padding:clamp(12px,3vw,18px);
}
.orb-container{
  position:relative;
  width:clamp(110px,28vmin,168px);
  height:clamp(110px,28vmin,168px);
  display:flex; align-items:center; justify-content:center;
  margin:0 auto;
}
.orb-ring{
  position:absolute; inset:clamp(-6px,-1.5vmin,-9px); border-radius:50%;
  border:2px solid rgba(255,255,255,.08); animation:spinR 8s linear infinite;
}
.orb-ring-2{
  inset:clamp(-14px,-3vmin,-20px); border:1px solid rgba(255,255,255,.05);
  animation:spinR 14s linear infinite reverse;
}
@keyframes spinR{to{transform:rotate(360deg)}}
.orb{
  width:clamp(94px,24vmin,144px);
  height:clamp(94px,24vmin,144px);
  border-radius:50%; position:relative; cursor:pointer; transition:transform .15s;
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  background:
    radial-gradient(circle at 35% 35%,rgba(255,255,255,.15),transparent 60%),
    radial-gradient(circle at 65% 65%,rgba(0,0,0,.4),transparent 60%),#1a0a2e;
  box-shadow:0 0 40px rgba(140,80,255,.3),0 0 80px rgba(140,80,255,.15),inset 0 0 30px rgba(0,0,0,.5);
  border:1px solid rgba(255,255,255,.12);
}
.orb:active{transform:scale(.93);}
.orb-icon{font-size:clamp(1.6rem,5vmin,2.6rem);user-select:none;}
.orb-label{font-size:clamp(6px,1.4vmin,10px);letter-spacing:.2em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-top:2px;}
.orb.rolling{animation:orbPulse .12s ease-in-out infinite alternate;}
@keyframes orbPulse{
  from{transform:scale(.97);box-shadow:0 0 40px rgba(140,80,255,.4),0 0 80px rgba(140,80,255,.2),inset 0 0 30px rgba(0,0,0,.5);}
  to{transform:scale(1.03);box-shadow:0 0 60px rgba(200,140,255,.7),0 0 120px rgba(140,80,255,.4),inset 0 0 30px rgba(0,0,0,.5);}
}
.orb.mythic-spin{animation:mythicOrbSpin 2s ease-in-out;}
@keyframes mythicOrbSpin{
  0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(90deg)}
  50%{transform:scale(1.2) rotate(180deg)}75%{transform:scale(1.15) rotate(270deg)}
  100%{transform:scale(1) rotate(360deg)}
}

/* result card */
.result-mini{
  width:100%; border-radius:12px; padding:clamp(10px,2.5vw,16px);
  text-align:center; border:1px solid var(--border); background:var(--panel);
  transition:all .4s cubic-bezier(.34,1.56,.64,1);
  opacity:0; transform:translateY(10px) scale(.96);
}
.result-mini.visible{opacity:1;transform:translateY(0) scale(1);}
.res-emoji{font-size:clamp(1.8rem,5vmin,2.6rem);display:block;margin-bottom:4px;animation:floatA 3s ease-in-out infinite;}
@keyframes floatA{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.res-name{font-family:'Cinzel Decorative',cursive;font-size:clamp(14px,3.5vw,20px);margin-bottom:4px;text-shadow:0 0 15px currentColor;}
.rarity-badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:clamp(8px,1.8vw,11px);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:5px;border:1px solid currentColor;}
.power-text{font-size:clamp(9px,2vw,12px);color:rgba(200,255,200,.6);margin-top:3px;font-style:italic;}
.buff-display{margin-top:7px;padding:6px 12px;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);font-size:clamp(9px,2vw,12px);color:#ffbe00;text-align:center;}

.equip-btn{
  padding:clamp(6px,1.5vw,9px) clamp(14px,3vw,22px); border-radius:8px;
  border:2px solid #a855f7; background:transparent; color:#a855f7;
  font-family:'Cinzel Decorative',cursive; font-size:clamp(9px,2vw,12px); font-weight:700;
  cursor:pointer; transition:all .18s; letter-spacing:.1em; margin-top:8px;
}
.equip-btn:hover,.equip-btn:active{background:#a855f7;color:#fff;box-shadow:0 0 18px #a855f7;}
.equip-btn.equipped{background:#a855f7;color:#fff;border-color:#a855f7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EQUIPPED AURA PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.equipped-panel{
  width:100%; background:rgba(168,85,247,.07);
  border:1px solid rgba(168,85,247,.3); border-radius:12px;
  padding:clamp(8px,2vw,14px) clamp(10px,2.5vw,18px);
  display:flex; align-items:center; gap:clamp(8px,2vw,14px);
}
.equipped-panel .eq-emoji{font-size:clamp(1.4rem,4vmin,2.2rem);flex-shrink:0;}
.equipped-panel .eq-info{flex:1;min-width:0;}
.equipped-panel .eq-name{font-family:'Cinzel Decorative',cursive;font-size:clamp(10px,2.5vw,15px);color:#c8a8ff;}
.equipped-panel .eq-rarity{font-size:clamp(8px,1.8vw,11px);letter-spacing:.1em;color:rgba(255,255,255,.4);margin-bottom:3px;}
.equipped-panel .eq-buff{font-size:clamp(9px,2vw,12px);color:#4dff91;line-height:1.5;}
.equipped-panel .eq-none{font-size:clamp(9px,2vw,12px);color:rgba(255,255,255,.3);font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIFFICULTY GRID
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.diff-grid{
  display:grid; grid-template-columns:repeat(5,1fr);
  gap:clamp(4px,1vw,8px); width:100%;
}
/* On very narrow screens wrap to 3 columns */
@media(max-width:359px){.diff-grid{grid-template-columns:repeat(3,1fr);}}
.diff-card{
  padding:clamp(7px,1.8vw,12px) clamp(3px,0.8vw,6px);
  border-radius:10px; border:2px solid transparent;
  background:var(--panel); text-align:center; cursor:pointer; transition:all .2s;
}
.diff-card:hover,.diff-card.selected{border-color:var(--dc);box-shadow:0 0 12px var(--dc);}
.diff-card.selected{background:rgba(255,255,255,.06);}
.diff-emoji{font-size:clamp(1rem,3vw,1.5rem);}
.diff-name{font-size:clamp(7px,1.5vw,10px);font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--dc);margin-top:2px;}
.diff-multiplier{font-size:clamp(6px,1.2vw,9px);color:rgba(255,255,255,.4);margin-top:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS BOXES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row{display:flex;gap:clamp(4px,1.2vw,8px);width:100%;flex-wrap:wrap;}
.stat-box{
  flex:1; min-width:clamp(44px,10vw,62px);
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; padding:clamp(6px,1.8vw,11px) clamp(3px,0.8vw,6px); text-align:center;
}
.stat-val{font-family:'Cinzel Decorative',cursive;font-size:clamp(11px,2.8vw,18px);color:#c8a8ff;}
.stat-lbl{font-size:clamp(6px,1.3vw,9px);letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.25);margin-top:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;gap:clamp(4px,1vw,7px);width:100%;}
.tab-btn{
  flex:1; padding:clamp(6px,1.5vw,9px) 3px; border-radius:9px;
  border:1px solid var(--border); background:var(--panel);
  color:rgba(255,255,255,.35); font-family:'Raleway',sans-serif;
  font-size:clamp(8px,2vw,13px); font-weight:700; letter-spacing:.04em;
  text-transform:uppercase; cursor:pointer; transition:all .2s;
}
.tab-btn.active{background:rgba(200,168,255,.12);border-color:rgba(200,168,255,.4);color:#c8a8ff;}
.tab-panel{display:none;width:100%;}
.tab-panel.active{display:flex;flex-direction:column;gap:clamp(7px,1.8vw,12px);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLECTION GRID  (fluid, auto-fill)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.collection-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(clamp(48px,11vw,68px),1fr));
  gap:clamp(4px,1vw,7px); width:100%;
}
.col-item{
  background:var(--panel); border:1px solid var(--border);
  border-radius:8px; padding:clamp(5px,1.2vw,8px) clamp(2px,0.5vw,4px);
  text-align:center; position:relative; cursor:pointer;
  transition:border-color .3s,box-shadow .3s;
}
.col-item.unlocked{border-color:var(--ac,rgba(255,255,255,.2));box-shadow:0 0 7px var(--ag,transparent);}
.col-item.evolved{border-width:2px;}
.col-item.equip-active{outline:2px solid #a855f7;outline-offset:2px;}
.col-emoji{font-size:clamp(.9rem,3.5vmin,1.4rem);filter:grayscale(1);opacity:.2;transition:all .4s;}
.col-item.unlocked .col-emoji{filter:none;opacity:1;}
.col-cnt{position:absolute;top:2px;right:3px;font-size:clamp(6px,1.2vw,9px);font-weight:700;color:rgba(255,255,255,.5);display:none;}
.col-item.unlocked .col-cnt{display:block;}
.col-name{font-size:clamp(6px,1.1vw,9px);letter-spacing:.03em;color:rgba(255,255,255,.2);margin-top:2px;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.col-item.unlocked .col-name{color:rgba(255,255,255,.5);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACHIEVEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ach-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(clamp(130px,38vw,220px),1fr));
  gap:clamp(5px,1.2vw,9px); width:100%;
}
.ach-item{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:clamp(7px,1.8vw,11px);display:flex;gap:clamp(6px,1.5vw,9px);align-items:center;transition:all .3s;}
.ach-item.done{border-color:rgba(255,215,0,.4);background:rgba(255,215,0,.05);}
.ach-item.done .ach-icon{filter:none;opacity:1;}
.ach-icon{font-size:clamp(1.1rem,3.5vmin,1.6rem);filter:grayscale(1);opacity:.2;transition:all .3s;flex-shrink:0;}
.ach-info{flex:1;min-width:0;}
.ach-name{font-size:clamp(9px,2vw,12px);font-weight:700;letter-spacing:.04em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ach-desc{font-size:clamp(7px,1.6vw,10px);color:rgba(255,255,255,.35);margin-top:1px;}
.ach-reward{font-size:clamp(7px,1.4vw,9px);color:#ffd700;margin-top:2px;}
.ach-progress{font-size:clamp(6px,1.3vw,9px);color:rgba(255,255,255,.3);margin-top:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.history-list{width:100%;display:flex;flex-direction:column;gap:clamp(3px,0.8vw,5px);max-height:clamp(180px,38vh,300px);overflow-y:auto;}
.hist-item{display:flex;align-items:center;gap:clamp(7px,1.8vw,11px);padding:clamp(5px,1.2vw,8px) clamp(7px,2vw,12px);background:var(--panel);border:1px solid var(--border);border-radius:7px;font-size:clamp(9px,2vw,12px);}
.hist-emoji{font-size:clamp(13px,3vw,18px);}
.hist-name{flex:1;font-weight:600;}
.hist-rarity{font-size:clamp(7px,1.5vw,10px);letter-spacing:.08em;opacity:.5;}
.hist-new{font-size:clamp(6px,1.3vw,9px);background:linear-gradient(90deg,#ff6b6b,#ffd93d);color:#000;padding:1px 5px;border-radius:999px;font-weight:800;}

/* rarity graph */
.rarity-graph{width:100%;display:flex;flex-direction:column;gap:clamp(3px,0.8vw,6px);}
.rg-row{display:flex;align-items:center;gap:clamp(5px,1.2vw,9px);}
.rg-label{font-size:clamp(7px,1.5vw,10px);text-transform:uppercase;letter-spacing:.08em;width:clamp(44px,11vw,62px);flex-shrink:0;}
.rg-bar{flex:1;height:clamp(5px,1vw,8px);background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden;}
.rg-fill{height:100%;border-radius:4px;transition:width .8s;}
.rg-count{font-size:clamp(7px,1.4vw,10px);color:rgba(255,255,255,.35);width:clamp(18px,4vw,26px);text-align:right;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FUSION / PRESTIGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fusion-list{display:flex;flex-direction:column;gap:clamp(5px,1.2vw,9px);width:100%;}
.fusion-item{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:clamp(9px,2vw,13px);display:flex;align-items:center;gap:clamp(7px,1.8vw,11px);}
.fusion-recipe{flex:1;font-size:clamp(8px,1.8vw,11px);line-height:1.5;}
.fusion-result{font-size:clamp(9px,2vw,12px);font-weight:700;color:#ffd700;}
.fusion-btn{padding:clamp(4px,1vw,7px) clamp(9px,2vw,14px);border-radius:7px;border:1px solid rgba(255,215,0,.4);background:rgba(255,215,0,.08);color:#ffd700;font-size:clamp(8px,1.8vw,11px);font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s;}
.fusion-btn:disabled{opacity:.3;cursor:not-allowed;}
.fusion-btn:not(:disabled):active{transform:scale(.96);}

.prestige-panel{background:linear-gradient(135deg,rgba(255,215,0,.06),rgba(255,140,0,.06));border:1px solid rgba(255,215,0,.2);border-radius:14px;padding:clamp(12px,3vw,18px);text-align:center;width:100%;}
.prestige-panel h3{font-family:'Cinzel Decorative',cursive;font-size:clamp(13px,3vw,18px);color:#ffd700;margin-bottom:6px;}
.prestige-panel p{font-size:clamp(9px,2vw,12px);color:rgba(255,255,255,.45);line-height:1.6;margin-bottom:9px;}
.prestige-do-btn{padding:clamp(8px,2vw,11px) clamp(18px,4vw,26px);border-radius:9px;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;font-family:'Cinzel Decorative',cursive;font-size:clamp(10px,2.2vw,13px);font-weight:700;border:none;cursor:pointer;transition:all .2s;}
.prestige-do-btn:disabled{opacity:.3;cursor:not-allowed;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME OVER / PAUSE SCREENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.over-score{font-family:'Cinzel Decorative',cursive;font-size:clamp(28px,8vw,60px);color:#ffbe00;text-shadow:0 0 20px #ffbe00;margin:8px 0;font-weight:900;}
.over-lbl{font-size:clamp(8px,1.8vw,11px);letter-spacing:5px;color:#444;}
.stat-row{display:flex;justify-content:space-between;gap:clamp(20px,8vw,60px);margin:clamp(3px,0.8vh,6px) 0;font-size:clamp(10px,2.2vw,14px);}
.stat-label-sm{color:#444;letter-spacing:2px;}
.stat-v{color:#fff;}
#newHiMsg{color:#ffbe00;letter-spacing:4px;font-size:clamp(9px,2vw,12px);margin-bottom:5px;display:none;}
@keyframes hiPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
#newHiMsg.show{display:block;animation:hiPulse .8s infinite;}
#pauseScreenTitle{font-family:'Cinzel Decorative',cursive;font-size:clamp(22px,6vw,42px);letter-spacing:6px;color:#fff;margin-bottom:20px;text-shadow:0 0 15px #fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC CHIPS / BADGES / TITLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.streak-chip{
  position:absolute; top:clamp(-9px,-2vmin,-6px); right:clamp(-9px,-2vmin,-6px);
  background:linear-gradient(135deg,#ff6b6b,#ffd93d); color:#000;
  font-size:clamp(7px,1.6vmin,10px); font-weight:800;
  padding:2px clamp(5px,1.2vw,8px); border-radius:999px;
  display:none; white-space:nowrap; box-shadow:0 0 10px rgba(255,150,50,.7);
}
.streak-chip.show{display:block;}

.new-badge{display:inline-block;background:linear-gradient(90deg,#ff6b6b,#ffd93d);color:#000;font-size:clamp(6px,1.3vw,9px);font-weight:800;letter-spacing:.06em;padding:1px 6px;border-radius:999px;margin-left:5px;vertical-align:middle;}
.event-badge{background:linear-gradient(90deg,#ff6b6b,#ff00ff);color:#fff;font-size:clamp(6px,1.2vw,8px);font-weight:800;padding:1px 6px;border-radius:999px;margin-left:4px;vertical-align:middle;animation:evtPulse 1s ease-in-out infinite alternate;}
@keyframes evtPulse{from{opacity:.7}to{opacity:1}}
.prestige-badge{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;font-size:clamp(7px,1.5vw,10px);font-weight:700;letter-spacing:.08em;padding:2px 8px;border-radius:999px;display:none;}
.prestige-badge.show{display:inline-block;}

.titles-row{display:flex;flex-wrap:wrap;gap:clamp(4px,1vw,7px);}
.title-chip{padding:clamp(3px,0.8vw,5px) clamp(8px,2vw,13px);border-radius:999px;font-size:clamp(8px,1.8vw,11px);letter-spacing:.08em;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);color:rgba(255,255,255,.25);cursor:pointer;transition:all .2s;}
.title-chip.unlocked{border-color:var(--tc,rgba(200,168,255,.5));color:var(--tc,#c8a8ff);background:rgba(200,168,255,.08);}
.title-chip.active-title{box-shadow:0 0 10px var(--tc,rgba(200,168,255,.5));font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES & EFFECTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.particle{position:fixed;pointer-events:none;border-radius:50%;z-index:999;animation:pFly 1.2s ease-out forwards;}
@keyframes pFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
.shake{animation:shake .5s ease;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed; bottom:clamp(14px,4vh,24px); left:50%;
  transform:translateX(-50%) translateY(20px);
  background:rgba(20,10,40,.96); border:1px solid rgba(200,168,255,.3);
  border-radius:11px; padding:clamp(7px,1.8vw,11px) clamp(12px,3vw,20px);
  font-size:clamp(10px,2.2vw,13px); font-weight:600;
  color:#c8a8ff; z-index:9999; pointer-events:none;
  opacity:0; transition:all .35s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap; max-width:min(90vw,420px);
  text-overflow:ellipsis; overflow:hidden;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(200,168,255,.2);border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE BREAKPOINTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Large screens: wider inner content */
@media (min-width: 640px) {
  .screen-inner { max-width:min(580px, 96%); }
}
@media (min-width: 900px) {
  .screen-inner { max-width:min(660px, 92%); }
}

/* Landscape phones: compress vertically */
@media (max-height: 500px) and (orientation: landscape) {
  .screen-inner { padding-top: 8px; gap: 7px; }
  .game-title { font-size: clamp(20px, 5vw, 34px); }
  .orb-container { width: 90px; height: 90px; }
  .orb { width: 78px; height: 78px; }
  .meters-row { display: none; }  /* hide pity bars to save space */
  .boosts-row { min-height: 0; }
}

/* Very small phones */
@media (max-width: 360px) {
  .screen-inner { padding-left: 8px; padding-right: 8px; gap: 7px; }
  .btn { padding: 8px 12px; font-size: 9px; }
  .stat-box { min-width: 40px; }
}

/* â•â• SHAPE GRID â•â• */
.shape-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(clamp(54px,12vw,72px),1fr));gap:clamp(5px,1.2vw,9px);width:100%;}
.shape-card{background:var(--panel);border:2px solid var(--border);border-radius:10px;padding:clamp(6px,1.5vw,10px) 4px;text-align:center;cursor:pointer;transition:all .2s;}
.shape-card:hover,.shape-card.selected{border-color:#a855f7;box-shadow:0 0 14px #a855f7;}
.shape-card.selected{background:rgba(168,85,247,.1);}
.shape-preview{font-size:clamp(1rem,3.5vmin,1.6rem);line-height:1;}
.shape-name{font-size:clamp(7px,1.4vw,9px);font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:#c8a8ff;margin-top:3px;}
/* â•â• FUSE SELECTS â•â• */
.fuse-select{background:#0a0520;border:1px solid rgba(168,85,247,.4);border-radius:8px;color:#c8a8ff;font-family:'Raleway',sans-serif;font-size:clamp(9px,2vw,12px);padding:6px 10px;cursor:pointer;flex:1;min-width:clamp(100px,28vw,160px);}
.fuse-select:focus{outline:none;border-color:#a855f7;}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INTRO SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#introScreen{
  position:fixed;inset:0;z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:#030310;overflow:hidden;
}
#introScreen.fade-out{animation:introFade .7s ease forwards;}
@keyframes introFade{to{opacity:0;pointer-events:none;}}
.intro-bg-rings{position:absolute;inset:0;pointer-events:none;}
.intro-ring{
  position:absolute;border-radius:50%;border:1px solid rgba(0,212,255,.15);
  top:50%;left:50%;transform:translate(-50%,-50%);
  animation:introRingPulse 3s ease-in-out infinite;
}
.intro-ring:nth-child(1){width:140vmax;height:140vmax;animation-delay:0s;}
.intro-ring:nth-child(2){width:100vmax;height:100vmax;animation-delay:.5s;border-color:rgba(168,85,247,.12);}
.intro-ring:nth-child(3){width:60vmax;height:60vmax;animation-delay:1s;border-color:rgba(255,0,170,.1);}
@keyframes introRingPulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(1);}50%{opacity:1;transform:translate(-50%,-50%) scale(1.03);}}
.intro-title-wrap{position:relative;z-index:2;text-align:center;}
.intro-main{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(36px,12vw,90px);font-weight:900;
  letter-spacing:clamp(4px,2vw,12px);
  color:#fff;
  text-shadow:0 0 30px #00d4ff,0 0 70px #00d4ff,0 0 150px #0050ff;
  animation:introTitleIn .8s cubic-bezier(.22,1,.36,1) both;
  line-height:1;
}
@keyframes introTitleIn{from{opacity:0;transform:translateY(40px) scale(.92);}to{opacity:1;transform:none;}}
.intro-sub{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(9px,2.5vw,16px);letter-spacing:clamp(4px,1.5vw,8px);
  color:#00d4ff;opacity:.75;margin-top:8px;
  animation:introTitleIn .8s .2s cubic-bezier(.22,1,.36,1) both;
}
.intro-tap{
  font-family:'Raleway',sans-serif;font-size:clamp(10px,2.5vw,14px);
  letter-spacing:4px;text-transform:uppercase;color:rgba(255,255,255,.55);
  margin-top:clamp(24px,6vw,48px);
  animation:introTapPulse 1.5s ease-in-out infinite, introTitleIn .8s .6s cubic-bezier(.22,1,.36,1) both;
}
@keyframes introTapPulse{0%,100%{opacity:.35;}50%{opacity:.9;}}
.intro-particles-wrap{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.intro-spark{
  position:absolute;border-radius:50%;
  animation:introSparkFloat linear infinite;
  opacity:0;
}
@keyframes introSparkFloat{
  0%{opacity:0;transform:translateY(0) scale(0);}
  10%{opacity:1;transform:translateY(-10px) scale(1);}
  90%{opacity:.5;}
  100%{opacity:0;transform:translateY(-120px) scale(.3);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN FLASH (Mythic / damage)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screenFlash{
  position:fixed;inset:0;z-index:100;pointer-events:none;
  opacity:0;transition:opacity .06s;
}
#screenFlash.active{opacity:1;transition:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPGRADE MENU
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#upgradeModal{
  display:none;position:fixed;inset:0;z-index:9100;
  background:rgba(0,0,0,.88);backdrop-filter:blur(10px);
  align-items:center;justify-content:center;padding:clamp(10px,3vw,20px);
}
.upgrade-inner{
  background:linear-gradient(145deg,#0a0520,#060218);
  border:1px solid rgba(168,85,247,.4);border-radius:20px;
  padding:clamp(16px,4vw,24px);width:100%;max-width:400px;
  max-height:85svh;max-height:85vh;overflow-y:auto;
}
.upgrade-title{
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(12px,3vw,18px);color:#a855f7;text-align:center;
  margin-bottom:4px;
}
.upgrade-essence{
  font-size:clamp(10px,2.2vw,13px);color:#ffd700;text-align:center;
  margin-bottom:clamp(12px,3vw,18px);
}
.upg-item{
  display:flex;align-items:center;gap:12px;
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
  border-radius:12px;padding:clamp(10px,2.5vw,14px);
  margin-bottom:8px;
}
.upg-icon{font-size:clamp(18px,5vw,26px);}
.upg-info{flex:1;}
.upg-name{font-size:clamp(10px,2.3vw,13px);font-weight:700;color:#e2d4ff;margin-bottom:2px;}
.upg-desc{font-size:clamp(8px,1.8vw,10px);color:rgba(255,255,255,.4);margin-bottom:4px;}
.upg-level{font-size:clamp(7px,1.5vw,9px);color:#a855f7;letter-spacing:.05em;}
.upg-btn{
  background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.5);
  border-radius:8px;padding:6px 14px;color:#c084fc;
  font-size:clamp(8px,2vw,11px);font-weight:700;letter-spacing:.06em;
  cursor:pointer;white-space:nowrap;transition:all .18s;font-family:'Raleway',sans-serif;
}
.upg-btn:hover{background:rgba(168,85,247,.35);box-shadow:0 0 14px #a855f7;}
.upg-btn:disabled{opacity:.3;cursor:not-allowed;}
.upg-btn.maxed{color:#4dff91;border-color:#4dff91;background:rgba(77,255,145,.08);}

/* Aura Level Indicator */
.aura-level-badge{
  display:inline-flex;align-items:center;gap:3px;
  background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.4);
  border-radius:999px;padding:2px 8px;
  font-size:clamp(7px,1.5vw,9px);color:#c084fc;font-weight:700;letter-spacing:.05em;
  margin-left:4px;
}

/* Floating Essence Number */
.essence-float{
  position:fixed;pointer-events:none;z-index:150;
  font-family:'Cinzel Decorative',cursive;
  font-size:clamp(12px,3vw,18px);font-weight:700;
  color:#ffd700;text-shadow:0 0 12px #ffd700;
  animation:essenceFloat .9s ease-out forwards;
}
@keyframes essenceFloat{
  0%{opacity:1;transform:translateY(0) scale(.8);}
  20%{transform:translateY(-10px) scale(1.1);}
  100%{opacity:0;transform:translateY(-70px) scale(.9);}
}

/* Hit-stop flash on enemy hit */
@keyframes hitStop{0%,100%{filter:none;}50%{filter:brightness(3) saturate(0);}}
.hit-stop{animation:hitStop .07s ease;}

/* Combo popup */
#comboPop{
  position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);z-index:30;
  pointer-events:none;text-align:center;
  font-family:'Cinzel Decorative',cursive;opacity:0;
}
#comboPop.show{animation:comboBurst .6s cubic-bezier(.22,1,.36,1) forwards;}
@keyframes comboBurst{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.4);}
  35%{opacity:1;transform:translate(-50%,-50%) scale(1.2);}
  70%{transform:translate(-50%,-50%) scale(0.95);}
  100%{opacity:0;transform:translate(-50%,-55%) scale(.9);}
}
.combo-pop-num{font-size:clamp(28px,8vw,60px);font-weight:900;color:#ff00aa;text-shadow:0 0 30px #ff00aa,0 0 60px #ff00aa;}
.combo-pop-txt{font-size:clamp(10px,2.5vw,16px);letter-spacing:6px;color:#fff;opacity:.8;margin-top:4px;}

/* Mythic screen flash override */
#mythicFlash{position:fixed;inset:0;z-index:99;pointer-events:none;opacity:0;background:rgba(255,0,200,.25);transition:opacity .08s;}


/* Safe area insets for Android notch / cutout */
:root {
  --sat: env(safe-area-inset-top, 0px);
  --sar: env(safe-area-inset-right, 0px);
  --sab: env(safe-area-inset-bottom, 0px);
  --sal: env(safe-area-inset-left, 0px);
}
#gameHUD {
  padding-top: max(clamp(6px,2vw,14px), var(--sat)) !important;
}
#mobileControls {
  padding-bottom: var(--sab);
}
.top-mobile-btns {
  top: max(clamp(6px,1.5vw,12px), var(--sat)) !important;
  right: max(clamp(6px,1.5vw,12px), var(--sar)) !important;
}
#joystickZone {
  bottom: max(clamp(10px,3vmin,20px), calc(var(--sab) + 4px)) !important;
}
#dashBtn {
  bottom: max(clamp(12px,3vmin,26px), calc(var(--sab) + 4px)) !important;
}
</style>
</head>
<body>
<!-- INTRO SCREEN -->
<div id="introScreen">
  <div class="intro-bg-rings">
    <div class="intro-ring"></div>
    <div class="intro-ring"></div>
    <div class="intro-ring"></div>
  </div>
  <div class="intro-particles-wrap" id="introParticles"></div>
  <div class="intro-title-wrap">
    <div class="intro-main">NEON SURGE</div>
    <div class="intro-sub">Ã— AURA ROLLER</div>
    <div class="intro-tap">tap anywhere to start</div>
  </div>
</div>

<!-- SCREEN FLASH -->
<div id="screenFlash"></div>
<div id="mythicFlash"></div>

<!-- COMBO POP -->
<div id="comboPop"><div class="combo-pop-num" id="comboPopNum"></div><div class="combo-pop-txt">COMBO</div></div>

<!-- UPGRADE MODAL -->
<div id="upgradeModal" style="display:none">
  <div class="upgrade-inner">
    <div class="upgrade-title">âš¡ SKILL UPGRADES</div>
    <div class="upgrade-essence">ğŸ’ <span id="upgradeEssenceVal">0</span> Essence</div>
    <div id="upgradeList"></div>
    <div style="text-align:center;margin-top:10px">
      <button class="btn btn-small" onclick="closeUpgradeMenu()">âœ• Close</button>
    </div>
  </div>
</div>

<div id="mythicBg"></div>
<div id="mythicPulse"></div>
<div id="stars"></div>
<div class="toast" id="toast"></div>

<!-- GAME CANVAS -->
<canvas id="gameCanvas"></canvas>

<!-- GAME UI (HUD shown during gameplay) -->
<div id="gameUI">
  <div id="gameHUD" style="display:none">
    <div class="hud-left">
      <div class="bar-wrap"><div class="bar-label">HEALTH</div><div class="bar-bg"><div class="bar-fill" id="healthFill" style="width:100%"></div></div></div>
      <div class="bar-wrap"><div class="bar-label">STAMINA</div><div class="bar-bg"><div class="bar-fill" id="staminaFill" style="width:100%"></div></div></div>
      <div id="levelDisplay">LEVEL 1</div>
      <div id="comboDisplay"></div>
      <div id="equippedAuraHUD"><span class="ea-emoji">ğŸ”®</span><div class="ea-info"><span class="ea-name">No Aura</span><span class="ea-buff">â€”</span></div></div>
    </div>
    <div class="hud-right">
      <div class="score-lbl">SCORE</div>
      <div id="scoreDisplay">0</div>
      <div id="hiDisplay">HI: 0</div>
      <div id="diffBadgeHUD" class="diff-easy">EASY</div>
      <div id="powerupDisplay"></div>
    </div>
  </div>
  <div id="bossWarning">âš  BOSS INCOMING âš </div>
  <div id="levelBanner"></div>
</div>

<!-- MOBILE CONTROLS -->
<div id="mobileControls">
  <div id="joystickZone"><div id="joystickBase"></div><div id="joystickKnob"></div></div>
  <button id="dashBtn"><span class="dash-icon">âš¡</span>DASH</button>
</div>
<div class="top-mobile-btns" id="topMobileBtns">
  <button class="top-mbtn" id="pauseBtn">â¸</button>
</div>

<!-- â•â•â•â•â•â•â• LOBBY / MAIN MENU SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="lobbyScreen">
  <div class="screen-inner">
    <div class="game-title">NEON SURGE</div>
    <div class="game-subtitle">Ã— AURA ROLLER</div>

    <!-- Essence + Daily -->
    <div class="top-bar" style="width:100%">
      <div class="essence-box">
        <span style="font-size:1.1rem">ğŸ’</span>
        <div><div class="essence-val" id="essenceVal">0</div><div class="essence-lbl">Essence</div></div>
      </div>
      <button class="daily-btn" id="dailyBtn" onclick="claimDaily()">ğŸ Daily</button>
    </div>

    <!-- Active boosts -->
    <div class="boosts-row" id="boostsRow"></div>

    <!-- Pity / Luck meters -->
    <div class="meters-row">
      <div class="meter-row"><div class="meter-lbl">ğŸ€ Luck</div><div class="meter-bar"><div class="meter-fill luck" id="luckFill" style="width:0%"></div></div><div class="meter-val" id="luckVal">0%</div></div>
      <div class="meter-row"><div class="meter-lbl">ğŸ”® Epic</div><div class="meter-bar"><div class="meter-fill pity-epic" id="pityEpicFill" style="width:0%"></div></div><div class="meter-val" id="pityEpicVal">0</div></div>
      <div class="meter-row"><div class="meter-lbl">âš¡ Leg</div><div class="meter-bar"><div class="meter-fill pity-leg" id="pityLegFill" style="width:0%"></div></div><div class="meter-val" id="pityLegVal">0</div></div>
      <div class="meter-row"><div class="meter-lbl">ğŸŒˆ Myth</div><div class="meter-bar"><div class="meter-fill pity-myth" id="pityMythFill" style="width:0%"></div></div><div class="meter-val" id="pityMythVal">0</div></div>
    </div>

    <!-- AURA ROLLER -->
    <div class="aura-section">
      <div class="section-title" style="margin-bottom:10px">âœ¨ AURA ROLLER</div>
      <div class="orb-container">
        <div class="orb-ring"></div><div class="orb-ring orb-ring-2"></div>
        <div class="orb" id="orb" onclick="roll()">
          <span class="orb-icon" id="orbIcon">ğŸ”®</span>
          <span class="orb-label">Tap to Roll</span>
        </div>
        <div class="streak-chip" id="streakChip"></div>
      </div>
      <div style="display:flex;gap:7px;margin-top:10px;justify-content:center">
        <button class="btn btn-small btn-purple" id="rollBtn" onclick="roll()">âš¡ ROLL</button>
        <button class="btn btn-small btn-gold" onclick="openShop()">ğŸ›’ Shop</button>
      </div>
      <div class="result-mini" id="resultCard">
        <span class="res-emoji" id="resEmoji">âœ¨</span>
        <div class="res-name" id="resName">???</div>
        <div class="rarity-badge" id="resBadge">â€”</div>
        <div class="power-text" id="resPower"></div>
        <div class="buff-display" id="resBuff" style="display:none"></div>
        <button class="equip-btn" id="equipBtn" onclick="equipLastRolled()" style="display:none">ğŸ›¡ EQUIP AURA</button>
      </div>
    </div>

    <!-- EQUIPPED AURA PANEL -->
    <div class="equipped-panel">
      <span class="eq-emoji" id="eqEmoji">ğŸ”®</span>
      <div class="eq-info">
        <div class="eq-name" id="eqName">No Aura Equipped</div>
        <div class="eq-rarity" id="eqRarity">â€”</div>
        <div class="eq-buff" id="eqBuff"><span class="eq-none">Roll and equip an aura to gain buffs in battle!</span></div>
      </div>
      <button class="btn btn-small btn-red" onclick="unequipAura()" id="unequipBtn" style="display:none">âœ•</button>
    </div>

    <!-- DIFFICULTY -->
    <div style="width:100%">
      <div class="section-title" style="margin-bottom:8px">âš” DIFFICULTY</div>
      <div class="diff-grid" id="diffGrid"></div>
    </div>

    <!-- PLAYER SHAPE -->
    <div style="width:100%">
      <div class="section-title" style="margin-bottom:8px">ğŸ”· PLAYER SHAPE</div>
      <div class="shape-grid" id="shapeGrid"></div>
    </div>

    <!-- RANDOM FUSION -->
    <div class="aura-section" id="randomFusePanel">
      <div class="section-title" style="margin-bottom:8px">ğŸ² RANDOM FUSE</div>
      <div style="font-size:clamp(8px,1.8vw,11px);color:rgba(255,255,255,.4);text-align:center;margin-bottom:8px">Sacrifice 2 auras â†’ get a random new one (must have â‰¥2 different collected auras)</div>
      <div id="randomFuseSelectors" style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:10px">
        <select id="fuseA" class="fuse-select">
          <option>â€” Aura A â€”</option>
        </select>
        <span style="font-size:1.2rem;color:#a855f7">+</span>
        <select id="fuseB" class="fuse-select">
          <option>â€” Aura B â€”</option>
        </select>
      </div>
      <div style="text-align:center">
        <button class="btn btn-small btn-purple" id="randomFuseBtn" onclick="doRandomFuse()">ğŸ² FUSE</button>
      </div>
      <div id="randomFuseResult" style="margin-top:8px;text-align:center;font-size:clamp(10px,2.2vw,13px);color:#ffd700;min-height:1.4em"></div>
    </div>

    <!-- BG MUSIC TOGGLE -->
    <div style="width:100%;display:flex;align-items:center;justify-content:center;gap:10px">
      <button class="btn btn-small" id="musicBtn" onclick="toggleBgMusic()" style="border-color:#a855f7;color:#a855f7">ğŸµ Music: ON</button>
    </div>

    <!-- PLAY BUTTON -->
    <button class="btn btn-purple" onclick="openUpgradeMenu()" style="font-size:clamp(10px,2.3vw,14px);padding:clamp(9px,2.5vh,13px) clamp(20px,5vw,38px)">âš¡ SKILLS</button>
    <button class="btn" id="playBtn" onclick="startGame()" style="font-size:clamp(13px,3vw,18px);padding:clamp(12px,3vh,18px) clamp(28px,7vw,54px);margin-top:4px">â–¶ PLAY</button>

    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-box"><div class="stat-val" id="statRolls">0</div><div class="stat-lbl">Rolls</div></div>
      <div class="stat-box"><div class="stat-val" id="statRarest">â€”</div><div class="stat-lbl">Rarest</div></div>
      <div class="stat-box"><div class="stat-val" id="statCollected">0</div><div class="stat-lbl">Found</div></div>
      <div class="stat-box"><div class="stat-val" id="statGamesPlayed">0</div><div class="stat-lbl">Games</div></div>
      <div class="stat-box"><div class="stat-val" id="statPrestige">0</div><div class="stat-lbl">Prestige</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('collection',this)">ğŸ“–</button>
      <button class="tab-btn" onclick="switchTab('history',this)">ğŸ“œ</button>
      <button class="tab-btn" onclick="switchTab('achievements',this)">ğŸ†</button>
      <button class="tab-btn" onclick="switchTab('fusion',this)">âš—ï¸</button>
      <button class="tab-btn" onclick="switchTab('prestige',this)">â­</button>
    </div>

    <!-- COLLECTION TAB -->
    <div class="tab-panel active" id="tab-collection">
      <div class="section-title">ğŸ“– Collection (<span id="collCount">0</span>/<span id="collTotal">0</span>) â€” Tap to Equip</div>
      <div class="collection-grid" id="collectionGrid"></div>
    </div>
    <!-- HISTORY TAB -->
    <div class="tab-panel" id="tab-history">
      <div class="section-title">Last 20 Rolls</div>
      <div class="rarity-graph" id="rarityGraph"></div>
      <div class="history-list" id="historyList"></div>
    </div>
    <!-- ACHIEVEMENTS TAB -->
    <div class="tab-panel" id="tab-achievements">
      <div class="section-title">ğŸ† Achievements (<span id="achCount">0</span>/<span id="achTotal">0</span>)</div>
      <div class="ach-grid" id="achGrid"></div>
      <div class="section-title" style="margin-top:8px">ğŸ… Titles</div>
      <div class="titles-row" id="titlesRow"></div>
    </div>
    <!-- FUSION TAB -->
    <div class="tab-panel" id="tab-fusion">
      <div class="section-title">âš—ï¸ Aura Fusion</div>
      <div class="fusion-list" id="fusionList"></div>
    </div>
    <!-- PRESTIGE TAB -->
    <div class="tab-panel" id="tab-prestige">
      <div class="prestige-panel">
        <h3>â­ Prestige</h3>
        <p>After 1,000 rolls, Prestige to reset your collection but gain a permanent <strong style="color:#ffd700">+2% luck</strong> boost. Essence, achievements and titles remain.</p>
        <p id="prestigeStatus" style="color:#c8a8ff;margin-bottom:10px;">Rolls to prestige: 1000</p>
        <button class="prestige-do-btn" id="prestigeBtn" onclick="doPrestige()" disabled>âœ¨ Prestige Now</button>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â• PAUSE SCREEN â•â•â•â•â•â•â• -->
<div class="screen hidden" id="pauseScreen">
  <div id="pauseScreenTitle">PAUSED</div>
  <button class="btn" id="resumeBtn" onclick="togglePause()">RESUME</button>
  <button class="btn btn-gold" onclick="goToLobby()">ğŸ  LOBBY</button>
  <button class="btn btn-red" onclick="goToLobby()">QUIT GAME</button>
</div>

<!-- â•â•â•â•â•â•â• GAME OVER SCREEN â•â•â•â•â•â•â• -->
<div class="screen hidden" id="gameOverScreen">
  <div class="game-title" style="font-size:clamp(28px,7vw,52px);text-shadow:0 0 25px #ff2d55,0 0 55px #ff2d55">GAME OVER</div>
  <div class="over-lbl">SCORE</div>
  <div class="over-score" id="overScore">0</div>
  <div id="newHiMsg">â˜… NEW HIGH SCORE â˜…</div>
  <div style="margin:6px 0 16px;text-align:center;">
    <div class="stat-row"><span class="stat-label-sm">DIFFICULTY</span><span class="stat-v" id="overDiff">â€”</span></div>
    <div class="stat-row"><span class="stat-label-sm">LEVEL</span><span class="stat-v" id="overLevel">1</span></div>
    <div class="stat-row"><span class="stat-label-sm">MAX COMBO</span><span class="stat-v" id="overCombo">0</span></div>
    <div class="stat-row"><span class="stat-label-sm">ENEMIES KILLED</span><span class="stat-v" id="overKills">0</span></div>
    <div class="stat-row"><span class="stat-label-sm">AURA USED</span><span class="stat-v" id="overAura">None</span></div>
  </div>
  <button class="btn" id="restartBtn">PLAY AGAIN</button>
  <button class="btn btn-gold" onclick="goToLobby()">ğŸ  LOBBY</button>
</div>

<!-- SHOP MODAL -->
<div id="shopModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:clamp(10px,3vw,20px);">
  <div style="background:#0a0520;border:1px solid rgba(200,168,255,.3);border-radius:18px;padding:18px;width:100%;max-width:400px;max-height:85svh;max-height:85vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <span style="font-family:'Cinzel Decorative',cursive;font-size:.95rem;color:#ffd700">ğŸ›’ Essence Shop</span>
      <span style="font-size:.75rem;color:#ffd700">ğŸ’ <span id="shopEssenceVal">0</span></span>
      <button onclick="closeShop()" style="background:none;border:none;color:rgba(255,255,255,.5);font-size:1.1rem;cursor:pointer">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;" id="shopGrid"></div>
  </div>
</div>

<script>
"use strict";
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  NEON SURGE Ã— AURA ROLLER â€” Full Merged Game                â•‘
// â•‘  Aura system: roll auras, equip for in-game buffs           â•‘
// â•‘  Difficulty: Easy / Medium / Hard / Hell / Impossible       â•‘
// â•‘  Achievements: roller + combat combined                     â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
if(isMobile){
  document.getElementById('mobileControls').style.display = 'block';
  document.getElementById('topMobileBtns').style.display = 'flex';
  document.querySelectorAll('.top-mbtn').forEach(b=>b.style.display='block');
}

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
let soundEnabled = true;
function ensureAudio(){
  if(!audioCtx) try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
  if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
}
function playTone(o){
  if(!soundEnabled||!audioCtx) return;
  try{
    const {type='sine',freq=440,freq2,duration=.15,vol=.3,attack=.01,decay=.1,pan=0}=o;
    const now=audioCtx.currentTime;
    const osc=audioCtx.createOscillator(), gain=audioCtx.createGain(), panner=audioCtx.createStereoPanner();
    osc.type=type; osc.frequency.setValueAtTime(freq,now);
    if(freq2!==undefined) osc.frequency.linearRampToValueAtTime(freq2,now+duration);
    gain.gain.setValueAtTime(0,now); gain.gain.linearRampToValueAtTime(vol,now+attack);
    gain.gain.exponentialRampToValueAtTime(.0001,now+attack+decay);
    panner.pan.value=Math.max(-1,Math.min(1,pan));
    osc.connect(gain);gain.connect(panner);panner.connect(audioCtx.destination);
    osc.start(now);osc.stop(now+duration);
  }catch(e){}
}
function playNoise(dur=.1,vol=.2,type='bandpass',freq=1000){
  if(!soundEnabled||!audioCtx) return;
  try{
    const now=audioCtx.currentTime, buf=audioCtx.createBuffer(1,audioCtx.sampleRate*dur,audioCtx.sampleRate);
    const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    const src=audioCtx.createBufferSource(), filt=audioCtx.createBiquadFilter(), gain=audioCtx.createGain();
    src.buffer=buf; filt.type=type; filt.frequency.value=freq;
    gain.gain.setValueAtTime(vol,now); gain.gain.exponentialRampToValueAtTime(.0001,now+dur);
    src.connect(filt);filt.connect(gain);gain.connect(audioCtx.destination);
    src.start(now);src.stop(now+dur);
  }catch(e){}
}
const SFX = {
  dash(){ playTone({type:'sine',freq:300,freq2:900,duration:.18,vol:.22,attack:.005,decay:.17}); },
  hit(){ playNoise(.12,.3,'lowpass',800); playTone({type:'sawtooth',freq:150,freq2:60,duration:.15,vol:.18}); },
  kill(){ playTone({type:'square',freq:440,freq2:220,duration:.12,vol:.18}); playNoise(.06,.12,'highpass',2000); },
  bossKill(){ [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone({type:'sine',freq:f,duration:.2,vol:.32}),i*80)); },
  bossSpawn(){ playTone({type:'sawtooth',freq:80,freq2:40,duration:.6,vol:.38}); },
  powerup(){ playTone({type:'sine',freq:660,freq2:990,duration:.25,vol:.28}); },
  levelUp(){ [523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>playTone({type:'sine',freq:f,duration:.18,vol:.25}),i*70)); },
  gameOver(){ playTone({type:'sawtooth',freq:200,freq2:50,duration:.8,vol:.38}); },
  select(){ playTone({type:'sine',freq:880,duration:.08,vol:.22}); },
  equip(){ [440,660,880].forEach((f,i)=>setTimeout(()=>playTone({type:'sine',freq:f,duration:.12,vol:.2}),i*60)); },
  auraRoll(rarity){
    const freqs={Common:220,Uncommon:330,Rare:440,Epic:660,Legendary:880,Mythic:1320,SECRET:1760};
    const f=freqs[rarity]||440;
    playTone({type:'sine',freq:f,freq2:f*1.5,duration:.3,vol:.28});
    if(rarity==='Mythic'||rarity==='SECRET'){ setTimeout(()=>playTone({type:'sine',freq:f*2,duration:.4,vol:.22}),200); }
  }
};

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rnd(a,b){ return a+Math.random()*(b-a); }
function rndInt(a,b){ return Math.floor(rnd(a,b+.999)); }
function clamp(v,lo,hi){ return Math.max(lo,Math.min(hi,v)); }
function lerp(a,b,t){ return a+(b-a)*t; }
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function normalize(dx,dy){ const d=Math.hypot(dx,dy)||1; return {x:dx/d,y:dy/d}; }

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys = {};
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='KeyP'){ e.preventDefault(); togglePause(); }
  if(e.code==='Space'){ e.preventDefault(); triggerDash(); }
  if(e.code==='Escape') togglePause();
});
window.addEventListener('keyup',e=>{ keys[e.code]=false; });
const input = {
  joyX:0, joyY:0, dashPressed:false,
  get moveX(){ let x=0; if(keys['ArrowLeft']||keys['KeyA']) x-=1; if(keys['ArrowRight']||keys['KeyD']) x+=1; return clamp(x+this.joyX,-1,1); },
  get moveY(){ let y=0; if(keys['ArrowUp']||keys['KeyW']) y-=1; if(keys['ArrowDown']||keys['KeyS']) y+=1; return clamp(y+this.joyY,-1,1); }
};
function triggerDash(){ if(running&&!paused&&!gameOver) input.dashPressed=true; }

// Joystick
const joystickZone=document.getElementById('joystickZone');
const joystickKnob=document.getElementById('joystickKnob');
let joyId=null,joyOriginX=70,joyOriginY=70;
const JOY_R=46,JOY_C=70;
joystickZone.addEventListener('touchstart',e=>{
  e.preventDefault(); const t=e.changedTouches[0]; joyId=t.identifier;
  const r=joystickZone.getBoundingClientRect(); joyOriginX=t.clientX-r.left; joyOriginY=t.clientY-r.top;
},{passive:false});
joystickZone.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(let t of e.changedTouches){ if(t.identifier!==joyId) continue;
    const r=joystickZone.getBoundingClientRect();
    let dx=(t.clientX-r.left)-joyOriginX, dy=(t.clientY-r.top)-joyOriginY;
    const d=Math.hypot(dx,dy); if(d>JOY_R){dx=dx/d*JOY_R;dy=dy/d*JOY_R;}
    input.joyX=dx/JOY_R; input.joyY=dy/JOY_R;
    joystickKnob.style.left=(joyOriginX+dx-25)+'px'; joystickKnob.style.top=(joyOriginY+dy-25)+'px';
  }
},{passive:false});
const resetJoy=e=>{
  for(let t of e.changedTouches){ if(t.identifier!==joyId) continue;
    joyId=null; input.joyX=0; input.joyY=0;
    joystickKnob.style.left=(JOY_C-25)+'px'; joystickKnob.style.top=(JOY_C-25)+'px';
  }
};
joystickZone.addEventListener('touchend',resetJoy);
joystickZone.addEventListener('touchcancel',resetJoy);
document.getElementById('dashBtn').addEventListener('touchstart',e=>{e.preventDefault();triggerDash();},{passive:false});
document.getElementById('pauseBtn').addEventListener('click',togglePause);
document.getElementById('restartBtn').addEventListener('click',()=>{ensureAudio();SFX.select();startGame();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AURA DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AURAS = [
  // COMMON
  {name:"Ember",    emoji:"ğŸ”¥",rarity:"Common",chance:600,color:"#ff6b35",glow:"rgba(255,107,53,.4)", power:"Nothing specialâ€¦ yet.", evoAt:50},
  {name:"Frost",    emoji:"â„ï¸", rarity:"Common",chance:560,color:"#7ef7ff",glow:"rgba(126,247,255,.4)",power:"+1% luck on cold rolls.",evoAt:50},
  {name:"Storm",    emoji:"âš¡", rarity:"Common",chance:520,color:"#ffe44d",glow:"rgba(255,228,77,.4)", power:"+2% luck bonus.",evoAt:50},
  {name:"Earth",    emoji:"ğŸŒ¿",rarity:"Common",chance:500,color:"#7fff6b",glow:"rgba(127,255,107,.4)",power:"Steady ground beneath you.",evoAt:50},
  {name:"Shadow",   emoji:"ğŸŒ‘",rarity:"Common",chance:480,color:"#9b8fbf",glow:"rgba(155,143,191,.3)",power:"Hidden in darkness.",evoAt:50},
  {name:"Mud",      emoji:"ğŸŸ¤",rarity:"Common",chance:450,color:"#a0522d",glow:"rgba(160,82,45,.35)", power:"Earthy and grounded.",evoAt:50},
  {name:"Pebble",   emoji:"ğŸª¨",rarity:"Common",chance:420,color:"#b0b0b0",glow:"rgba(176,176,176,.3)",power:"Unbreakable resolve.",evoAt:50},
  {name:"Breeze",   emoji:"ğŸ’¨",rarity:"Common",chance:400,color:"#c8f7ff",glow:"rgba(200,247,255,.3)",power:"Swift and fleeting.",evoAt:50},
  {name:"Smoke",    emoji:"ğŸ’­",rarity:"Common",chance:380,color:"#9a9aaa",glow:"rgba(154,154,170,.3)",power:"Fades into the air.",evoAt:50},
  {name:"Spark",    emoji:"âœ¨",rarity:"Common",chance:360,color:"#ffeb99",glow:"rgba(255,235,153,.35)",power:"A tiny flicker of power.",evoAt:50},
  // UNCOMMON
  {name:"Ocean",    emoji:"ğŸŒŠ",rarity:"Uncommon",chance:320,color:"#4dc8ff",glow:"rgba(77,200,255,.5)",  power:"Tidal force â€” +3% luck.",evoAt:40},
  {name:"Lava",     emoji:"ğŸŒ‹",rarity:"Uncommon",chance:290,color:"#ff4d00",glow:"rgba(255,77,0,.5)",    power:"Burns brighter every roll.",evoAt:40},
  {name:"Wind",     emoji:"ğŸŒ€",rarity:"Uncommon",chance:270,color:"#b8ffed",glow:"rgba(184,255,237,.4)", power:"Whirlwind luck boost.",evoAt:40},
  {name:"Poison",   emoji:"â˜ ï¸", rarity:"Uncommon",chance:250,color:"#aaff00",glow:"rgba(170,255,0,.5)",   power:"Corrosive chance.",evoAt:40},
  {name:"Magnet",   emoji:"ğŸ§²",rarity:"Uncommon",chance:230,color:"#ff4488",glow:"rgba(255,68,136,.45)", power:"Attracts rare auras.",evoAt:40},
  {name:"Lightning",emoji:"ğŸŒ©ï¸",rarity:"Uncommon",chance:210,color:"#fff176",glow:"rgba(255,241,118,.5)", power:"Strikes of fortune.",evoAt:40},
  {name:"Thorn",    emoji:"ğŸŒ¹",rarity:"Uncommon",chance:190,color:"#cc2244",glow:"rgba(204,34,68,.5)",   power:"Beautiful and dangerous.",evoAt:40},
  {name:"Ice Blade",emoji:"ğŸ—¡ï¸", rarity:"Uncommon",chance:170,color:"#aaeeff",glow:"rgba(170,238,255,.45)",power:"Sharp as winter's edge.",evoAt:40},
  // RARE
  {name:"Crystal",  emoji:"ğŸ’",rarity:"Rare",chance:140,color:"#a8f0ff",glow:"rgba(168,240,255,.6)",power:"+5% luck. Crystalline purity.",evoAt:30},
  {name:"Blood Moon",emoji:"ğŸ©¸",rarity:"Rare",chance:120,color:"#cc0033",glow:"rgba(204,0,51,.6)",  power:"Lunar power surges.",evoAt:30},
  {name:"Void",     emoji:"ğŸ•³ï¸", rarity:"Rare",chance:110,color:"#5c00cc",glow:"rgba(92,0,204,.6)",  power:"+3% Mythic rate.",evoAt:30},
  {name:"Neon",     emoji:"ğŸ’¡",rarity:"Rare",chance:100,color:"#39ff14",glow:"rgba(57,255,20,.6)",  power:"Blinding clarity.",evoAt:30},
  {name:"Glacier",  emoji:"ğŸ”ï¸", rarity:"Rare",chance:90, color:"#9ae8ff",glow:"rgba(154,232,255,.6)",power:"Ancient and unmoved.",evoAt:30},
  {name:"Plague",   emoji:"ğŸ§Ÿ",rarity:"Rare",chance:80, color:"#55aa00",glow:"rgba(85,170,0,.6)",  power:"Spreads fortune.",evoAt:30},
  {name:"Soul",     emoji:"ğŸ‘»",rarity:"Rare",chance:70, color:"#ddbbff",glow:"rgba(221,187,255,.6)",power:"Echoes of the past.",evoAt:30},
  {name:"Magma Core",emoji:"ğŸ«€",rarity:"Rare",chance:65,color:"#ff5500",glow:"rgba(255,85,0,.6)",   power:"Fiery heart, steady rolls.",evoAt:30},
  {name:"Time",     emoji:"â³",rarity:"Rare",chance:55, color:"#ccaa77",glow:"rgba(204,170,119,.6)",power:"Time bends to your will.",evoAt:30},
  // EPIC
  {name:"Aurora",   emoji:"ğŸŒŒ",rarity:"Epic",chance:55,color:"#ff80ff",glow:"rgba(255,128,255,.7)",power:"+5% Legendary rate.",evoAt:20},
  {name:"Inferno",  emoji:"ğŸ”±",rarity:"Epic",chance:48,color:"#ff5500",glow:"rgba(255,85,0,.7)",   power:"Blazing path to Legendary.",evoAt:20},
  {name:"Galaxy",   emoji:"ğŸŒ ",rarity:"Epic",chance:42,color:"#c084fc",glow:"rgba(192,132,252,.7)",power:"+5% Mythic rate.",evoAt:20},
  {name:"Omega Storm",emoji:"ğŸŒªï¸",rarity:"Epic",chance:36,color:"#38bdf8",glow:"rgba(56,189,248,.7)", power:"+8% luck overall.",evoAt:20},
  {name:"Dusk",     emoji:"ğŸŒ…",rarity:"Epic",chance:30,color:"#ff9955",glow:"rgba(255,153,85,.7)", power:"Between worlds of power.",evoAt:20},
  {name:"Singularity",emoji:"ğŸŒ€",rarity:"Epic",chance:26,color:"#9900ff",glow:"rgba(153,0,255,.7)", power:"Collapses probability.",evoAt:20},
  {name:"Prism",    emoji:"ğŸ”­",rarity:"Epic",chance:22,color:"#ffaaff",glow:"rgba(255,170,255,.7)",power:"Splits luck into all colors.",evoAt:20},
  {name:"Dark Matter",emoji:"ğŸ«§",rarity:"Epic",chance:18,color:"#220066",glow:"rgba(34,0,102,.7)", power:"Unseen force of power.",evoAt:20},
  // LEGENDARY
  {name:"Divine",   emoji:"ğŸ‘¼",rarity:"Legendary",chance:15,color:"#ffd700",glow:"rgba(255,215,0,.9)",  power:"+10% Legendary drop rate.",evoAt:10},
  {name:"Abyssal",  emoji:"ğŸ‘ï¸", rarity:"Legendary",chance:12,color:"#ff00aa",glow:"rgba(255,0,170,.9)",  power:"+8% Mythic rate.",evoAt:10},
  {name:"Celestial",emoji:"â˜€ï¸", rarity:"Legendary",chance:10,color:"#fffbe8",glow:"rgba(255,251,232,.9)",power:"Solar power amplified.",evoAt:10},
  {name:"Phantom King",emoji:"ğŸ‘‘",rarity:"Legendary",chance:9,color:"#ddaaff",glow:"rgba(221,170,255,.9)",power:"Ruler of forgotten realms.",evoAt:10},
  {name:"Titan",    emoji:"âš“",rarity:"Legendary",chance:8, color:"#aaaaff",glow:"rgba(170,170,255,.9)",power:"Immovable. Unstoppable.",evoAt:10},
  {name:"Nebula",   emoji:"ğŸŒ¸",rarity:"Legendary",chance:7, color:"#ffaacc",glow:"rgba(255,170,204,.9)",power:"Born from dying stars.",evoAt:10},
  // MYTHIC
  {name:"Omni",       emoji:"ğŸŒˆ",rarity:"Mythic",chance:5,color:"rainbow",glow:"rgba(255,255,255,.9)",power:"All aura powers combined.",evoAt:5},
  {name:"The Eternal",emoji:"â™¾ï¸", rarity:"Mythic",chance:4,color:"rainbow",glow:"rgba(255,255,255,.9)",power:"Beyond time and space.",evoAt:5},
  {name:"Void God",   emoji:"ğŸ•¸ï¸",rarity:"Mythic",chance:3,color:"rainbow",glow:"rgba(255,255,255,.9)",power:"Consumes all other auras.",evoAt:5},
  {name:"Genesis",    emoji:"ğŸ’«",rarity:"Mythic",chance:2,color:"rainbow",glow:"rgba(255,255,255,.9)",power:"The first light. The origin.",evoAt:5},
  // EVENT
  {name:"Jack-o-Flame",emoji:"ğŸƒ",rarity:"Epic",chance:15,color:"#ff6600",glow:"rgba(255,102,0,.7)",power:"Halloween haunts your luck.",evoAt:20,event:"Halloween"},
  {name:"Frostmas",   emoji:"ğŸ„",rarity:"Rare",chance:20,color:"#00cc44",glow:"rgba(0,204,68,.6)",  power:"Holiday cheer = more luck.",evoAt:30,event:"Winter"},
  {name:"Solar Eclipse",emoji:"ğŸŒ—",rarity:"Legendary",chance:4,color:"#222200",glow:"rgba(200,200,0,.9)",power:"Eclipse drives out bad luck.",evoAt:10,event:"Eclipse"},
];
const SECRET_AURA = {name:"Ì·Ì¢Ì›EÌ¸ÍRÌ¸Í RÌ´Ì¡OÌ·ÍRÌ¸Ì¢",emoji:"âš ï¸",rarity:"SECRET",chance:1,color:"#00ff00",glow:"rgba(0,255,0,.9)",power:"You were not supposed to find this.",evoAt:1,secret:true};

// â”€â”€ AURA GAME BUFFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each aura has specific combat buffs applied when equipped
const AURA_BUFFS = {
  // Common â€” small utility buffs
  "Ember":     { desc:"+10% dash damage",       dashDamageMult:1.1 },
  "Frost":     { desc:"Enemies 5% slower",      enemySlowMult:.95 },
  "Storm":     { desc:"+5% movement speed",     speedMult:1.05 },
  "Earth":     { desc:"+8 max HP",              bonusHp:8 },
  "Shadow":    { desc:"Dash cooldown -10%",     dashCdMult:.9 },
  "Mud":       { desc:"+5 max HP",              bonusHp:5 },
  "Pebble":    { desc:"+5% score multiplier",   scoreMult:1.05 },
  "Breeze":    { desc:"+8% movement speed",     speedMult:1.08 },
  "Smoke":     { desc:"50% ghost dmg on dash",  ghostDash:true },
  "Spark":     { desc:"+1 combo on kill",       bonusCombo:1 },
  // Uncommon
  "Ocean":     { desc:"+3% all stats",          speedMult:1.03, dashDamageMult:1.03, scoreMult:1.03 },
  "Lava":      { desc:"+15% dash damage",       dashDamageMult:1.15 },
  "Wind":      { desc:"+12% movement speed",    speedMult:1.12 },
  "Poison":    { desc:"Enemies 10% slower",     enemySlowMult:.9 },
  "Magnet":    { desc:"Powerup pull +50%",      puPullMult:1.5 },
  "Lightning": { desc:"+10% combo multiplier",  comboMult:1.1 },
  "Thorn":     { desc:"Reflect 10% damage",     reflectDmg:.1 },
  "Ice Blade": { desc:"+15% dash damage, -5% cd",dashDamageMult:1.15, dashCdMult:.95 },
  // Rare
  "Crystal":   { desc:"+8% score, +5 HP",      scoreMult:1.08, bonusHp:5 },
  "Blood Moon": { desc:"Kills restore 2HP",      killHeal:2 },
  "Void":      { desc:"+20% dash damage",       dashDamageMult:1.2 },
  "Neon":      { desc:"Bigger dash hitbox +4",  dashRadius:4 },
  "Glacier":   { desc:"+15 max HP",             bonusHp:15 },
  "Plague":    { desc:"+15% combo mult",        comboMult:1.15 },
  "Soul":      { desc:"Extra 3s invincibility after hit", extraInvTime:.3 },
  "Magma Core":{ desc:"+20% dash dmg, -10% cd",dashDamageMult:1.2, dashCdMult:.9 },
  "Time":      { desc:"Dash duration +25%",     dashDurMult:1.25 },
  // Epic
  "Aurora":    { desc:"+10% score, kills restore 1HP", scoreMult:1.1, killHeal:1 },
  "Inferno":   { desc:"+30% dash damage",       dashDamageMult:1.3 },
  "Galaxy":    { desc:"+20% all multipliers",   scoreMult:1.2, dashDamageMult:1.2, speedMult:1.1 },
  "Omega Storm":{ desc:"Enemies 15% slower, +10% spd", enemySlowMult:.85, speedMult:1.1 },
  "Dusk":      { desc:"+20% score, combo never resets on damage", comboProtect:true, scoreMult:1.2 },
  "Singularity":{ desc:"Double combo ramp speed", comboMult:1.3 },
  "Prism":     { desc:"All powerup durations +30%", puDurMult:1.3 },
  "Dark Matter":{ desc:"+30% dash radius & dmg", dashRadius:6, dashDamageMult:1.3 },
  // Legendary
  "Divine":    { desc:"+15 HP, kills +1% permspd (max30)", killSpeedStacks:true, bonusHp:15 },
  "Abyssal":   { desc:"Life steal: 5% of dash dmg", lifeSteal:.05 },
  "Celestial": { desc:"Double score, +10% speed", scoreMult:2, speedMult:1.1 },
  "Phantom King":{ desc:"Phasing dash â€” no collision start", phantomDash:true, dashDamageMult:1.25 },
  "Titan":     { desc:"+30 max HP, damage -20%", bonusHp:30, damageTakenMult:.8 },
  "Nebula":    { desc:"Leave damage trail while dashing", dashTrailDmg:true, dashDamageMult:1.1 },
  // Mythic
  "Omni":      { desc:"ALL buffs at 50% strength!", omni:true },
  "The Eternal":{ desc:"Infinite combo, +50% score",comboProtect:true,scoreMult:1.5,comboMult:1.5 },
  "Void God":  { desc:"Auto-slow time every 10s", autoTimeSlow:true, scoreMult:1.3 },
  "Genesis":   { desc:"Start with shield, 2Ã— powerup drops", startShield:true, puDropMult:2 },
  // Event
  "Jack-o-Flame":{ desc:"+20% dash dmg, eerie trail", dashDamageMult:1.2, dashTrailDmg:true },
  "Frostmas":  { desc:"Enemies 20% slower, lucky drops", enemySlowMult:.8, puDropMult:1.5 },
  "Solar Eclipse":{ desc:"Eclipse aura â€” +40% all", scoreMult:1.4, dashDamageMult:1.4, speedMult:1.15 },
  // Secret
  "Ì·Ì¢Ì›EÌ¸ÍRÌ¸Í RÌ´Ì¡OÌ·ÍRÌ¸Ì¢": { desc:"EVERYTHING Ã— 2 (lol)", scoreMult:2, dashDamageMult:2, speedMult:1.5, bonusHp:50, dashRadius:10 },
};
// Fusions still get basic buffs
const FUSIONS_EXTRA_BUFFS = {
  "Blazing Ember":  { desc:"+25% dash dmg, fire trail", dashDamageMult:1.25, dashTrailDmg:true },
  "Tempest Core":   { desc:"Enemies 25% slower, +15% spd", enemySlowMult:.75, speedMult:1.15 },
  "Ocean Storm":    { desc:"+20% score, huge dash radius", scoreMult:1.2, dashRadius:8 },
  "Void Crystal":   { desc:"+50% dash dmg, 30HP", dashDamageMult:1.5, bonusHp:30 },
  "Solar Titan":    { desc:"God mode: -30% dmg, +60% score", damageTakenMult:.7, scoreMult:1.6, bonusHp:40 },
};

function getAuraBuff(aura){
  if(!aura) return null;
  const b = AURA_BUFFS[aura.name] || FUSIONS_EXTRA_BUFFS[aura.name] || null;
  if(!b) return null;
  // Handle Omni â€” combines a sample of all buffs
  if(b.omni){
    return {
      desc:"ALL buffs at 50% strength!",
      speedMult:1.12, dashDamageMult:1.25, scoreMult:1.25,
      enemySlowMult:.92, bonusHp:15, comboMult:1.15,
      dashCdMult:.92, killHeal:1, puDurMult:1.2
    };
  }
  return b;
}

// â”€â”€ DIFFICULTY SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIFFICULTIES = [
  { id:"easy",       name:"Easy",       emoji:"ğŸŒ±", color:"#4dff91",
    enemySpeedMult:.75, enemyHpMult:.7, spawnRateMult:.7,
    playerDmgMult:.7,   scoreMult:.8,   label:"EASY",
    desc:"Ã—0.8 score" },
  { id:"medium",     name:"Medium",     emoji:"âš”ï¸", color:"#00d4ff",
    enemySpeedMult:1,   enemyHpMult:1,  spawnRateMult:1,
    playerDmgMult:1,    scoreMult:1,    label:"MEDIUM",
    desc:"Ã—1.0 score" },
  { id:"hard",       name:"Hard",       emoji:"ğŸ’€", color:"#ffd700",
    enemySpeedMult:1.3, enemyHpMult:1.4, spawnRateMult:1.3,
    playerDmgMult:1.3,  scoreMult:1.5,   label:"HARD",
    desc:"Ã—1.5 score" },
  { id:"hell",       name:"Hell",       emoji:"ğŸ”¥", color:"#ff6b35",
    enemySpeedMult:1.65,enemyHpMult:1.9, spawnRateMult:1.7,
    playerDmgMult:1.7,  scoreMult:2.5,   label:"HELL",
    desc:"Ã—2.5 score" },
  { id:"impossible", name:"Impossible", emoji:"â˜ ï¸", color:"#ff0066",
    enemySpeedMult:2.2, enemyHpMult:2.8, spawnRateMult:2.5,
    playerDmgMult:2.5,  scoreMult:5,     label:"IMPOSSIBLE",
    desc:"Ã—5.0 score" },
];
let selectedDiff = 1; // index into DIFFICULTIES (default medium)

// â”€â”€ FUSION RECIPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FUSIONS = [
  {id:"blazing_ember", needs:{"Ember":5},             result:"ğŸ”¥ğŸ”¥ Blazing Ember",  reward:{name:"Blazing Ember", emoji:"ğŸ”¥ğŸ”¥",rarity:"Rare",chance:0,color:"#ff3300",glow:"rgba(255,51,0,.7)",  power:"Born of five flames.",evoAt:99},  essence:50},
  {id:"tempest_core",  needs:{"Frost":3,"Storm":3},   result:"ğŸŒ©ï¸â„ï¸ Tempest Core",   reward:{name:"Tempest Core",  emoji:"ğŸŒ©ï¸â„ï¸",rarity:"Epic",chance:0,color:"#88aaff",glow:"rgba(136,170,255,.7)",power:"Storm and frost united.",evoAt:99},essence:120},
  {id:"ocean_storm",   needs:{"Ocean":3,"Lightning":3},result:"â›ˆï¸ Ocean Storm",      reward:{name:"Ocean Storm",   emoji:"â›ˆï¸",  rarity:"Epic",chance:0,color:"#0066ff",glow:"rgba(0,102,255,.7)",  power:"Tidal lightning strike.",evoAt:99},essence:150},
  {id:"void_crystal",  needs:{"Void":2,"Crystal":2},  result:"ğŸ’  Void Crystal",     reward:{name:"Void Crystal",  emoji:"ğŸ’ ",  rarity:"Legendary",chance:0,color:"#8800ff",glow:"rgba(136,0,255,.9)",power:"Crystal clarity meets void.",evoAt:99},essence:300},
  {id:"solar_titan",   needs:{"Celestial":1,"Titan":1},result:"ğŸŒâš“ Solar Titan",    reward:{name:"Solar Titan",   emoji:"ğŸŒâš“",rarity:"Legendary",chance:0,color:"#ffcc00",glow:"rgba(255,204,0,.9)",power:"Unstoppable celestial force.",evoAt:99},essence:500},
];

// â”€â”€ ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACHIEVEMENTS = [
  // Rolling achievements
  {id:"first_roll",   name:"First Step",     icon:"ğŸ¯",desc:"Roll for the first time",          cat:"roll",  check:s=>s.rolls>=1,                    reward:"+5 Essence",essence:5},
  {id:"roll10",       name:"Getting Warmed", icon:"ğŸ”¥",desc:"Roll 10 times",                    cat:"roll",  check:s=>s.rolls>=10,                   reward:"+10 Essence",essence:10},
  {id:"roll100",      name:"Dedicated",      icon:"ğŸ’¯",desc:"Roll 100 times",                   cat:"roll",  check:s=>s.rolls>=100,                  reward:"+50 Essence",essence:50},
  {id:"roll1000",     name:"Obsessed",       icon:"âš¡",desc:"Roll 1,000 times",                 cat:"roll",  check:s=>s.rolls>=1000,                 reward:"+200 Essence",essence:200},
  {id:"first_rare",   name:"Rare Find",      icon:"ğŸ’",desc:"Roll your first Rare",             cat:"roll",  check:s=>(s.rarityCount.Rare||0)>=1,    reward:"+20 Essence",essence:20},
  {id:"first_epic",   name:"Epic Moment",    icon:"ğŸŒŒ",desc:"Roll your first Epic",             cat:"roll",  check:s=>(s.rarityCount.Epic||0)>=1,    reward:"+80 Essence",essence:80},
  {id:"first_legendary",name:"Legendary!",  icon:"â­",desc:"Roll your first Legendary",        cat:"roll",  check:s=>(s.rarityCount.Legendary||0)>=1,reward:"Title unlocked",titleId:"the_lucky"},
  {id:"first_mythic", name:"MYTHIC!!",       icon:"ğŸŒˆ",desc:"Roll your first Mythic",           cat:"roll",  check:s=>(s.rarityCount.Mythic||0)>=1,  reward:"Title unlocked",titleId:"myth_seeker"},
  {id:"find_secret",  name:"???",            icon:"â“",desc:"Find the secret aura",             cat:"roll",  check:s=>s.collection[SECRET_AURA.name]>0,reward:"Title unlocked",titleId:"void_walker"},
  {id:"collect10",    name:"Collector",      icon:"ğŸ“–",desc:"Collect 10 unique auras",          cat:"roll",  check:s=>Object.keys(s.collection).length>=10,reward:"+30 Essence",essence:30},
  {id:"collect30",    name:"Archivist",      icon:"ğŸ“š",desc:"Collect 30 unique auras",          cat:"roll",  check:s=>Object.keys(s.collection).length>=30,reward:"+100 Essence",essence:100},
  {id:"first_fusion", name:"Alchemist",      icon:"âš—ï¸",desc:"Complete your first fusion",       cat:"roll",  check:s=>s.fusions>=1,                  reward:"Title unlocked",titleId:"alchemist"},
  {id:"evolution",    name:"Evolved",        icon:"ğŸ¦‹",desc:"Evolve your first aura",           cat:"roll",  check:s=>s.evolutions>=1,               reward:"+150 Essence",essence:150},
  {id:"prestige1",    name:"Prestige I",     icon:"ğŸ†",desc:"Prestige for the first time",      cat:"roll",  check:s=>s.prestige>=1,                 reward:"Title unlocked",titleId:"prestiged"},
  {id:"luck_maxed",   name:"Max Luck",       icon:"ğŸ€",desc:"Fill the luck meter completely",   cat:"roll",  check:s=>s.luckFilled>=1,               reward:"Title unlocked",titleId:"the_lucky"},
  // Combat achievements
  {id:"first_kill",   name:"First Blood",    icon:"ğŸ©¸",desc:"Kill your first enemy",            cat:"combat",check:s=>s.totalKills>=1,              reward:"+5 Essence",essence:5},
  {id:"kill50",       name:"Hunter",         icon:"ğŸ—¡ï¸", desc:"Kill 50 enemies total",           cat:"combat",check:s=>s.totalKills>=50,             reward:"+30 Essence",essence:30},
  {id:"kill500",      name:"Slayer",         icon:"âš”ï¸", desc:"Kill 500 enemies total",          cat:"combat",check:s=>s.totalKills>=500,            reward:"+100 Essence",essence:100},
  {id:"kill5000",     name:"God of War",     icon:"ğŸ”±",desc:"Kill 5000 enemies total",          cat:"combat",check:s=>s.totalKills>=5000,           reward:"+500 Essence",essence:500},
  {id:"first_boss",   name:"Boss Slayer",    icon:"ğŸ‘¹",desc:"Kill your first boss",             cat:"combat",check:s=>s.bossKills>=1,               reward:"+80 Essence",essence:80},
  {id:"boss10",       name:"Boss Hunter",    icon:"ğŸ‰",desc:"Kill 10 bosses",                   cat:"combat",check:s=>s.bossKills>=10,              reward:"+300 Essence",essence:300},
  {id:"combo10",      name:"Combo Artist",   icon:"ğŸ”¥",desc:"Reach a 10Ã— combo",               cat:"combat",check:s=>s.maxComboCombat>=10,         reward:"+25 Essence",essence:25},
  {id:"combo50",      name:"Unstoppable",    icon:"ğŸ’¥",desc:"Reach a 50Ã— combo",               cat:"combat",check:s=>s.maxComboCombat>=50,         reward:"+100 Essence",essence:100},
  {id:"combo100",     name:"Transcendent",   icon:"ğŸŒŒ",desc:"Reach a 100Ã— combo",              cat:"combat",check:s=>s.maxComboCombat>=100,        reward:"Title unlocked",titleId:"the_eternal"},
  {id:"reach_level5", name:"Veteran",        icon:"ğŸ–ï¸", desc:"Reach level 5 in one run",        cat:"combat",check:s=>s.maxLevel>=5,               reward:"+20 Essence",essence:20},
  {id:"reach_level15",name:"Elite",          icon:"ğŸ¥‡",desc:"Reach level 15 in one run",       cat:"combat",check:s=>s.maxLevel>=15,              reward:"+100 Essence",essence:100},
  {id:"score10k",     name:"High Scorer",    icon:"ğŸ¯",desc:"Score 10,000 in one run",          cat:"combat",check:s=>s.bestScore>=10000,           reward:"+50 Essence",essence:50},
  {id:"score100k",    name:"Legend",         icon:"ğŸ‘‘",desc:"Score 100,000 in one run",         cat:"combat",check:s=>s.bestScore>=100000,          reward:"+250 Essence",essence:250},
  {id:"beat_hard",    name:"Hardened",       icon:"ğŸ’€",desc:"Survive to level 5 on Hard+",     cat:"combat",check:s=>s.diffBeaten.hard||false,      reward:"+200 Essence",essence:200},
  {id:"beat_hell",    name:"Hell Survivor",  icon:"ğŸ”¥",desc:"Survive to level 5 on Hell+",     cat:"combat",check:s=>s.diffBeaten.hell||false,      reward:"+500 Essence",essence:500},
  {id:"beat_impossible",name:"Impossible!?",icon:"â˜ ï¸", desc:"Survive to level 5 on Impossible",cat:"combat",check:s=>s.diffBeaten.impossible||false, reward:"Title: Impossible\n+2000 Essence",essence:2000,titleId:"impossible_survivor"},
  {id:"equip_aura",   name:"Aura Warrior",   icon:"âœ¨",desc:"Play a game with an aura equipped",cat:"combat",check:s=>s.gamesWithAura>=1,           reward:"+15 Essence",essence:15},
  {id:"equip_mythic_play",name:"Mythic Power",icon:"ğŸŒˆ",desc:"Play with a Mythic aura equipped",cat:"combat",check:s=>s.gamesWithMythicAura>=1,    reward:"+300 Essence",essence:300},
  {id:"first_game",   name:"Arena Enters",   icon:"ğŸŸï¸", desc:"Play your first game",           cat:"combat",check:s=>s.gamesPlayed>=1,             reward:"+5 Essence",essence:5},
  {id:"games10",      name:"Regular",        icon:"ğŸ®",desc:"Play 10 games",                    cat:"combat",check:s=>s.gamesPlayed>=10,            reward:"+30 Essence",essence:30},
];

// â”€â”€ TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TITLES = [
  {id:"novice",     name:"The Novice",    color:"#b0b0c0"},
  {id:"the_lucky",  name:"The Lucky",     color:"#4dff91"},
  {id:"void_walker",name:"Void Walker",   color:"#5c00cc"},
  {id:"myth_seeker",name:"Myth Seeker",   color:"#ff80ff"},
  {id:"alchemist",  name:"The Alchemist", color:"#ffd700"},
  {id:"prestiged",  name:"The Prestige",  color:"#ff8c00"},
  {id:"the_eternal",name:"The Eternal",   color:"rainbow"},
  {id:"impossible_survivor",name:"IMPOSSIBLE",color:"#ff0066"},
  {id:"aura_master",name:"Aura Master",   color:"rainbow"},
];

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHOP_ITEMS = [
  {id:"luck_boost",   name:"Luck Boost",     emoji:"ğŸ€",desc:"2Ã— luck for 10 rolls",   cost:100, effect:"luckBoost"},
  {id:"rare_roll",    name:"Guaranteed Rare", emoji:"ğŸ’",desc:"Next roll is Rare+",     cost:200, effect:"guaranteeRare"},
  {id:"epic_roll",    name:"Guaranteed Epic", emoji:"ğŸŒŒ",desc:"Next roll is Epic+",     cost:600, effect:"guaranteeEpic"},
  {id:"bonus_roll",   name:"Bonus Roll",      emoji:"ğŸ²",desc:"Extra roll",             cost:80,  effect:"bonusRoll"},
  {id:"essence_x2",   name:"Essence 2Ã—",      emoji:"ğŸ’°",desc:"2Ã— essence for 20 rolls",cost:150, effect:"essenceX2"},
  {id:"luck_reset",   name:"Luck Max",        emoji:"ğŸŒŸ",desc:"Fill luck meter instantly",cost:300,effect:"maxLuck"},
];

const RARITY_COLORS = {
  Common:   {text:"#b0b0c0",bg:"rgba(180,180,200,.07)", border:"rgba(180,180,200,.25)"},
  Uncommon: {text:"#4dff91",bg:"rgba(77,255,145,.07)",  border:"rgba(77,255,145,.3)"},
  Rare:     {text:"#4dc8ff",bg:"rgba(77,200,255,.08)",  border:"rgba(77,200,255,.35)"},
  Epic:     {text:"#c084fc",bg:"rgba(192,132,252,.08)", border:"rgba(192,132,252,.45)"},
  Legendary:{text:"#ffd700",bg:"rgba(255,215,0,.08)",   border:"rgba(255,215,0,.55)"},
  Mythic:   {text:"#fff",   bg:"rgba(255,255,255,.05)", border:"rgba(255,255,255,.65)"},
  SECRET:   {text:"#00ff00",bg:"rgba(0,255,0,.05)",     border:"rgba(0,255,0,.6)"},
};
const RARITY_ORDER = ["Common","Uncommon","Rare","Epic","Legendary","Mythic","SECRET"];
function rarityRank(r){ return RARITY_ORDER.indexOf(r); }

// â”€â”€ PERSISTENT STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function defaultState(){
  return {
    rolls:0,essence:0,essenceEarned:0,prestige:0,
    collection:{},fusionCollection:{},evolutions:{},evolvedCount:0,fusions:0,
    rarityCount:{Common:0,Uncommon:0,Rare:0,Epic:0,Legendary:0,Mythic:0,SECRET:0},
    rarestName:null,history:[],achievements:{},unlockedTitles:[],activeTitle:null,
    luck:0,luckFilled:0,pityEpic:0,pityLeg:0,pityMyth:0,
    commonStreak:0,maxCommonStreak:0,sameRarityStreak:0,lastRarity:null,
    activeBonusRolls:0,activeBoosts:{},lastDaily:null,
    equippedAura:null,
    // Combat stats
    totalKills:0,bossKills:0,gamesPlayed:0,maxLevel:0,bestScore:0,
    maxComboCombat:0,gamesWithAura:0,gamesWithMythicAura:0,
    diffBeaten:{easy:false,medium:false,hard:false,hell:false,impossible:false},
    killSpeedBonus:0, // accumulates from Divine aura
  };
}
let state = defaultState();
try{ const s=localStorage.getItem("neonSurgeAuraV1"); if(s){ const p=JSON.parse(s); state=Object.assign(defaultState(),p); } }catch(e){}
function save(){ try{ localStorage.setItem("neonSurgeAuraV1",JSON.stringify(state)); }catch(e){} }

// â”€â”€ LOBBY UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDifficultyGrid(){
  const g=document.getElementById('diffGrid'); g.innerHTML='';
  DIFFICULTIES.forEach((d,i)=>{
    const div=document.createElement('div');
    div.className='diff-card'+(i===selectedDiff?' selected':'');
    div.style.setProperty('--dc',d.color);
    div.innerHTML=`<div class="diff-emoji">${d.emoji}</div><div class="diff-name">${d.name}</div><div class="diff-multiplier">${d.desc}</div>`;
    div.onclick=()=>{ selectedDiff=i; buildDifficultyGrid(); SFX.select(); };
    g.appendChild(div);
  });
}

function buildCollection(){
  const grid=document.getElementById('collectionGrid'); grid.innerHTML='';
  const allAuras=[...AURAS,SECRET_AURA];
  document.getElementById('collTotal').textContent=allAuras.length;
  allAuras.forEach(a=>{
    const div=document.createElement('div');
    const cnt=(state.collection[a.name]||0)+(state.fusionCollection?.[a.name]||0);
    const unlocked=cnt>0;
    const evolved=state.evolutions?.[a.name];
    const isEquipped=state.equippedAura===a.name;
    div.className='col-item'+(unlocked?' unlocked':'')+(evolved?' evolved':'')+(isEquipped?' equip-active':'');
    div.id=`col-${a.name.replace(/[^a-zA-Z0-9]/g,'_')}`;
    if(unlocked){
      const ac=a.color==='rainbow'?'#fff':a.color;
      div.style.setProperty('--ac',ac);
      div.style.setProperty('--ag',a.glow||'transparent');
    }
    const sec=a.secret&&!unlocked;
    div.innerHTML=`<div class="col-emoji">${sec?'â“':a.emoji}${evolved?' ğŸ¦‹':''}</div><div class="col-cnt">Ã—${cnt}</div><div class="col-name">${sec?'???':a.name}</div>`;
    if(unlocked){
      div.title=`${a.name} â€” Tap to equip`;
      div.onclick=()=>{ equipAuraByName(a.name); };
      div.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();equipAuraByName(a.name);},{passive:false});
    }
    grid.appendChild(div);
  });
  // Fusion auras in collection
  FUSIONS.forEach(f=>{
    if((state.fusionCollection?.[f.reward.name]||0)>0){
      // already shown via fusionCollection merged cnt â€” skip duplicate
    }
  });
}

function updateCollection(){
  const allAuras=[...AURAS,SECRET_AURA];
  let total=0;
  allAuras.forEach(a=>{
    const div=document.getElementById(`col-${a.name.replace(/[^a-zA-Z0-9]/g,'_')}`);
    if(!div) return;
    const cnt=(state.collection[a.name]||0)+(state.fusionCollection?.[a.name]||0);
    if(cnt>0){
      total++;
      div.classList.add('unlocked');
      if(state.evolutions?.[a.name]) div.classList.add('evolved');
      div.style.setProperty('--ac',a.color==='rainbow'?'#fff':a.color);
      div.style.setProperty('--ag',a.glow||'transparent');
      div.querySelector('.col-emoji').textContent=a.emoji+(state.evolutions?.[a.name]?' ğŸ¦‹':'');
    }
    div.classList.toggle('equip-active',state.equippedAura===a.name);
    const cntEl=div.querySelector('.col-cnt'); if(cntEl) cntEl.textContent=`Ã—${cnt}`;
  });
  document.getElementById('collCount').textContent=total;
}

function equipAuraByName(name){
  const aura=[...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)].find(a=>a.name===name);
  if(!aura) return;
  if(state.equippedAura===name){
    unequipAura(); return;
  }
  state.equippedAura=name;
  save(); updateEquippedPanel(); updateCollection();
  SFX.equip();
  showToast(`ğŸ›¡ Equipped: ${aura.emoji} ${aura.name}!`);
  // Show result card too
  showRolledAuraResult(aura,false,false);
}

function equipLastRolled(){
  if(!lastRolledAura) return;
  equipAuraByName(lastRolledAura.name);
}

function unequipAura(){
  state.equippedAura=null;
  save(); updateEquippedPanel(); updateCollection();
  showToast("ğŸ”® Aura unequipped.");
}

function updateEquippedPanel(){
  const name=state.equippedAura;
  const allAuras=[...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)];
  const aura=name?allAuras.find(a=>a.name===name):null;
  const buff=aura?getAuraBuff(aura):null;
  const col=aura?RARITY_COLORS[aura.rarity]||RARITY_COLORS.Common:null;

  document.getElementById('eqEmoji').textContent=aura?aura.emoji:'ğŸ”®';
  document.getElementById('eqName').textContent=aura?aura.name:'No Aura Equipped';
  document.getElementById('eqRarity').textContent=aura?aura.rarity:'â€”';
  if(col) document.getElementById('eqName').style.color=col.text;
  else document.getElementById('eqName').style.color='#c8a8ff';
  document.getElementById('eqBuff').innerHTML=buff?`<span style="color:#4dff91">âš¡ ${buff.desc}</span>`:'<span class="eq-none">Roll and equip an aura to gain buffs in battle!</span>';
  document.getElementById('unequipBtn').style.display=aura?'block':'none';

  // Update HUD equipped display
  const hudAura=document.getElementById('equippedAuraHUD');
  const hudEmoji=document.getElementById('equippedAuraHUD')?.querySelector('.ea-emoji');
  const hudName=document.getElementById('equippedAuraHUD')?.querySelector('.ea-name');
  const hudBuff=document.getElementById('equippedAuraHUD')?.querySelector('.ea-buff');
  if(hudEmoji) hudEmoji.textContent=aura?aura.emoji:'ğŸ”®';
  if(hudName){ hudName.textContent=aura?aura.name:'No Aura'; hudName.style.setProperty('--ea-col',col?col.text:'#c8a8ff'); }
  if(hudBuff) hudBuff.textContent=buff?buff.desc:'â€”';
}

function updateLobbyUI(){
  // Stats
  document.getElementById('statRolls').textContent=state.rolls.toLocaleString();
  const rarestAura=[...AURAS,SECRET_AURA].find(a=>a.name===state.rarestName);
  document.getElementById('statRarest').textContent=rarestAura?rarestAura.emoji:'â€”';
  const collected=Object.keys(state.collection).filter(n=>state.collection[n]>0).length;
  document.getElementById('statCollected').textContent=collected;
  document.getElementById('statGamesPlayed').textContent=(state.gamesPlayed||0).toLocaleString();
  document.getElementById('statPrestige').textContent=state.prestige||0;
  document.getElementById('essenceVal').textContent=(state.essence||0).toLocaleString();
  document.getElementById('shopEssenceVal').textContent=(state.essence||0).toLocaleString();

  // Meters
  document.getElementById('luckFill').style.width=(state.luck||0)+'%';
  document.getElementById('luckVal').textContent=Math.round(state.luck||0)+'%';
  document.getElementById('pityEpicFill').style.width=Math.min(100,((state.pityEpic||0)/50)*100)+'%';
  document.getElementById('pityEpicVal').textContent=state.pityEpic||0;
  document.getElementById('pityLegFill').style.width=Math.min(100,((state.pityLeg||0)/200)*100)+'%';
  document.getElementById('pityLegVal').textContent=state.pityLeg||0;
  document.getElementById('pityMythFill').style.width=Math.min(100,((state.pityMyth||0)/500)*100)+'%';
  document.getElementById('pityMythVal').textContent=state.pityMyth||0;

  // Streak chip
  const chip=document.getElementById('streakChip');
  if((state.commonStreak||0)>=5){ chip.textContent=`ğŸ˜© ${state.commonStreak} dry`; chip.classList.add('show'); }
  else chip.classList.remove('show');

  // Boosts
  const br=document.getElementById('boostsRow'); br.innerHTML='';
  const b=state.activeBoosts||{};
  if((b.luckBoost||0)>0)     addBoostChip(br,`ğŸ€ LuckÃ—2 (${b.luckBoost} left)`);
  if((b.guaranteeRare||0)>0) addBoostChip(br,"ğŸ’ Rare+ Guaranteed");
  if((b.guaranteeEpic||0)>0) addBoostChip(br,"ğŸŒŒ Epic+ Guaranteed");
  if((b.essenceX2||0)>0)     addBoostChip(br,`ğŸ’° EssenceÃ—2 (${b.essenceX2} left)`);

  // Prestige
  const toP=Math.max(0,1000-state.rolls);
  document.getElementById('prestigeStatus').textContent=toP>0?`Rolls to prestige: ${toP}`:'âœ… Ready to Prestige!';
  document.getElementById('prestigeBtn').disabled=state.rolls<1000;

  // Daily
  document.getElementById('dailyBtn').disabled=!checkDailyAvailable();
  document.getElementById('dailyBtn').textContent=checkDailyAvailable()?'ğŸ Daily':'â³ Tomorrow';

  updateEquippedPanel();
  updateCollection();
  updateHistoryUI();
  updateAchievementsUI();
  updateFusionUI();
  updateShopUI();
}

function addBoostChip(c,t){
  const el=document.createElement('div'); el.className='boost-chip'; el.textContent=t; c.appendChild(el);
}

// â”€â”€ AURA ROLLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rolling=false, lastRolledAura=null;

function computeWeights(forceMinRarity){
  const prestigeBonus=state.prestige*.02;
  const luckBonus=(state.luck/100)*.1;
  const boostActive=(state.activeBoosts.luckBoost||0)>0;
  const boostMult=boostActive?2:1;
  let epicBonus=0,legBonus=0,mythBonus=0;
  if(state.collection["Storm"]>0)    epicBonus+=.02;
  if(state.collection["Galaxy"]>0)   mythBonus+=.05;
  if(state.collection["Void"]>0)     mythBonus+=.03;
  if(state.collection["Divine"]>0)   legBonus+=.1;
  if(state.collection["Abyssal"]>0)  mythBonus+=.08;
  if(state.collection["Aurora"]>0)   legBonus+=.05;
  if(state.collection["Omni"]>0)     mythBonus+=.1;
  if(state.collection["Omega Storm"])epicBonus+=.08;
  const epicPity=Math.max(0,state.pityEpic-50)*.005;
  const legPity =Math.max(0,state.pityLeg-100)*.003;
  const mythPity=Math.max(0,state.pityMyth-300)*.002;
  if(state.pityLeg>=200) return{forceRarity:"Legendary"};
  if(state.pityMyth>=500) return{forceRarity:"Mythic"};
  const allAuras=[...AURAS,SECRET_AURA];
  const weighted=allAuras.map(a=>{
    let w=a.chance;
    const rank=RARITY_ORDER.indexOf(a.rarity);
    if(rank>=RARITY_ORDER.indexOf("Epic"))      w*=(1+epicBonus+boostMult*.3*luckBonus+epicPity*10+prestigeBonus*5);
    if(rank>=RARITY_ORDER.indexOf("Legendary")) w*=(1+legBonus+legPity*10);
    if(rank>=RARITY_ORDER.indexOf("Mythic"))    w*=(1+mythBonus+mythPity*10);
    if(forceMinRarity && rank<RARITY_ORDER.indexOf(forceMinRarity)) w=0;
    return{aura:a,w:Math.max(0,w)};
  });
  const total=weighted.reduce((s,x)=>s+x.w,0);
  return{weighted,total};
}

function doRollAura(forceMinRarity){
  const result=computeWeights(forceMinRarity);
  if(result.forceRarity){
    const minRank=RARITY_ORDER.indexOf(result.forceRarity);
    const pool=AURAS.filter(a=>RARITY_ORDER.indexOf(a.rarity)>=minRank);
    return pool[Math.floor(Math.random()*pool.length)];
  }
  let r=Math.random()*result.total;
  for(const{aura,w}of result.weighted){r-=w;if(r<0)return aura;}
  return AURAS[0];
}

async function roll(forced){
  if(rolling) return;
  rolling=true;
  ensureAudio();
  const btn=document.getElementById('rollBtn');
  const orb=document.getElementById('orb');
  const orbIcon=document.getElementById('orbIcon');
  btn.disabled=true;
  orb.classList.remove('mythic-spin');

  let forceMin=null;
  if((state.activeBoosts.guaranteeEpic||0)>0){forceMin="Epic";state.activeBoosts.guaranteeEpic--;}
  else if((state.activeBoosts.guaranteeRare||0)>0){forceMin="Rare";state.activeBoosts.guaranteeRare--;}

  orb.classList.add('rolling');
  const spinCount=14+Math.floor(Math.random()*8);
  await new Promise(res=>{
    let s=0;
    const iv=setInterval(()=>{
      orbIcon.textContent=AURAS[Math.floor(Math.random()*AURAS.length)].emoji;
      if(++s>=spinCount){clearInterval(iv);res();}
    },65);
  });

  const aura=doRollAura(forceMin);
  orbIcon.textContent=aura.emoji;
  orb.classList.remove('rolling');
  lastRolledAura=aura;

  const isNew=!(state.collection[aura.name]||state.fusionCollection?.[aura.name]);
  if(!state.collection[aura.name]) state.collection[aura.name]=0;
  state.collection[aura.name]++;

  const evoCount=aura.evoAt||999;
  const evolved=!aura.secret&&state.collection[aura.name]>=evoCount&&!state.evolutions[aura.name];
  if(evolved){ state.evolutions[aura.name]=true; state.evolvedCount=(state.evolvedCount||0)+1; showToast(`ğŸ¦‹ ${aura.name} EVOLVED!`); }

  const essenceGained=calcEssence(aura,isNew,(state.activeBoosts.essenceX2||0)>0);
  state.essence+=essenceGained; state.essenceEarned=(state.essenceEarned||0)+essenceGained;
  if((state.activeBoosts.essenceX2||0)>0) state.activeBoosts.essenceX2--;

  state.rolls++;
  const rank=rarityRank(aura.rarity);
  const isEpicPlus=rank>=rarityRank("Epic");
  const isLegPlus=rank>=rarityRank("Legendary");
  const isMythic=rank>=rarityRank("Mythic");

  if(isEpicPlus) state.pityEpic=0; else state.pityEpic++;
  if(isLegPlus)  state.pityLeg=0;  else state.pityLeg++;
  if(isMythic)   state.pityMyth=0; else state.pityMyth++;

  if(!state.rarityCount) state.rarityCount={Common:0,Uncommon:0,Rare:0,Epic:0,Legendary:0,Mythic:0,SECRET:0};
  state.rarityCount[aura.rarity]=(state.rarityCount[aura.rarity]||0)+1;

  if(!isNew) state.luck=Math.min(100,state.luck+8);
  state.luck=Math.min(100,state.luck+1);
  if((state.activeBoosts.luckBoost||0)>0){state.luck=Math.min(100,state.luck+4);state.activeBoosts.luckBoost--;}
  if(state.luck>=100){state.luckFilled=(state.luckFilled||0)+1;state.luck=0;showToast("ğŸ€ Luck Surge! Rare+ guaranteed!");state.activeBoosts.guaranteeRare=1;}

  const isCommonish=rank<=rarityRank("Uncommon");
  if(isCommonish){state.commonStreak=(state.commonStreak||0)+1;state.maxCommonStreak=Math.max(state.maxCommonStreak||0,state.commonStreak);}
  else state.commonStreak=0;
  if(state.lastRarity===aura.rarity) state.sameRarityStreak=(state.sameRarityStreak||0)+1;
  else state.sameRarityStreak=0;
  state.lastRarity=aura.rarity;
  if(state.commonStreak>0&&state.commonStreak%10===0) state.luck=Math.min(100,state.luck+15);

  if(!state.rarestName||rarityRank(aura.rarity)>rarityRank([...AURAS,SECRET_AURA].find(a=>a.name===state.rarestName)?.rarity||"Common"))
    state.rarestName=aura.name;

  if(!state.history) state.history=[];
  state.history.unshift({name:aura.name,emoji:aura.emoji,rarity:aura.rarity,isNew});
  if(state.history.length>20) state.history.pop();

  SFX.auraRoll(aura.rarity);
  save();

  if(isMythic||aura.rarity==="SECRET"){
    document.getElementById('mythicBg').classList.add('active');
    document.getElementById('mythicPulse').classList.add('active');
    orb.classList.add('mythic-spin');
    setTimeout(()=>{orb.classList.remove('mythic-spin');document.getElementById('mythicBg').classList.remove('active');document.getElementById('mythicPulse').classList.remove('active');},3500);
  }
  if(rank>=rarityRank("Legendary")){ const w=document.getElementById('lobbyScreen'); w.classList.remove('shake'); void w.offsetWidth; w.classList.add('shake'); setTimeout(()=>w.classList.remove('shake'),600); }

  const gc=aura.color==='rainbow'?'rgba(200,150,255,.6)':aura.glow;
  orb.style.boxShadow=`0 0 60px ${gc},0 0 120px ${gc},inset 0 0 30px rgba(0,0,0,.5)`;
  setTimeout(()=>{orb.style.boxShadow='';},2500);

  showRolledAuraResult(aura,isNew,evolved);
  checkAchievements();
  updateLobbyUI();
  setTimeout(()=>{rolling=false;btn.disabled=false;},1600);
}

function calcEssence(aura,isNew,doubled){
  const base={Common:1,Uncommon:3,Rare:10,Epic:30,Legendary:100,Mythic:500,SECRET:1000};
  return (base[aura.rarity]||1)*(isNew?2:1)*(doubled?2:1);
}

function showRolledAuraResult(aura,isNew,evolved){
  const card=document.getElementById('resultCard');
  const col=RARITY_COLORS[aura.rarity]||RARITY_COLORS.Common;
  const buff=getAuraBuff(aura);
  card.classList.remove('visible');
  setTimeout(()=>{
    document.getElementById('resEmoji').textContent=aura.emoji;
    const nameEl=document.getElementById('resName');
    nameEl.textContent=aura.name;
    nameEl.style.background='';nameEl.style.webkitBackgroundClip='';
    if(aura.color==='rainbow'){
      nameEl.style.background='linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff,#c77dff)';
      nameEl.style.webkitBackgroundClip='text';nameEl.style.webkitTextFillColor='transparent';
    } else { nameEl.style.webkitTextFillColor=aura.color; }
    if(isNew){ const nb=document.createElement('span');nb.className='new-badge';nb.textContent='NEW!';nameEl.appendChild(nb); }
    const badge=document.getElementById('resBadge');
    badge.textContent=aura.rarity;badge.style.color=col.text;badge.style.borderColor=col.border;badge.style.background=col.bg;
    document.getElementById('resPower').textContent=`âš¡ ${aura.power||''}`;

    const buffEl=document.getElementById('resBuff');
    const equipBtn=document.getElementById('equipBtn');
    if(buff){
      buffEl.style.display='block';
      buffEl.innerHTML=`<strong>ğŸ›¡ GAME BUFF:</strong> ${buff.desc}`;
      buffEl.style.borderColor=col.border;
    } else { buffEl.style.display='none'; }

    equipBtn.style.display='block';
    const isEquipped=state.equippedAura===aura.name;
    equipBtn.textContent=isEquipped?'âœ“ EQUIPPED':'ğŸ›¡ EQUIP AURA';
    equipBtn.className='equip-btn'+(isEquipped?' equipped':'');

    card.style.borderColor=col.border;card.style.background=col.bg;
    card.style.boxShadow=`0 0 20px ${aura.glow||'transparent'}`;
    card.classList.add('visible');
  },80);
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHistoryUI(){
  const list=document.getElementById('historyList'); list.innerHTML='';
  (state.history||[]).forEach(h=>{
    const col=RARITY_COLORS[h.rarity]||RARITY_COLORS.Common;
    const div=document.createElement('div'); div.className='hist-item'; div.style.borderColor=col.border;
    div.innerHTML=`<span class="hist-emoji">${h.emoji}</span><span class="hist-name" style="color:${col.text}">${h.name}</span><span class="hist-rarity">${h.rarity}</span>${h.isNew?'<span class="hist-new">NEW</span>':''}`;
    list.appendChild(div);
  });
  const graph=document.getElementById('rarityGraph'); graph.innerHTML='';
  const total=Object.values(state.rarityCount||{}).reduce((a,b)=>a+b,0)||1;
  const gColors={Common:"#b0b0c0",Uncommon:"#4dff91",Rare:"#4dc8ff",Epic:"#c084fc",Legendary:"#ffd700",Mythic:"#ff80ff",SECRET:"#00ff00"};
  RARITY_ORDER.forEach(r=>{
    const cnt=state.rarityCount?.[r]||0;
    const pct=Math.round((cnt/total)*100);
    const row=document.createElement('div');row.className='rg-row';
    row.innerHTML=`<span class="rg-label" style="color:${gColors[r]}">${r}</span><div class="rg-bar"><div class="rg-fill" style="width:${pct}%;background:${gColors[r]}"></div></div><span class="rg-count">${cnt}</span>`;
    graph.appendChild(row);
  });
}

// â”€â”€ ACHIEVEMENTS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAchievements(){
  ACHIEVEMENTS.forEach(a=>{
    if(state.achievements[a.id]) return;
    if(a.check(state)){
      state.achievements[a.id]=true;
      if(a.essence){state.essence+=a.essence;state.essenceEarned=(state.essenceEarned||0)+a.essence;}
      if(a.titleId&&!state.unlockedTitles.includes(a.titleId)) state.unlockedTitles.push(a.titleId);
      showToast(`ğŸ† ${a.name}! ${a.reward}`);
    }
  });
  if(TITLES.filter(t=>t.id!=='aura_master').every(t=>state.unlockedTitles.includes(t.id))&&!state.unlockedTitles.includes('aura_master')){
    state.unlockedTitles.push('aura_master'); showToast('âœ¨ Title: Aura Master!');
  }
}

function updateAchievementsUI(){
  const grid=document.getElementById('achGrid'); grid.innerHTML='';
  let done=0;
  ACHIEVEMENTS.forEach(a=>{
    const isDone=state.achievements[a.id];
    if(isDone) done++;
    const div=document.createElement('div');
    div.className='ach-item'+(isDone?' done':'');
    div.innerHTML=`<div class="ach-icon">${a.icon}</div><div class="ach-info"><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div><div class="ach-reward">${a.reward}</div></div>`;
    grid.appendChild(div);
  });
  document.getElementById('achCount').textContent=done;
  document.getElementById('achTotal').textContent=ACHIEVEMENTS.length;

  const tr=document.getElementById('titlesRow'); tr.innerHTML='';
  TITLES.forEach(t=>{
    const unlocked=state.unlockedTitles.includes(t.id);
    const active=state.activeTitle===t.id;
    const chip=document.createElement('div');
    chip.className='title-chip'+(unlocked?' unlocked':'')+(active?' active-title':'');
    if(t.color==='rainbow') chip.style.setProperty('--tc','#ff80ff');
    else if(unlocked) chip.style.setProperty('--tc',t.color);
    chip.textContent=t.name;
    chip.onclick=()=>{if(unlocked){state.activeTitle=active?null:t.id;save();updateAchievementsUI();}};
    tr.appendChild(chip);
  });
}

// â”€â”€ FUSION UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFusionUI(){
  const list=document.getElementById('fusionList'); list.innerHTML='';
  FUSIONS.forEach(f=>{
    const canFuse=Object.entries(f.needs).every(([n,c])=>(state.collection[n]||0)>=c);
    const alreadyMade=(state.fusionCollection?.[f.reward.name]||0)>0;
    const div=document.createElement('div'); div.className='fusion-item';
    const recipe=Object.entries(f.needs).map(([n,c])=>`${c}Ã— ${n} (have ${state.collection[n]||0})`).join(' + ');
    div.innerHTML=`<div class="fusion-recipe"><div style="font-size:.55rem;color:rgba(255,255,255,.35);margin-bottom:2px">${recipe}</div><div class="fusion-result">â†’ ${f.result}</div><div style="font-size:.5rem;color:#ffd700;margin-top:2px">ğŸ’ ${f.essence} Essence</div>${alreadyMade?'<div style="font-size:.45rem;color:#4dff91">âœ… Created</div>':''}</div><button class="fusion-btn" ${canFuse&&!alreadyMade&&state.essence>=f.essence?'':'disabled'} onclick="doFusion('${f.id}')">âš—ï¸ Fuse</button>`;
    list.appendChild(div);
  });
}

function doFusion(id){
  const f=FUSIONS.find(x=>x.id===id); if(!f) return;
  if(!Object.entries(f.needs).every(([n,c])=>(state.collection[n]||0)>=c)||state.essence<f.essence) return;
  Object.entries(f.needs).forEach(([n,c])=>{state.collection[n]=(state.collection[n]||0)-c;});
  state.essence-=f.essence;
  if(!state.fusionCollection) state.fusionCollection={};
  state.fusionCollection[f.reward.name]=(state.fusionCollection[f.reward.name]||0)+1;
  state.fusions=(state.fusions||0)+1;
  showToast(`âš—ï¸ Fusion: ${f.result}!`);
  checkAchievements(); save(); updateLobbyUI(); buildCollection();
}

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShop(){ document.getElementById('shopModal').style.display='flex'; updateShopUI(); }
function closeShop(){ document.getElementById('shopModal').style.display='none'; }
function updateShopUI(){
  const grid=document.getElementById('shopGrid'); grid.innerHTML='';
  SHOP_ITEMS.forEach(item=>{
    const canBuy=(state.essence||0)>=item.cost;
    const div=document.createElement('div');
    div.style.cssText='background:var(--panel);border:1px solid rgba(255,200,50,.15);border-radius:11px;padding:11px;text-align:center;cursor:'+(canBuy?'pointer':'not-allowed')+';opacity:'+(canBuy?1:.35)+';transition:all .2s;';
    div.innerHTML=`<div style="font-size:1.6rem;margin-bottom:3px">${item.emoji}</div><div style="font-size:.58rem;font-weight:700;margin-bottom:2px">${item.name}</div><div style="font-size:.48rem;color:rgba(255,255,255,.35);margin-bottom:5px;line-height:1.4">${item.desc}</div><div style="font-size:.6rem;font-weight:700;color:#ffd700">ğŸ’ ${item.cost}</div>`;
    if(canBuy) div.onclick=()=>buyShopItem(item);
    grid.appendChild(div);
  });
}
function buyShopItem(item){
  if((state.essence||0)<item.cost) return;
  state.essence-=item.cost;
  if(!state.activeBoosts) state.activeBoosts={};
  switch(item.effect){
    case"luckBoost":     state.activeBoosts.luckBoost=(state.activeBoosts.luckBoost||0)+10; break;
    case"guaranteeRare": state.activeBoosts.guaranteeRare=1; break;
    case"guaranteeEpic": state.activeBoosts.guaranteeEpic=1; break;
    case"bonusRoll":     state.activeBoosts.bonusRoll=(state.activeBoosts.bonusRoll||0)+1; break;
    case"essenceX2":     state.activeBoosts.essenceX2=(state.activeBoosts.essenceX2||0)+20; break;
    case"maxLuck":       state.luck=99; break;
  }
  SFX.select();
  showToast(`ğŸ›’ Bought: ${item.name}!`);
  save(); updateLobbyUI();
}

// â”€â”€ DAILY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkDailyAvailable(){
  if(!state.lastDaily) return true;
  return new Date(state.lastDaily).toDateString()!==new Date().toDateString();
}
function claimDaily(){
  if(!checkDailyAvailable()) return;
  ensureAudio();
  state.lastDaily=new Date().toISOString();
  state.essence=(state.essence||0)+50;state.essenceEarned=(state.essenceEarned||0)+50;
  if(!state.activeBoosts) state.activeBoosts={};
  state.activeBoosts.guaranteeRare=(state.activeBoosts.guaranteeRare||0)+1;
  state.activeBoosts.luckBoost=(state.activeBoosts.luckBoost||0)+10;
  save(); showToast("ğŸ Daily! +50ğŸ’ + Luck Boost + Rare guaranteed!");
  updateLobbyUI();
  setTimeout(()=>roll(),400); setTimeout(()=>roll(),1900); setTimeout(()=>roll(),3400);
}

// â”€â”€ PRESTIGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doPrestige(){
  if(state.rolls<1000) return;
  if(!confirm("Prestige? Collection resets. Essence, achievements and titles remain. Gain +2% permanent luck.")) return;
  const pp=(state.prestige||0)+1, pe=state.essence||0, pee=state.essenceEarned||0;
  const pach=state.achievements, ptitles=state.unlockedTitles, ptitle=state.activeTitle;
  const pStats={totalKills:state.totalKills||0,bossKills:state.bossKills||0,gamesPlayed:state.gamesPlayed||0,maxLevel:state.maxLevel||0,bestScore:state.bestScore||0,maxComboCombat:state.maxComboCombat||0,diffBeaten:state.diffBeaten||{},gamesWithAura:state.gamesWithAura||0,gamesWithMythicAura:state.gamesWithMythicAura||0};
  state=defaultState();
  state.prestige=pp;state.essence=pe;state.essenceEarned=pee;
  state.achievements=pach;state.unlockedTitles=ptitles;state.activeTitle=ptitle;
  Object.assign(state,pStats);
  checkAchievements(); save(); buildCollection();
  showToast(`â­ Prestige ${pp}! +${pp*2}% permanent luck!`);
  updateLobbyUI();
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
}

// â”€â”€ AURA PARTICLES (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnAuraParticles(aura){
  const orb=document.getElementById('orb'); if(!orb) return;
  const rect=orb.getBoundingClientRect();
  const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
  const colors=aura.color==='rainbow'?['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#c77dff']:[aura.color,'#fff',aura.glow];
  const count=rarityRank(aura.rarity)>=rarityRank("Legendary")?30:rarityRank(aura.rarity)>=rarityRank("Rare")?18:8;
  for(let i=0;i<count;i++){
    const p=document.createElement('div'); p.className='particle';
    const sz=4+Math.random()*7, angle=Math.random()*Math.PI*2, d=80+Math.random()*180;
    const tx=Math.cos(angle)*d, ty=Math.sin(angle)*d-50;
    p.style.cssText=`left:${cx}px;top:${cy}px;width:${sz}px;height:${sz}px;background:${colors[Math.floor(Math.random()*colors.length)]};box-shadow:0 0 5px currentColor;--tx:${tx}px;--ty:${ty}px;animation-duration:${.7+Math.random()*.7}s;animation-delay:${Math.random()*.15}s`;
    document.body.appendChild(p); setTimeout(()=>p.remove(),1500);
  }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME ENGINE  (Neon Surge)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let running=false, paused=false, gameOver=false;
let score=0, hiScore=parseInt(localStorage.getItem('neonSurgeHiV2')||'0');
let combo=0, maxCombo=0, comboTimer=0;
let level=1, levelKills=0;
let sessionKills=0;
let shakeAmt=0;
let bgTime=0;
let timeScale=1, timeScaleTarget=1, bossSlowTimer=0;
let shielded=false,shieldTimer=0;
let speedBoostAct=false,speedBoostTimer=0;
let timeSlow=false,timeSlowTimer=0;
let doubleScore=false,doubleScoreTimer=0;
let bossActive=false;
let bossWarningTimer=0, levelBannerTimer=0;
let raf=null, lastTime=0;
// Kill-speed stacks (Divine aura)
let killSpeedBonus=0;
// Void God auto-slow cooldown
let voidGodCd=0;
// Omni bonus aura state toggle (genesis start shield)
let genesisShieldUsed=false;

const PLAYER_SPEED_BASE=230;
const DASH_SPEED=700;
const DASH_DUR_BASE=.17;
const DASH_CD_BASE=1.1;
const STAMINA_REGEN=38;
const STAMINA_COST=38;
const MAX_PARTICLES=400, MAX_ENEMIES=40;

const particles=[];
const floaters=[];
const enemies=[];
const powerups=[];
let spawnQueue=[], waveTimer=2;

// â”€â”€ ACTIVE BUFF CACHE (computed once at game start) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeBuff=null;
function computeActiveBuff(){
  const name=state.equippedAura;
  if(!name){ activeBuff=null; return; }
  const allAuras=[...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)];
  const aura=allAuras.find(a=>a.name===name);
  activeBuff=aura?getAuraBuff(aura):null;
}

function getBuffVal(key,def){
  if(!activeBuff) return def;
  return activeBuff[key]!==undefined?activeBuff[key]:def;
}

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnParticle(x,y,opts={}){
  if(particles.length>=MAX_PARTICLES) return;
  const life=opts.life??rnd(.3,.8);
  particles.push({x,y,vx:opts.vx??rnd(-120,120),vy:opts.vy??rnd(-120,120),life,maxLife:life,size:opts.size??rnd(2,5),color:opts.color??'#fff',glow:opts.glow??true,gravity:opts.gravity??0});
}
function spawnBurst(x,y,count,color,speed=150,size=4){
  count=Math.min(count,MAX_PARTICLES-particles.length);
  for(let i=0;i<count;i++){
    const angle=(i/count)*Math.PI*2+rnd(0,.6);
    const s=rnd(speed*.5,speed*1.3);
    spawnParticle(x,y,{vx:Math.cos(angle)*s,vy:Math.sin(angle)*s,color,size:rnd(size*.5,size),life:rnd(.25,.65)});
  }
}
function spawnTrail(x,y,color,sz=4){
  spawnParticle(x,y,{vx:rnd(-25,25),vy:rnd(-25,25),life:rnd(.08,.2),size:rnd(sz*.6,sz),color,glow:true});
}
function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=p.gravity*dt;p.vx*=.96;p.vy*=.96;p.life-=dt;
    if(p.life<=0) particles.splice(i,1);
  }
}
function drawParticles(){
  ctx.save();
  particles.forEach(p=>{
    const t=Math.max(0,p.life/p.maxLife),sz=Math.max(.3,p.size*t);
    ctx.globalAlpha=t*.9;
    if(p.glow){ctx.shadowColor=p.color;ctx.shadowBlur=sz*3.5;}else{ctx.shadowBlur=0;}
    ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,sz,0,Math.PI*2);ctx.fill();
  });
  ctx.globalAlpha=1;ctx.shadowBlur=0;ctx.restore();
}
function spawnFloater(x,y,text,color='#ffbe00',size=14){
  floaters.push({x,y,text,color,size,life:1.1,maxLife:1.1,vy:-55,vx:rnd(-12,12)});
}
function updateFloaters(dt){
  for(let i=floaters.length-1;i>=0;i--){
    const f=floaters[i];f.y+=f.vy*dt;f.x+=f.vx*dt;f.vy+=20*dt;f.life-=dt;
    if(f.life<=0) floaters.splice(i,1);
  }
}
function drawFloaters(){
  floaters.forEach(f=>{
    const t=clamp(f.life/f.maxLife,0,1),sc=1+(1-t)*.3;
    ctx.save();ctx.globalAlpha=t;ctx.shadowColor=f.color;ctx.shadowBlur=9;
    ctx.fillStyle=f.color;ctx.font=`bold ${Math.floor(f.size*sc)}px 'Courier New'`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(f.text,f.x,f.y);ctx.restore();
  });
}

// â”€â”€ PLAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const player={
  x:0,y:0,r:15,hp:100,maxHp:100,stamina:100,maxStamina:100,
  dashing:false,dashTimer:0,dashCd:0,dashDx:0,dashDy:0,
  invincible:0,hitFlash:0,pulseT:0,trail:[],

  init(){
    this.x=canvas.width/2;this.y=canvas.height/2;
    // Apply aura HP bonus
    const bonusHp=getBuffVal('bonusHp',0);
    this.maxHp=100+bonusHp;
    this.hp=this.maxHp;
    this.stamina=100;this.maxStamina=100;
    this.dashing=false;this.dashTimer=0;this.dashCd=0;
    this.invincible=0;this.hitFlash=0;this.trail=[];
    document.getElementById('healthFill').classList.remove('hp-low');
  },

  get speed(){ return PLAYER_SPEED_BASE*getBuffVal('speedMult',1)*(speedBoostAct?1.6:1)*(1+killSpeedBonus); },
  get dashDur(){ return DASH_DUR_BASE*getBuffVal('dashDurMult',1); },
  get dashCdFull(){ return DASH_CD_BASE*getBuffVal('dashCdMult',1); },
  get dashDamage(){ return (35+level*4)*getBuffVal('dashDamageMult',1)*DIFFICULTIES[selectedDiff].scoreMult; },
  get dashRadius(){ return getBuffVal('dashRadius',0); },

  update(dt){
    this.pulseT+=dt*3;
    if(this.invincible>0) this.invincible-=dt;
    if(this.hitFlash>0) this.hitFlash-=dt;
    if(this.dashCd>0) this.dashCd-=dt;
    this.stamina=Math.min(this.maxStamina,this.stamina+STAMINA_REGEN*dt);

    if(input.dashPressed){
      input.dashPressed=false;
      if(!this.dashing&&this.dashCd<=0&&this.stamina>=STAMINA_COST){
        let mx=input.moveX,my=input.moveY;
        if(Math.hypot(mx,my)<.1){mx=0;my=-1;}
        const n=normalize(mx,my);
        this.dashDx=n.x;this.dashDy=n.y;
        this.dashing=true;this.dashTimer=this.dashDur;
        this.dashCd=this.dashCdFull;
        this.stamina-=STAMINA_COST;
        // Phantom dash: brief full invincibility
        this.invincible=getBuffVal('phantomDash',false)?this.dashDur+.5:this.dashDur+.12;
        spawnBurst(this.x,this.y,10,'#00d4ff',120,5);
        SFX.dash();
        if(navigator.vibrate) navigator.vibrate(28);
      }
    }

    let spd=this.speed;
    if(this.dashing){
      this.x+=this.dashDx*DASH_SPEED*dt;
      this.y+=this.dashDy*DASH_SPEED*dt;
      this.dashTimer-=dt;
      const trailColor=state.equippedAura?([...AURAS,SECRET_AURA].find(a=>a.name===state.equippedAura)?.color||'#00d4ff'):'#00d4ff';
      const tc=trailColor==='rainbow'?'#ff80ff':trailColor;
      if(Math.random()<.7) spawnTrail(this.x,this.y,tc,5);
      // Dash trail damage (Nebula / Jack-o-Flame)
      if(getBuffVal('dashTrailDmg',false)&&Math.random()<.4){
        enemies.forEach(e=>{ if(!e.dead&&dist(this,e)<e.r+20) e.hit(8); });
      }
      if(this.dashTimer<=0) this.dashing=false;
    } else {
      let mx=input.moveX,my=input.moveY;
      const len=Math.hypot(mx,my);
      if(len>1){mx/=len;my/=len;}
      this.x+=mx*spd*dt;this.y+=my*spd*dt;
      if(len>.15&&speedBoostAct) spawnTrail(this.x,this.y,'#ffbe00',3);
    }

    this.trail.unshift({x:this.x,y:this.y});
    if(this.trail.length>12) this.trail.pop();
    this.x=clamp(this.x,this.r,canvas.width-this.r);
    this.y=clamp(this.y,this.r,canvas.height-this.r);

    const btn=document.getElementById('dashBtn');
    if(this.dashCd>0) btn.classList.add('on-cooldown');
    else btn.classList.remove('on-cooldown');
  },

  draw(){
    const pulse=Math.sin(this.pulseT)*2.5;
    // Trail
    for(let i=0;i<this.trail.length;i++){
      const t=1-(i/this.trail.length);
      ctx.save();ctx.globalAlpha=t*.15;ctx.shadowColor='#00d4ff';ctx.shadowBlur=8;
      ctx.fillStyle='#00d4ff';ctx.beginPath();ctx.arc(this.trail[i].x,this.trail[i].y,this.r*t,0,Math.PI*2);ctx.fill();ctx.restore();
    }
    if(this.invincible>0&&Math.floor(this.invincible*12)%2===0) return;
    ctx.save();
    if(shielded){
      ctx.strokeStyle='#00ffff';ctx.lineWidth=2.5;ctx.shadowColor='#00ffff';ctx.shadowBlur=25;
      ctx.globalAlpha=.55+Math.sin(this.pulseT*2)*.3;
      ctx.beginPath();ctx.arc(this.x,this.y,this.r+14+pulse*.5,0,Math.PI*2);ctx.stroke();
      ctx.globalAlpha=.3;ctx.beginPath();ctx.arc(this.x,this.y,this.r+11,this.pulseT,this.pulseT+Math.PI*.7);ctx.stroke();
      ctx.globalAlpha=1;
    }
    if(this.hitFlash>0){
      ctx.globalAlpha=this.hitFlash*.8;ctx.fillStyle='#ff2d55';ctx.shadowColor='#ff2d55';ctx.shadowBlur=30;
      ctx.beginPath();ctx.arc(this.x,this.y,this.r+8,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
    }
    // Aura glow ring
    const eqAura=state.equippedAura?[...AURAS,SECRET_AURA].find(a=>a.name===state.equippedAura):null;
    if(eqAura&&eqAura.color!=='rainbow'){
      ctx.strokeStyle=eqAura.color;ctx.lineWidth=1.5;
      ctx.shadowColor=eqAura.color;ctx.shadowBlur=12;ctx.globalAlpha=.35;
      ctx.beginPath();ctx.arc(this.x,this.y,this.r+20+pulse,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;
    }
    ctx.shadowColor='#00d4ff';ctx.shadowBlur=20+pulse;
    const grad=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r);
    grad.addColorStop(0,'#ffffff');grad.addColorStop(.35,'#00d4ff');grad.addColorStop(1,'#0033ff');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=4;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(this.x,this.y,4,0,Math.PI*2);ctx.fill();
    ctx.restore();
  },

  takeDamage(amt){
    if(this.invincible>0) return;
    // Damage taken modifier
    amt*=getBuffVal('damageTakenMult',1)*DIFFICULTIES[selectedDiff].playerDmgMult;
    if(shielded){
      shielded=false;shieldTimer=0;
      spawnBurst(this.x,this.y,14,'#00ffff',220,6);shakeAmt=Math.max(shakeAmt,10);SFX.shieldBreak?.();
      if(!getBuffVal('comboProtect',false)){combo=0;comboTimer=0;}
      return;
    }
    this.hp=Math.max(0,this.hp-amt);
    this.invincible=.55+getBuffVal('extraInvTime',0);
    this.hitFlash=.25;
    shakeAmt=Math.max(shakeAmt,16);
    spawnBurst(this.x,this.y,10,'#ff2d55',160,5);SFX.hit();
    if(navigator.vibrate) navigator.vibrate([20,10,20]);
    if(!getBuffVal('comboProtect',false)){combo=0;comboTimer=0;}
    if(this.hp<25) document.getElementById('healthFill').classList.add('hp-low');
    else document.getElementById('healthFill').classList.remove('hp-low');
    if(this.hp<=0) endGame();
    // Thorn reflect
    const reflect=getBuffVal('reflectDmg',0);
    if(reflect>0) enemies.forEach(e=>{if(!e.dead&&dist(this,e)<e.r+60) e.hit(amt*reflect);});
  }
};

// â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Enemy{
  constructor(x,y,type,lvl){
    this.x=x;this.y=y;this.type=type;this.level=lvl;
    this.dead=false;this.age=0;this.pulseT=rnd(0,Math.PI*2);
    this.hitFlash=0;this.setStats();
  }
  setStats(){
    const d=DIFFICULTIES[selectedDiff];
    const sc=(1+(this.level-1)*.12)*d.enemyHpMult;
    const ss=d.enemySpeedMult*getBuffVal('enemySlowMult',1);
    switch(this.type){
      case'chaser':   this.r=13;this.hp=this.maxHp=28*sc;this.speed=(88+level*5)*ss;this.color='#ff2d55';this.score=100;this.dmg=12;break;
      case'orbiter':  this.r=10;this.hp=this.maxHp=18*sc;this.speed=(130+level*4)*ss;this.color='#ff6600';this.score=150;this.dmg=8;this.orbitAngle=rnd(0,Math.PI*2);this.orbitDist=rnd(70,130);this.orbitDir=Math.random()>.5?1:-1;break;
      case'rusher':   this.r=17;this.hp=this.maxHp=45*sc;this.speed=(55+level*2)*ss;this.color='#aa00ff';this.score=200;this.dmg=22;this.rushing=false;this.rushCd=rnd(1.8,3.2);this.rushTimer=0;this.rushDx=0;this.rushDy=0;break;
      case'splitter': this.r=19;this.hp=this.maxHp=55*sc;this.speed=(65+level*3)*ss;this.color='#ffbe00';this.score=250;this.dmg=18;this.split=true;break;
      case'boss':     this.r=42;this.hp=this.maxHp=Math.floor(450*sc);this.speed=(60+level*1.5)*ss;this.color='#ff0066';this.score=2500;this.dmg=28;this.phase=0;this.spawnCd=2.5;this.spinAngle=0;this.dashCd2=3;this.dashTimer2=0;this.dashing2=false;this.dashDx2=0;this.dashDy2=0;break;
    }
  }
  update(dt){
    const ems=getBuffVal('enemySlowMult',1);
    const tdt=(timeSlow?dt*.28:dt)*ems;
    this.pulseT+=tdt*4;this.age+=dt;
    if(this.hitFlash>0) this.hitFlash-=dt;
    if(this.type==='chaser'){
      const n=normalize(player.x-this.x,player.y-this.y);
      this.x+=n.x*this.speed*tdt;this.y+=n.y*this.speed*tdt;
    }else if(this.type==='orbiter'){
      this.orbitAngle+=this.orbitDir*(1.4+level*.04)*tdt;
      const tx=player.x+Math.cos(this.orbitAngle)*this.orbitDist;
      const ty=player.y+Math.sin(this.orbitAngle)*this.orbitDist;
      const n=normalize(tx-this.x,ty-this.y);
      this.x+=n.x*this.speed*tdt;this.y+=n.y*this.speed*tdt;
    }else if(this.type==='rusher'){
      if(this.rushing){
        this.x+=this.rushDx*500*tdt;this.y+=this.rushDy*500*tdt;
        this.rushTimer-=dt;spawnTrail(this.x,this.y,'#cc00ff',3);
        if(this.rushTimer<=0){this.rushing=false;this.rushCd=rnd(2.2,4);}
      }else{
        const n=normalize(player.x-this.x,player.y-this.y);
        this.x+=n.x*this.speed*tdt;this.y+=n.y*this.speed*tdt;
        this.rushCd-=dt;
        if(this.rushCd<.5&&this.rushCd>0&&Math.random()<.15) spawnParticle(this.x,this.y,{vx:rnd(-50,50),vy:rnd(-50,50),life:.2,size:rnd(2,5),color:'#cc00ff'});
        if(this.rushCd<=0){
          this.rushing=true;this.rushTimer=.32;
          const rn=normalize(player.x-this.x,player.y-this.y);this.rushDx=rn.x;this.rushDy=rn.y;
          spawnBurst(this.x,this.y,8,'#aa00ff',100,4);
        }
      }
    }else if(this.type==='splitter'){
      const n=normalize(player.x-this.x,player.y-this.y);
      this.x+=n.x*this.speed*tdt;this.y+=n.y*this.speed*tdt;
    }else if(this.type==='boss'){
      const hpPct=this.hp/this.maxHp;this.phase=hpPct<.5?1:0;
      const spdMul=this.phase===1?1.75:1;this.spinAngle+=tdt*2;
      if(this.dashing2){
        this.x+=this.dashDx2*600*tdt;this.y+=this.dashDy2*600*tdt;
        this.dashTimer2-=dt;spawnTrail(this.x,this.y,'#ff0066',6);
        if(this.dashTimer2<=0){this.dashing2=false;this.dashCd2=this.phase===1?2:4;}
      }else{
        const n=normalize(player.x-this.x,player.y-this.y);
        this.x+=n.x*this.speed*spdMul*tdt;this.y+=n.y*this.speed*spdMul*tdt;
        this.dashCd2-=dt;
        if(this.dashCd2<=0&&dist(this,player)<300){
          this.dashing2=true;this.dashTimer2=.28;
          const rn=normalize(player.x-this.x,player.y-this.y);this.dashDx2=rn.x;this.dashDy2=rn.y;
          spawnBurst(this.x,this.y,12,'#ff0066',150,6);
        }
      }
      this.spawnCd-=dt;
      if(this.spawnCd<=0){this.spawnCd=this.phase===1?1:2.2;if(enemies.length<MAX_ENEMIES) spawnEnemyRaw('chaser');}
      if(Math.random()<.25) spawnParticle(this.x+rnd(-this.r,this.r),this.y+rnd(-this.r,this.r),{vx:rnd(-50,50),vy:rnd(-50,50),life:rnd(.2,.5),size:rnd(3,9),color:'#ff0066'});
    }
    this.x=clamp(this.x,this.r+5,canvas.width-this.r-5);
    this.y=clamp(this.y,this.r+5,canvas.height-this.r-5);
    const d=dist(this,player);
    if(d<this.r+player.r-4){
      const ov=Math.max(0,(this.r+player.r-d)/(this.r+player.r));
      player.takeDamage(this.dmg*ov*dt*3.5);
    }
  }
  hit(dmg){
    if(this.dead) return;
    this.hp-=dmg;this.hitFlash=.1;spawnBurst(this.x,this.y,5,this.color,90,3);
    if(this.hp<=0) this.die();
  }
  die(){
    if(this.dead) return;
    this.dead=true;
    spawnBurst(this.x,this.y,20,this.color,200,6);
    shakeAmt=Math.max(shakeAmt,this.type==='boss'?30:7);
    if(this.type==='boss'){ bossActive=false;SFX.bossKill();timeScaleTarget=.15;bossSlowTimer=1.8;spawnBurst(this.x,this.y,40,this.color,350,8);state.bossKills=(state.bossKills||0)+1;
      // Difficulty achievements
      if(level>=5){
        const diffId=DIFFICULTIES[selectedDiff].id;
        if(!state.diffBeaten) state.diffBeaten={};
        if(['hard','hell','impossible'].includes(diffId)) state.diffBeaten[diffId]=true;
      }
    } else { SFX.kill(); }
    if(this.type==='splitter'&&this.split){
      for(let i=0;i<2;i++){if(enemies.length<MAX_ENEMIES){const c=new Enemy(this.x+rnd(-20,20),this.y+rnd(-20,20),'chaser',level);c.r=8;c.hp=c.maxHp=16;c.score=60;enemies.push(c);}}
    }
    const comboMul=Math.max(1,combo)*getBuffVal('comboMult',1);
    const diffScoreMul=DIFFICULTIES[selectedDiff].scoreMult;
    const pts=Math.floor((doubleScore?2:1)*this.score*comboMul*diffScoreMul);
    score+=pts;combo++;maxCombo=Math.max(maxCombo,combo);comboTimer=3.2;
    sessionKills++;state.totalKills=(state.totalKills||0)+1;levelKills++;
    spawnFloater(this.x,this.y-22,`+${pts.toLocaleString()}`,this.type==='boss'?'#ff00aa':'#ffbe00');
    if(combo>=3) spawnFloater(this.x,this.y-44,`Ã—${combo} COMBO!`,'#ff00aa',16);
    if(combo>=3) SFX.combo?.();
    // Kill healing (Blood Moon / Aurora)
    const killHeal=getBuffVal('killHeal',0);
    if(killHeal>0) player.hp=Math.min(player.maxHp,player.hp+killHeal);
    // Life steal (Abyssal)
    const lifeSteal=getBuffVal('lifeSteal',0);
    if(lifeSteal>0) player.hp=Math.min(player.maxHp,player.hp+this.dmg*lifeSteal);
    // Divine kill speed stacks
    if(getBuffVal('killSpeedStacks',false)&&killSpeedBonus<.3) killSpeedBonus+=.01;
    // Powerup drop
    const baseChance=this.type==='boss'?1:.18;
    const puMult=getBuffVal('puDropMult',1);
    if(Math.random()<baseChance*puMult) spawnPowerup(this.x,this.y);
    state.maxComboCombat=Math.max(state.maxComboCombat||0,maxCombo);
    state.bestScore=Math.max(state.bestScore||0,score);
  }
  draw(){
    const pulse=Math.sin(this.pulseT)*2;ctx.save();
    if(this.hitFlash>0){ctx.shadowColor='#fff';ctx.shadowBlur=30*(this.hitFlash/.1);}
    else{ctx.shadowColor=this.color;ctx.shadowBlur=14+pulse;}
    if(this.type==='boss'){
      ctx.strokeStyle=this.phase===1?'#ff88aa':this.color;ctx.lineWidth=3;
      const sp=10;ctx.beginPath();
      for(let i=0;i<=sp*2;i++){const a=(i/(sp*2))*Math.PI*2+this.spinAngle;const r=i%2===0?this.r+10+pulse*1.5:this.r-6;if(i===0)ctx.moveTo(this.x+Math.cos(a)*r,this.y+Math.sin(a)*r);else ctx.lineTo(this.x+Math.cos(a)*r,this.y+Math.sin(a)*r);}
      ctx.closePath();ctx.fillStyle=this.color+'22';ctx.fill();ctx.stroke();
      const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r);
      g.addColorStop(0,'#ffffff');g.addColorStop(.3,this.color);g.addColorStop(1,this.color+'44');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,this.r-2,0,Math.PI*2);ctx.fill();
      if(this.phase===1){ctx.strokeStyle='rgba(255,136,170,.5)';ctx.lineWidth=2;ctx.shadowBlur=20;ctx.beginPath();ctx.arc(this.x,this.y,this.r+18+Math.sin(this.pulseT*2)*6,0,Math.PI*2);ctx.stroke();}
      const bw=this.r*2.8;ctx.shadowBlur=0;ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(this.x-bw/2,this.y-this.r-18,bw,7);
      ctx.fillStyle=this.phase===1?'#ff88aa':this.color;ctx.shadowColor=this.color;ctx.shadowBlur=6;ctx.fillRect(this.x-bw/2,this.y-this.r-18,bw*(this.hp/this.maxHp),7);
      ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.font='bold 9px Courier New';ctx.textAlign='center';ctx.fillText('BOSS',this.x,this.y-this.r-22);
    }else if(this.type==='orbiter'){
      ctx.fillStyle=this.color;const sz=this.r+pulse;
      ctx.beginPath();ctx.moveTo(this.x,this.y-sz);ctx.lineTo(this.x+sz*.7,this.y);ctx.lineTo(this.x,this.y+sz);ctx.lineTo(this.x-sz*.7,this.y);ctx.closePath();ctx.fill();
    }else if(this.type==='rusher'){
      const n=normalize(player.x-this.x,player.y-this.y),angle=Math.atan2(n.y,n.x);
      ctx.translate(this.x,this.y);ctx.rotate(angle);
      if(this.rushing){ctx.shadowColor='#cc00ff';ctx.shadowBlur=30;}
      else if(this.rushCd<.6){ctx.shadowColor='#ff00aa';ctx.shadowBlur=20+Math.sin(this.age*20)*10;}
      ctx.fillStyle=this.color;ctx.beginPath();ctx.moveTo(this.r+pulse,0);ctx.lineTo(-this.r,-this.r*.75);ctx.lineTo(-this.r*.5,0);ctx.lineTo(-this.r,this.r*.75);ctx.closePath();ctx.fill();
    }else{
      const sz=this.r+(this.type==='splitter'?pulse:0);
      const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,sz);
      g.addColorStop(0,'#fff');g.addColorStop(.25,this.color);g.addColorStop(1,this.color+'33');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,sz,0,Math.PI*2);ctx.fill();
      if(this.type==='splitter'){ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=1.5;ctx.shadowBlur=6;const off=this.r*.55;ctx.beginPath();ctx.moveTo(this.x-off,this.y);ctx.lineTo(this.x+off,this.y);ctx.moveTo(this.x,this.y-off);ctx.lineTo(this.x,this.y+off);ctx.stroke();}
    }
    ctx.restore();
  }
}
function spawnEnemyRaw(type){
  const m=70,side=rndInt(0,3);let x,y;
  if(side===0){x=rnd(m,canvas.width-m);y=-m;}
  else if(side===1){x=canvas.width+m;y=rnd(m,canvas.height-m);}
  else if(side===2){x=rnd(m,canvas.width-m);y=canvas.height+m;}
  else{x=-m;y=rnd(m,canvas.height-m);}
  enemies.push(new Enemy(x,y,type,level));
}
function spawnEnemy(type){ if(enemies.length<MAX_ENEMIES) spawnEnemyRaw(type); }

// â”€â”€ POWERUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PU_TYPES=['shield','speed','slow','double'];
const PU_COLORS={shield:'#00ffff',speed:'#ffbe00',slow:'#aa00ff',double:'#ff6600'};
const PU_ICONS={shield:'â¬¡',speed:'âš¡',slow:'â±',double:'Ã—2'};
function spawnPowerup(x,y){
  const type=PU_TYPES[rndInt(0,3)];
  powerups.push({x,y,type,life:9,maxLife:9,pulseT:rnd(0,Math.PI*2)});
}
function updatePowerups(dt){
  const puPull=getBuffVal('puPullMult',1);
  for(let i=powerups.length-1;i>=0;i--){
    const p=powerups[i]; p.pulseT+=dt*3;p.life-=dt;
    if(p.life<=0){powerups.splice(i,1);continue;}
    const d=dist(p,player);
    if(d<80*puPull){const n=normalize(player.x-p.x,player.y-p.y);p.x+=n.x*120*dt;p.y+=n.y*120*dt;}
    if(d<player.r+16){
      activatePowerup(p.type);spawnBurst(p.x,p.y,14,PU_COLORS[p.type],160,5);
      spawnFloater(p.x,p.y-20,p.type.toUpperCase()+'!',PU_COLORS[p.type]);SFX.powerup();
      powerups.splice(i,1);
    }
  }
}
function activatePowerup(type){
  const durMul=getBuffVal('puDurMult',1);
  if(type==='shield'){shielded=true;shieldTimer=8*durMul;}
  else if(type==='speed'){speedBoostAct=true;speedBoostTimer=6*durMul;}
  else if(type==='slow'){timeSlow=true;timeSlowTimer=5*durMul;}
  else if(type==='double'){doubleScore=true;doubleScoreTimer=10*durMul;}
}
function drawPowerups(){
  powerups.forEach(p=>{
    const pulse=Math.sin(p.pulseT)*3,t=p.life/p.maxLife;
    const flicker=t<.25?(Math.sin(p.pulseT*8)*.5+.5):1;
    ctx.save();ctx.globalAlpha=flicker;ctx.shadowColor=PU_COLORS[p.type];ctx.shadowBlur=16+pulse;
    ctx.strokeStyle=PU_COLORS[p.type];ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(p.x,p.y,14+pulse,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle=PU_COLORS[p.type]+'88';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(p.x,p.y,9,p.pulseT,p.pulseT+Math.PI*.75);ctx.stroke();
    ctx.fillStyle=PU_COLORS[p.type]+'22';ctx.beginPath();ctx.arc(p.x,p.y,13,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=PU_COLORS[p.type];ctx.font='bold 13px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(PU_ICONS[p.type],p.x,p.y);ctx.restore();
  });
}

// â”€â”€ WAVE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSpawnQueue(){
  const pool=[];const n=Math.min(4+level*2,18);
  for(let i=0;i<n;i++){
    const r=Math.random();
    if(level>=3&&r<.18) pool.push('splitter');
    else if(level>=2&&r<.38) pool.push('rusher');
    else if(r<.62) pool.push('orbiter');
    else pool.push('chaser');
  }
  return pool;
}
function updateWaves(dt){
  waveTimer-=dt;
  if(waveTimer<=0){
    if(spawnQueue.length>0){
      spawnEnemy(spawnQueue.shift());
      waveTimer=Math.max(.28,1.1-level*.06);
    }else{spawnQueue=buildSpawnQueue();waveTimer=2.2;}
  }
  if(levelKills>=8+level*5){
    levelKills=0;level++;spawnQueue=[];waveTimer=3;shakeAmt=Math.max(shakeAmt,6);SFX.levelUp();
    state.maxLevel=Math.max(state.maxLevel||0,level);
    showLevelBanner();
    if(level%5===0&&!bossActive){bossActive=true;showBossWarning();}
    // Difficulty beat tracking (reached level 5+)
    if(level>=5){
      const diffId=DIFFICULTIES[selectedDiff].id;
      if(!state.diffBeaten) state.diffBeaten={};
      if(['easy','medium'].includes(diffId)||state.diffBeaten[diffId]===undefined) state.diffBeaten[diffId]=true;
    }
    checkAchievements();save();
  }
}
function showLevelBanner(){
  const el=document.getElementById('levelBanner');
  el.textContent=`â€” LEVEL ${level} â€”`;el.style.display='block';levelBannerTimer=2.2;
}
function showBossWarning(){
  const el=document.getElementById('bossWarning');
  el.style.display='block';bossWarningTimer=2.2;SFX.bossSpawn();
  setTimeout(()=>{if(running&&!gameOver){spawnEnemyRaw('boss');spawnBurst(canvas.width/2,60,20,'#ff0066',250,8);}},2200);
}

// â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBackground(){
  ctx.fillStyle='#030310';ctx.fillRect(0,0,canvas.width,canvas.height);
  drawGrid(80,bgTime*5,'rgba(0,80,200,.04)');
  drawGrid(45,bgTime*12,'rgba(0,180,255,.05)');
  const vx=canvas.width/2,vy=canvas.height/2;
  const vig=ctx.createRadialGradient(vx,vy,Math.min(vx,vy)*.4,vx,vy,Math.max(vx,vy));
  vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(1,'rgba(0,0,10,.6)');
  ctx.fillStyle=vig;ctx.fillRect(0,0,canvas.width,canvas.height);
}
function drawGrid(size,offset,color){
  ctx.save();ctx.strokeStyle=color;ctx.lineWidth=1;const ox=offset%size;
  for(let x=-size+ox;x<canvas.width+size;x+=size){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=-size+ox;y<canvas.height+size;y+=size){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.restore();
}

// â”€â”€ GAME HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _lastScore=-1,_lastHp=-1,_lastSt=-1;
function updateGameHUD(){
  const hp=Math.max(0,player.hp),st=player.stamina;
  if(Math.abs(hp-_lastHp)>.5){document.getElementById('healthFill').style.width=(hp/player.maxHp*100)+'%';_lastHp=hp;}
  if(Math.abs(st-_lastSt)>.5){document.getElementById('staminaFill').style.width=(st/player.maxStamina*100)+'%';_lastSt=st;}
  if(score!==_lastScore){document.getElementById('scoreDisplay').textContent=score.toLocaleString();document.getElementById('hiDisplay').textContent='HI: '+Math.max(score,hiScore).toLocaleString();_lastScore=score;}
  document.getElementById('levelDisplay').textContent='LEVEL '+level;
  document.getElementById('comboDisplay').textContent=combo>1?`COMBO Ã—${combo}`:'';
  const pp=[];
  if(shielded) pp.push(`SHIELD ${Math.ceil(shieldTimer)}s`);
  if(speedBoostAct) pp.push(`SPEED ${Math.ceil(speedBoostTimer)}s`);
  if(timeSlow) pp.push(`SLOW ${Math.ceil(timeSlowTimer)}s`);
  if(doubleScore) pp.push(`Ã—2 ${Math.ceil(doubleScoreTimer)}s`);
  document.getElementById('powerupDisplay').textContent=pp.join(' Â· ');

  const db=document.getElementById('diffBadgeHUD');
  const d=DIFFICULTIES[selectedDiff];
  db.textContent=d.label;db.className=`diff-${d.id}`;
}

// â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gameLoop(ts){
  raf=requestAnimationFrame(gameLoop);
  const rawDt=Math.min((ts-lastTime)/1000,.055);lastTime=ts;bgTime+=rawDt;
  timeScale=lerp(timeScale,timeScaleTarget,rawDt*6);
  if(bossSlowTimer>0){bossSlowTimer-=rawDt;if(bossSlowTimer<=0){timeScaleTarget=1;bossSlowTimer=0;}}
  if(paused||gameOver){drawSceneRaw();return;}
  const dt=rawDt*timeScale;
  shakeAmt*=.82;if(shakeAmt<.3) shakeAmt=0;
  if(shielded){shieldTimer-=dt;if(shieldTimer<=0) shielded=false;}
  if(speedBoostAct){speedBoostTimer-=dt;if(speedBoostTimer<=0) speedBoostAct=false;}
  if(timeSlow){timeSlowTimer-=dt;if(timeSlowTimer<=0) timeSlow=false;}
  if(doubleScore){doubleScoreTimer-=dt;if(doubleScoreTimer<=0) doubleScore=false;}
  if(combo>0){comboTimer-=dt;if(comboTimer<=0){combo=0;comboTimer=0;}}
  if(levelBannerTimer>0){levelBannerTimer-=rawDt;if(levelBannerTimer<=0) document.getElementById('levelBanner').style.display='none';}
  if(bossWarningTimer>0){bossWarningTimer-=rawDt;if(bossWarningTimer<=0) document.getElementById('bossWarning').style.display='none';}
  // Void God auto slow
  if(getBuffVal('autoTimeSlow',false)&&!timeSlow){
    voidGodCd=(voidGodCd||0)+dt;
    if(voidGodCd>=10){voidGodCd=0;timeSlow=true;timeSlowTimer=3;spawnBurst(player.x,player.y,12,'#9900ff',100,4);}
  }
  player.update(dt);updateWaves(dt);
  for(let i=enemies.length-1;i>=0;i--){if(enemies[i].dead){enemies.splice(i,1);continue;}enemies[i].update(dt);}
  updatePowerups(dt);updateParticles(dt);updateFloaters(dt);
  if(player.dashing){
    const extraR=player.dashRadius;
    for(let e of enemies){if(!e.dead&&dist(player,e)<player.r+e.r+8+extraR) e.hit(player.dashDamage);}
  }
  drawSceneRaw();updateGameHUD();
}

function drawSceneRaw(){
  const cx=canvas.width/2,cy=canvas.height/2;
  ctx.save();
  if(shakeAmt>.5) ctx.translate(rnd(-shakeAmt,shakeAmt)*.7,rnd(-shakeAmt,shakeAmt)*.7);
  drawBackground();drawParticles();drawPowerups();
  enemies.forEach(e=>e.draw());player.draw();drawFloaters();
  if(timeSlow||bossSlowTimer>0){
    const a=timeSlow?.07:(bossSlowTimer/1.8)*.12;
    ctx.fillStyle=`rgba(80,0,160,${a})`;ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  ctx.restore();
}

// â”€â”€ GAME FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  ensureAudio();
  computeActiveBuff();
  score=0;combo=0;maxCombo=0;comboTimer=0;
  level=1;levelKills=0;sessionKills=0;
  shakeAmt=0;bossActive=false;
  shielded=false;speedBoostAct=false;timeSlow=false;doubleScore=false;
  shieldTimer=0;speedBoostTimer=0;timeSlowTimer=0;doubleScoreTimer=0;
  timeScale=1;timeScaleTarget=1;bossSlowTimer=0;
  killSpeedBonus=state.killSpeedBonus||0;voidGodCd=0;
  enemies.length=0;particles.length=0;floaters.length=0;powerups.length=0;
  spawnQueue=[];waveTimer=2;gameOver=false;paused=false;
  _lastScore=-1;_lastHp=-1;_lastSt=-1;
  document.getElementById('levelBanner').style.display='none';
  document.getElementById('bossWarning').style.display='none';
  // Track stats
  state.gamesPlayed=(state.gamesPlayed||0)+1;
  if(state.equippedAura) state.gamesWithAura=(state.gamesWithAura||0)+1;
  const eqAura=state.equippedAura?[...AURAS,SECRET_AURA].find(a=>a.name===state.equippedAura):null;
  if(eqAura&&eqAura.rarity==='Mythic') state.gamesWithMythicAura=(state.gamesWithMythicAura||0)+1;
  // Genesis aura: start with shield
  if(getBuffVal('startShield',false)&&!genesisShieldUsed){shielded=true;shieldTimer=8;genesisShieldUsed=true;}
  player.init();updateEquippedPanel();
  ['lobbyScreen','pauseScreen','gameOverScreen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('gameHUD').style.display='flex';
  running=true;
  if(raf) cancelAnimationFrame(raf);
  lastTime=performance.now();raf=requestAnimationFrame(gameLoop);
  checkAchievements();save();
}

function endGame(){
  if(gameOver) return;
  gameOver=true;player.hp=0;SFX.gameOver();
  if(navigator.vibrate) navigator.vibrate([50,30,100,30,50]);
  const newHi=score>hiScore;
  if(newHi){hiScore=score;try{localStorage.setItem('neonSurgeHiV2',hiScore);}catch(e){}}
  state.bestScore=Math.max(state.bestScore||0,score);
  state.maxComboCombat=Math.max(state.maxComboCombat||0,maxCombo);
  document.getElementById('newHiMsg').className=newHi?'show':'';
  document.getElementById('overScore').textContent=score.toLocaleString();
  document.getElementById('overDiff').textContent=DIFFICULTIES[selectedDiff].name;
  document.getElementById('overLevel').textContent=level;
  document.getElementById('overCombo').textContent=maxCombo;
  document.getElementById('overKills').textContent=sessionKills;
  const eqAura=state.equippedAura?[...AURAS,SECRET_AURA].find(a=>a.name===state.equippedAura):null;
  document.getElementById('overAura').textContent=eqAura?`${eqAura.emoji} ${eqAura.name}`:'None';
  document.getElementById('gameHUD').style.display='none';
  document.getElementById('gameOverScreen').classList.remove('hidden');
  spawnBurst(canvas.width/2,canvas.height/2,35,'#ff2d55',320,8);
  spawnBurst(canvas.width/2,canvas.height/2,15,'#ff8800',200,5);
  checkAchievements();save();
}

function togglePause(){
  if(gameOver||!running) return;
  ensureAudio();paused=!paused;SFX.select?.();
  document.getElementById('pauseScreen').classList.toggle('hidden',!paused);
}

function goToLobby(){
  if(raf){cancelAnimationFrame(raf);raf=null;}
  running=false;paused=false;gameOver=false;
  enemies.length=0;particles.length=0;floaters.length=0;powerups.length=0;
  document.getElementById('gameHUD').style.display='none';
  document.getElementById('pauseScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('lobbyScreen').classList.remove('hidden');
  updateLobbyUI();save();
  // Start idle canvas loop
  lastTime=performance.now();raf=requestAnimationFrame(idleLoop);
}

// â”€â”€ IDLE LOOP (lobby background) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function idleLoop(ts){
  if(running){raf=requestAnimationFrame(gameLoop);return;}
  raf=requestAnimationFrame(idleLoop);
  const dt=Math.min((ts-lastTime)/1000,.05);lastTime=ts;bgTime+=dt;
  updateParticles(dt);
  drawBackground();drawParticles();
  if(Math.random()<.12){
    const colors=['#00d4ff','#ff00aa','#a855f7','#ffbe00','#ff6600'];
    spawnParticle(rnd(0,canvas.width),rnd(0,canvas.height),{vx:rnd(-12,12),vy:rnd(-12,12),life:rnd(1.5,3),size:rnd(1,3.5),color:colors[rndInt(0,4)],glow:true});
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER SHAPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER_SHAPES = [
  {id:'circle',    name:'Circle',   icon:'â¬¤',  draw(ctx,x,y,r,col,grad){ ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=grad;ctx.fill(); }},
  {id:'square',    name:'Square',   icon:'â¬›',  draw(ctx,x,y,r,col,grad){ const s=r*1.55;ctx.fillStyle=grad;ctx.fillRect(x-s/2,y-s/2,s,s); }},
  {id:'triangle',  name:'Triangle', icon:'ğŸ”º',  draw(ctx,x,y,r,col,grad){
    ctx.beginPath();ctx.moveTo(x,y-r*1.3);ctx.lineTo(x+r*1.15,y+r*.85);ctx.lineTo(x-r*1.15,y+r*.85);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }},
  {id:'diamond',   name:'Diamond',  icon:'ğŸ’ ',  draw(ctx,x,y,r,col,grad){
    ctx.beginPath();ctx.moveTo(x,y-r*1.35);ctx.lineTo(x+r*1.0,y);ctx.lineTo(x,y+r*1.35);ctx.lineTo(x-r*1.0,y);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }},
  {id:'star',      name:'Star',     icon:'â­', draw(ctx,x,y,r,col,grad){
    ctx.beginPath();for(let i=0;i<10;i++){const ang=i*Math.PI/5-Math.PI/2;const rr=i%2===0?r*1.3:r*.55;ctx.lineTo(x+Math.cos(ang)*rr,y+Math.sin(ang)*rr);}ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }},
  {id:'hexagon',   name:'Hex',      icon:'â¬¡',  draw(ctx,x,y,r,col,grad){
    ctx.beginPath();for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/6;ctx.lineTo(x+Math.cos(a)*r*1.2,y+Math.sin(a)*r*1.2);}ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }},
  {id:'cross',     name:'Cross',    icon:'âœš',  draw(ctx,x,y,r,col,grad){
    const t=r*.38,l=r*1.2;ctx.fillStyle=grad;ctx.fillRect(x-l,y-t,l*2,t*2);ctx.fillRect(x-t,y-l,t*2,l*2);
  }},
  {id:'arrow',     name:'Arrow',    icon:'â–¶',  draw(ctx,x,y,r,col,grad){
    ctx.beginPath();ctx.moveTo(x+r*1.2,y);ctx.lineTo(x-r*.7,y-r*1.1);ctx.lineTo(x-r*.3,y);ctx.lineTo(x-r*.7,y+r*1.1);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }},
];
let selectedShape = 0; // index into PLAYER_SHAPES

function buildShapeGrid(){
  const g=document.getElementById('shapeGrid'); if(!g) return;
  g.innerHTML='';
  PLAYER_SHAPES.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className='shape-card'+(i===selectedShape?' selected':'');
    d.innerHTML=`<div class="shape-preview">${s.icon}</div><div class="shape-name">${s.name}</div>`;
    const pick=()=>{ selectedShape=i; buildShapeGrid(); SFX.select(); };
    d.onclick=pick;
    d.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();pick();},{passive:false});
    g.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND MUSIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bgMusicEnabled=true, bgMusicNodes=null, bgMusicPlaying=false;

function buildBgMusic(){
  if(!audioCtx) return;
  stopBgMusic();
  try{
    const ac=audioCtx;
    const master=ac.createGain(); master.gain.value=.07; master.connect(ac.destination);
    const nodes=[];
    // Pad chord (slow evolving)
    const CHORD=[110,138.6,165,220]; // A2 C#3 E3 A3
    CHORD.forEach((freq,i)=>{
      const osc=ac.createOscillator(), g=ac.createGain();
      osc.type='sine'; osc.frequency.value=freq;
      g.gain.value=.3/(i+1);
      osc.connect(g); g.connect(master);
      osc.start(); nodes.push(osc,g);
    });
    // Subtle arpeggio using ScriptProcessorNode-free approach via periodic tone scheduling
    let arpRunning=true;
    const ARP=[220,277.2,329.6,440,554.4];
    let arpIdx=0;
    function scheduleArp(){
      if(!arpRunning||!bgMusicEnabled) return;
      const osc2=ac.createOscillator(), g2=ac.createGain();
      osc2.type='triangle'; osc2.frequency.value=ARP[arpIdx%ARP.length]; arpIdx++;
      g2.gain.setValueAtTime(.05,ac.currentTime);
      g2.gain.exponentialRampToValueAtTime(.0001,ac.currentTime+.45);
      osc2.connect(g2); g2.connect(master);
      osc2.start(ac.currentTime); osc2.stop(ac.currentTime+.5);
      nodes.push(osc2,g2);
    }
    const arpTimer=setInterval(()=>{
      if(!bgMusicEnabled||!bgMusicPlaying){clearInterval(arpTimer);return;}
      scheduleArp();
      // Prune dead nodes
      for(let i=nodes.length-1;i>=0;i--){const n=nodes[i]; if(n.stop===undefined) continue;}
    },480);
    bgMusicNodes={nodes,master,arpTimer,arpRunning:()=>arpRunning,stopArp:()=>{arpRunning=false;clearInterval(arpTimer);}};
    bgMusicPlaying=true;
  }catch(e){ console.warn('bgMusic error',e); }
}

function stopBgMusic(){
  if(!bgMusicNodes) return;
  try{
    bgMusicNodes.stopArp();
    bgMusicNodes.nodes.forEach(n=>{ try{n.stop?.();n.disconnect?.();}catch(e){} });
    bgMusicNodes.master.disconnect();
  }catch(e){}
  bgMusicNodes=null; bgMusicPlaying=false;
}

function toggleBgMusic(){
  bgMusicEnabled=!bgMusicEnabled;
  document.getElementById('musicBtn').textContent=`ğŸµ Music: ${bgMusicEnabled?'ON':'OFF'}`;
  if(bgMusicEnabled){ ensureAudio(); buildBgMusic(); }
  else stopBgMusic();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANDOM FUSE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRandomFuseSelectors(){
  const selA=document.getElementById('fuseA'), selB=document.getElementById('fuseB');
  if(!selA||!selB) return;
  const allAuras=[...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)];
  const collected=allAuras.filter(a=>(state.collection[a.name]||0)+(state.fusionCollection?.[a.name]||0)>=2);
  // Build selects
  [selA,selB].forEach((sel,idx)=>{
    sel.innerHTML=`<option value="">â€” Aura ${idx===0?'A':'B'} â€”</option>`;
    collected.forEach(a=>{ const o=document.createElement('option'); o.value=a.name; o.textContent=`${a.emoji} ${a.name} (Ã—${(state.collection[a.name]||0)+(state.fusionCollection?.[a.name]||0)})`; sel.appendChild(o); });
  });
}

function doRandomFuse(){
  const selA=document.getElementById('fuseA')?.value;
  const selB=document.getElementById('fuseB')?.value;
  const resEl=document.getElementById('randomFuseResult');
  if(!selA||!selB){ resEl.textContent='âš  Select 2 auras to fuse!'; return; }
  if(selA===selB){ resEl.textContent='âš  Pick 2 different auras!'; return; }
  // Check counts
  const cntA=(state.collection[selA]||0)+(state.fusionCollection?.[selA]||0);
  const cntB=(state.collection[selB]||0)+(state.fusionCollection?.[selB]||0);
  if(cntA<2||cntB<2){ resEl.textContent='âš  Need Ã—2 of each aura!'; return; }
  // Deduct one of each
  if(state.collection[selA]>=1) state.collection[selA]--;
  else if(state.fusionCollection?.[selA]>=1) state.fusionCollection[selA]--;
  if(state.collection[selB]>=1) state.collection[selB]--;
  else if(state.fusionCollection?.[selB]>=1) state.fusionCollection[selB]--;
  // Pick a random result aura of higher-ish rarity
  const allAuras=[...AURAS,SECRET_AURA];
  const eligible=allAuras.filter(a=>rarityRank(a.rarity)>=1); // Uncommon+
  const result=eligible[Math.floor(Math.random()*eligible.length)];
  // Give it
  if(!state.collection[result.name]) state.collection[result.name]=0;
  state.collection[result.name]++;
  resEl.innerHTML=`âœ¨ Result: ${result.emoji} <strong style="color:${result.color}">${result.name}</strong> [${result.rarity}]!`;
  SFX.auraRoll(result.rarity);
  showToast(`ğŸ² Fused â†’ ${result.emoji} ${result.name}!`);
  state.fusions=(state.fusions||0)+1;
  checkAchievements(); save(); buildCollection(); buildRandomFuseSelectors();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY SKILL UPGRADES (stronger enemies with abilities)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Injected into enemy update/die â€” handled in the existing enemy class extensions
// Enemy enrageLevel increases as player level rises
function getEnemyEnrage(){ return Math.floor(level/4); } // 0=normal,1=enraged,2=berserk

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AURA VISUAL EFFECT ON PLAYER (enhanced draw)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Replaces player.draw â€” patched after player definition
const _origPlayerDraw = player.draw.bind(player);
player.draw = function(){
  const eqAura = state.equippedAura ? [...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)].find(a=>a.name===state.equippedAura) : null;
  const pulse = Math.sin(this.pulseT)*2.5;

  // Trail
  for(let i=0;i<this.trail.length;i++){
    const t=1-(i/this.trail.length);
    const tc=eqAura&&eqAura.color!=='rainbow'?eqAura.color:'#00d4ff';
    ctx.save();ctx.globalAlpha=t*.18;ctx.shadowColor=tc;ctx.shadowBlur=10;
    ctx.fillStyle=tc;
    PLAYER_SHAPES[selectedShape].draw(ctx,this.trail[i].x,this.trail[i].y,this.r*(.5+t*.5),tc,tc);
    ctx.restore();
  }

  if(this.invincible>0&&Math.floor(this.invincible*12)%2===0) return;

  ctx.save();

  // Shield ring
  if(shielded){
    ctx.strokeStyle='#00ffff';ctx.lineWidth=2.5;ctx.shadowColor='#00ffff';ctx.shadowBlur=25;
    ctx.globalAlpha=.55+Math.sin(this.pulseT*2)*.3;
    ctx.beginPath();ctx.arc(this.x,this.y,this.r+14+pulse*.5,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=.3;ctx.beginPath();ctx.arc(this.x,this.y,this.r+11,this.pulseT,this.pulseT+Math.PI*.7);ctx.stroke();
    ctx.globalAlpha=1;
  }

  // Hit flash
  if(this.hitFlash>0){
    ctx.globalAlpha=this.hitFlash*.8;ctx.fillStyle='#ff2d55';ctx.shadowColor='#ff2d55';ctx.shadowBlur=30;
    ctx.beginPath();ctx.arc(this.x,this.y,this.r+8,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  }

  // â”€â”€ AURA VISUAL EFFECT â”€â”€
  if(eqAura){
    const ac = eqAura.color==='rainbow'
      ? `hsl(${(Date.now()/20)%360},100%,65%)`
      : eqAura.color;

    // Outer spinning aura ring
    ctx.save();
    ctx.strokeStyle=ac; ctx.lineWidth=2;
    ctx.shadowColor=ac; ctx.shadowBlur=18;
    ctx.globalAlpha=.5+Math.sin(this.pulseT*1.5)*.3;
    ctx.translate(this.x,this.y);
    ctx.rotate(this.pulseT*.4);
    // Dashed orbit ring
    const dashes=eqAura.rarity==='Mythic'?12:eqAura.rarity==='Legendary'?8:6;
    const orbR=this.r+18+pulse*.6;
    ctx.beginPath();
    for(let i=0;i<dashes;i++){
      const a1=(i/dashes)*Math.PI*2;
      const a2=((i+.5)/dashes)*Math.PI*2;
      ctx.arc(0,0,orbR,a1,a2);
    }
    ctx.stroke();
    ctx.restore();

    // Inner glow fill tint
    const rarityGlowStrength={Common:.12,Uncommon:.18,Rare:.24,Epic:.3,Legendary:.4,Mythic:.55,SECRET:.7};
    const gs=rarityGlowStrength[eqAura.rarity]||.2;
    ctx.globalAlpha=gs;
    ctx.fillStyle=ac;
    ctx.shadowColor=ac; ctx.shadowBlur=24+pulse*2;
    ctx.beginPath();ctx.arc(this.x,this.y,this.r+4,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;

    // Floating aura particles around player
    if(Math.random()<.18){
      const ang=Math.random()*Math.PI*2;
      const pr=this.r+10+Math.random()*14;
      spawnParticle(this.x+Math.cos(ang)*pr, this.y+Math.sin(ang)*pr, {
        vx:Math.cos(ang)*rnd(20,60),vy:Math.sin(ang)*rnd(20,60),
        life:rnd(.3,.7),size:rnd(1.5,4),color:ac,glow:true
      });
    }
  }

  // â”€â”€ MAIN PLAYER BODY using selected shape â”€â”€
  ctx.shadowColor=eqAura&&eqAura.color!=='rainbow'?eqAura.color:'#00d4ff';
  ctx.shadowBlur=20+pulse;
  const bodyCol0=eqAura&&eqAura.color!=='rainbow'?eqAura.color:'#ffffff';
  const bodyCol1=eqAura&&eqAura.color!=='rainbow'?eqAura.color+'88':'#00d4ff';
  const bodyCol2=eqAura&&eqAura.color!=='rainbow'?eqAura.color+'22':'#0033ff';
  const grad=ctx.createRadialGradient(this.x-this.r*.3,this.y-this.r*.3,0,this.x,this.y,this.r*1.3);
  grad.addColorStop(0,'#ffffff');
  grad.addColorStop(.35,bodyCol1);
  grad.addColorStop(1,bodyCol2);

  PLAYER_SHAPES[selectedShape].draw(ctx,this.x,this.y,this.r,bodyCol1,grad);

  // Specular highlight dot
  ctx.shadowBlur=4;ctx.fillStyle='#fff';ctx.globalAlpha=.85;
  ctx.beginPath();ctx.arc(this.x-this.r*.28,this.y-this.r*.28,this.r*.28,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;
  ctx.restore();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED DASH EFFECTS (shing sound + afterimages)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Override SFX.dash with a proper shing
SFX.dash = function(){
  if(!soundEnabled||!audioCtx) return;
  // Metallic "shing": fast freq sweep + high noise burst
  playTone({type:'square',freq:180,freq2:1200,duration:.08,vol:.12,attack:.002,decay:.08});
  playTone({type:'sine',freq:900,freq2:3200,duration:.12,vol:.18,attack:.003,decay:.11});
  playNoise(.06,.15,'highpass',3500);
};

// Dash afterimage burst â€” called from player update, we patch it
const _origPlayerUpdate = player.update.bind(player);
player.update = function(dt){
  const wasDashing = this.dashing;
  const wasX=this.x, wasY=this.y;
  _origPlayerUpdate(dt);
  const eqAura = state.equippedAura ? [...AURAS,SECRET_AURA,...FUSIONS.map(f=>f.reward)].find(a=>a.name===state.equippedAura) : null;
  const dashColor = eqAura&&eqAura.color!=='rainbow'?eqAura.color:'#00d4ff';

  // Dash started â€” spawn big burst + screen flash
  if(!wasDashing && this.dashing){
    spawnBurst(this.x,this.y,18,dashColor,200,6);
    // Afterimage ring
    for(let i=0;i<6;i++){
      const ang=(i/6)*Math.PI*2;
      spawnParticle(this.x+Math.cos(ang)*(this.r+10),this.y+Math.sin(ang)*(this.r+10),{
        vx:Math.cos(ang)*rnd(80,180),vy:Math.sin(ang)*rnd(80,180),
        life:rnd(.2,.5),size:rnd(3,7),color:dashColor,glow:true
      });
    }
  }

  // Dash ongoing â€” extra trail
  if(this.dashing){
    if(Math.random()<.5){
      spawnParticle(this.x+rnd(-8,8),this.y+rnd(-8,8),{
        vx:rnd(-60,60),vy:rnd(-60,60),
        life:rnd(.15,.35),size:rnd(2,6),color:dashColor,glow:true
      });
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRONGER ENEMIES: ENRAGE SKILLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Patch Enemy.update to add enrage abilities at high levels
const _EnemyClass = Enemy; // reference
const origEnemyUpdate = Enemy.prototype.update;
Enemy.prototype.update = function(dt){
  origEnemyUpdate.call(this,dt);
  const enrage=getEnemyEnrage();
  if(enrage<=0) return;

  // Level 4+: chasers periodically shoot projectile pulses (visual only, handled via particles)
  if(this.type==='chaser' && enrage>=1){
    this._shotCd=(this._shotCd||rnd(3,5))-dt;
    if(this._shotCd<=0){
      this._shotCd=rnd(2.5,4)/enrage;
      const n=normalize(player.x-this.x,player.y-this.y);
      // Spawn a fast moving danger particle heading toward player
      const px=this.x+n.x*this.r, py=this.y+n.y*this.r;
      spawnParticle(px,py,{vx:n.x*280,vy:n.y*280,life:.55,size:5,color:'#ff2d55',glow:true,
        onTick:(p,dt2)=>{
          if(!p._checked){
            const d2=Math.hypot(p.x-player.x,p.y-player.y);
            if(d2<player.r+6){player.takeDamage(8);p.life=0;}
          }
        }
      });
    }
  }

  // Level 8+: orbiters split into 2 mini orbiters on death (handled via die patch)
  // Level 12+: rushers gain a spiral charge pattern
  if(this.type==='rusher' && enrage>=3 && this.rushing){
    // Spiral trail
    if(Math.random()<.4){
      const perpX=-this.rushDy||rnd(-1,1), perpY=this.rushDx||rnd(-1,1);
      spawnParticle(this.x+perpX*20*Math.sin(this.age*8),this.y+perpY*20*Math.sin(this.age*8),{
        vx:rnd(-40,40),vy:rnd(-40,40),life:.4,size:4,color:'#cc00ff',glow:true
      });
    }
  }
};

// Enhance Enemy.die for enraged splits
const origEnemyDie = Enemy.prototype.die;
Enemy.prototype.die = function(){
  const enrage=getEnemyEnrage();
  // Level 8+: orbiters spawn mini orbiters
  if(this.type==='orbiter' && enrage>=2 && !this._wasSplit){
    for(let i=0;i<2;i++){
      if(enemies.length<MAX_ENEMIES){
        const c=new Enemy(this.x+rnd(-18,18),this.y+rnd(-18,18),'orbiter',level);
        c.r=6;c.hp=c.maxHp=10;c._wasSplit=true;enemies.push(c);
      }
    }
  }
  origEnemyDie.call(this);
};

// Patch particle update to support onTick
const origUpdateParticles = updateParticles;
// We need to wrap it â€” instead patch the particle loop in the existing fn
// (we'll do this by adding a hook in the particle array processing)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE LOBBY UI to include new elements
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origUpdateLobbyUI = updateLobbyUI;
updateLobbyUI = function(){
  _origUpdateLobbyUI();
  buildShapeGrid();
  buildRandomFuseSelectors();
};

// Start BG music on first user interaction
document.addEventListener('click',()=>{if(bgMusicEnabled&&!bgMusicPlaying){ensureAudio();buildBgMusic();}},{once:true});
document.addEventListener('touchend',()=>{if(bgMusicEnabled&&!bgMusicPlaying){ensureAudio();buildBgMusic();}},{once:true});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildDifficultyGrid();
buildShapeGrid();
buildCollection();
buildRandomFuseSelectors();
updateLobbyUI();
lastTime=performance.now();
raf=requestAnimationFrame(idleLoop);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTRO SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initIntro(){
  const intro = document.getElementById('introScreen');
  const wrap = document.getElementById('introParticles');
  // Spawn floating sparks
  const SPARK_COLORS = ['#00d4ff','#ff00aa','#a855f7','#ffd700','#ff6600','#4dff91'];
  for(let i=0;i<28;i++){
    const s = document.createElement('div');
    s.className = 'intro-spark';
    const sz = 2 + Math.random()*5;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${60+Math.random()*40}%;background:${SPARK_COLORS[Math.floor(Math.random()*SPARK_COLORS.length)]};box-shadow:0 0 ${sz*2}px currentColor;animation-duration:${2+Math.random()*4}s;animation-delay:${Math.random()*3}s;`;
    wrap.appendChild(s);
  }
  // Tap to start
  let introGone = false;
  function dismissIntro(){
    if(introGone) return; introGone = true;
    ensureAudio();
    // Gentle sound rise
    if(audioCtx){
      try{
        const now = audioCtx.currentTime;
        [110,220,330,440,660,880].forEach((f,i)=>{
          const o=audioCtx.createOscillator(), g=audioCtx.createGain();
          o.type='sine'; o.frequency.value=f;
          g.gain.setValueAtTime(0,now+i*.06);
          g.gain.linearRampToValueAtTime(.08,now+i*.06+.08);
          g.gain.exponentialRampToValueAtTime(.0001,now+i*.06+.35);
          o.connect(g); g.connect(audioCtx.destination);
          o.start(now+i*.06); o.stop(now+i*.06+.4);
        });
      }catch(e){}
    }
    intro.classList.add('fade-out');
    setTimeout(()=>{ intro.style.display='none'; if(bgMusicEnabled&&!bgMusicPlaying){buildBgMusic();} }, 700);
  }
  intro.addEventListener('touchend', e=>{e.preventDefault(); dismissIntro();}, {passive:false});
  intro.addEventListener('click', dismissIntro);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN FLASH SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function screenFlash(color='#ffffff', alpha=0.35, duration=180){
  const el = document.getElementById('screenFlash');
  el.style.background = color.startsWith('#') ? hexToRgba(color, alpha) : color;
  el.style.opacity = '1';
  el.style.transition = 'none';
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      el.style.transition = `opacity ${duration}ms ease`;
      el.style.opacity = '0';
    });
  });
}
function hexToRgba(hex, a){
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MYTHIC SCREEN FLASH (colorful pulse)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerMythicFlash(){
  const el = document.getElementById('mythicFlash');
  let step=0;
  const colors=['#ff00cc','#7700ff','#00ffcc','#ff6600','#ffffff'];
  function nextFlash(){
    if(step>=6) return;
    el.style.background = `rgba(${step%2===0?'255,0,200':'100,0,255'},${.2+step*.03})`;
    el.style.opacity = '1';
    if(navigator.vibrate && step===0) navigator.vibrate([20,10,40]);
    setTimeout(()=>{
      el.style.transition='opacity .12s';
      el.style.opacity='0';
      step++;
      setTimeout(nextFlash, 110);
    }, 90);
  }
  el.style.transition='none';
  nextFlash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBO POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let comboPopTO = null;
function showComboPop(n){
  const el = document.getElementById('comboPop');
  const numEl = document.getElementById('comboPopNum');
  numEl.textContent = 'Ã—'+n;
  el.className = '';
  void el.offsetWidth;
  el.classList.add('show');
  clearTimeout(comboPopTO);
  comboPopTO = setTimeout(()=>el.classList.remove('show'), 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOATING ESSENCE NUMBERS (DOM-based, smooth)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnEssenceFloat(amount, x, y){
  const el = document.createElement('div');
  el.className = 'essence-float';
  el.textContent = '+' + amount + 'ğŸ’';
  el.style.left = (x||window.innerWidth/2) + 'px';
  el.style.top = (y||window.innerHeight/2) + 'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 950);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AURA LEVELING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAuraLevel(auraName){
  const cnt = (state.collection[auraName]||0) + (state.fusionCollection?.[auraName]||0);
  if(cnt >= 50) return 5;
  if(cnt >= 20) return 4;
  if(cnt >= 10) return 3;
  if(cnt >= 4)  return 2;
  if(cnt >= 1)  return 1;
  return 0;
}
function getAuraLevelBonus(auraName){
  const lvl = getAuraLevel(auraName);
  return { level: lvl, powerMult: 1 + lvl * 0.08, desc: `Lv.${lvl} (+${lvl*8}% power)` };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKILL UPGRADE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SKILL_UPGRADES = [
  { id:'health',  name:'Vitality',    icon:'â¤ï¸',  desc:'Increase max HP',              costs:[80,160,320,640],  maxLvl:4, effect:'bonusHp',    perLvl:10  },
  { id:'dashcd',  name:'Agility',     icon:'âš¡',  desc:'Reduce dash cooldown',         costs:[100,200,400,800], maxLvl:4, effect:'dashCdMult',  perLvl:-.06},
  { id:'luck',    name:'Fortune',     icon:'ğŸ€',  desc:'Permanent luck boost',         costs:[120,240,480,960], maxLvl:4, effect:'luckBonus',   perLvl:2   },
  { id:'essence', name:'Prosperity',  icon:'ğŸ’',  desc:'Earn more essence per game',   costs:[60,120,240,480],  maxLvl:4, effect:'essenceMult', perLvl:.08 },
];

function getSkillLevel(id){ return (state.skillLevels && state.skillLevels[id]) || 0; }
function getSkillBonus(effect){
  let total = 0;
  SKILL_UPGRADES.forEach(s=>{
    if(s.effect===effect) total += getSkillLevel(s.id) * s.perLvl;
  });
  return total;
}

function openUpgradeMenu(){
  ensureAudio(); SFX.select();
  document.getElementById('upgradeEssenceVal').textContent = (state.essence||0).toLocaleString();
  buildUpgradeList();
  document.getElementById('upgradeModal').style.display = 'flex';
}
function closeUpgradeMenu(){
  document.getElementById('upgradeModal').style.display = 'none';
  SFX.select();
}
function buildUpgradeList(){
  const list = document.getElementById('upgradeList'); list.innerHTML = '';
  SKILL_UPGRADES.forEach(s=>{
    const lvl = getSkillLevel(s.id);
    const maxed = lvl >= s.maxLvl;
    const cost = maxed ? 0 : s.costs[lvl];
    const canBuy = !maxed && (state.essence||0) >= cost;
    const div = document.createElement('div'); div.className = 'upg-item';
    div.innerHTML = `
      <div class="upg-icon">${s.icon}</div>
      <div class="upg-info">
        <div class="upg-name">${s.name}</div>
        <div class="upg-desc">${s.desc}</div>
        <div class="upg-level">${maxed ? 'âœ… MAX LEVEL' : `Level ${lvl}/${s.maxLvl} â€” Next: ${s.perLvl>0?'+':''}${Math.round(s.perLvl*(lvl+1)*10)/10} ${s.effect==='essenceMult'?'x essence':s.effect==='dashCdMult'?'CD':s.effect==='luckBonus'?'% luck':'HP'}`}</div>
      </div>
      <button class="upg-btn${maxed?' maxed':''}" ${!canBuy?'disabled':''} data-sid="${s.id}">
        ${maxed ? 'âœ“ MAX' : `ğŸ’ ${cost}`}
      </button>`;
    if(canBuy){
      div.querySelector('button').onclick = ()=>{ buyUpgrade(s.id); SFX.equip(); };
    }
    list.appendChild(div);
  });
}
function buyUpgrade(id){
  const s = SKILL_UPGRADES.find(x=>x.id===id); if(!s) return;
  const lvl = getSkillLevel(id);
  if(lvl>=s.maxLvl) return;
  const cost = s.costs[lvl];
  if((state.essence||0) < cost){ showToast("âŒ Not enough Essence!"); return; }
  state.essence -= cost;
  if(!state.skillLevels) state.skillLevels = {};
  state.skillLevels[id] = (state.skillLevels[id]||0)+1;
  showToast(`âš¡ ${s.name} upgraded to Lv.${state.skillLevels[id]}!`);
  save(); updateLobbyUI();
  document.getElementById('upgradeEssenceVal').textContent = (state.essence||0).toLocaleString();
  buildUpgradeList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAPTIC HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Haptic = {
  light(){ if(navigator.vibrate) navigator.vibrate(8); },
  medium(){ if(navigator.vibrate) navigator.vibrate([15,5,15]); },
  heavy(){ if(navigator.vibrate) navigator.vibrate([30,10,60]); },
  boss(){ if(navigator.vibrate) navigator.vibrate([40,20,80,20,40]); },
  mythic(){ if(navigator.vibrate) navigator.vibrate([20,10,40,10,80,10,40]); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED AUDIO - more rarity sounds, boss warning
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Extend SFX with more sounds
Object.assign(SFX, {
  roll(){ playNoise(.04,.12,'highpass',4000); playTone({type:'sine',freq:200,freq2:800,duration:.15,vol:.15}); },
  mythicReveal(){
    // Multi-layered cosmic sound
    if(!audioCtx) return;
    try{
      const seq = [[220,.12],[440,.16],[880,.2],[1760,.28],[3520,.22]];
      seq.forEach(([f,v],i)=>{
        setTimeout(()=>{
          playTone({type:'sine',freq:f,freq2:f*1.5,duration:.4,vol:v,attack:.01,decay:.38});
          playNoise(.08,v*.4,'bandpass',f*2);
        },i*80);
      });
    }catch(e){}
  },
  legendaryReveal(){
    [440,660,880,1320].forEach((f,i)=>setTimeout(()=>playTone({type:'sine',freq:f,duration:.25,vol:.22}),i*60));
  },
  bossWarnSound(){
    if(!audioCtx) return;
    try{
      playTone({type:'sawtooth',freq:60,freq2:30,duration:1.2,vol:.4,attack:.1,decay:1.1});
      setTimeout(()=>playTone({type:'square',freq:120,freq2:80,duration:.8,vol:.25}),400);
      setTimeout(()=>playNoise(.3,.3,'lowpass',300),600);
    }catch(e){}
  },
  comboSound(n){
    const f = Math.min(880, 220 + n*30);
    playTone({type:'sine',freq:f,freq2:f*1.2,duration:.12,vol:.18});
  },
  dashEnhanced(){
    playTone({type:'square',freq:180,freq2:1200,duration:.08,vol:.14,attack:.002,decay:.08});
    playTone({type:'sine',freq:900,freq2:3200,duration:.12,vol:.2,attack:.003,decay:.11});
    playNoise(.06,.15,'highpass',3500);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED ROLL FUNCTION â€” hook into existing roll
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origRoll = typeof roll === 'function' ? roll : null;
// We patch the aura reveal after roll: override showRolledAuraResult
const _origShowResult = showRolledAuraResult;
showRolledAuraResult = function(aura, isNew, showParticles){
  _origShowResult(aura, isNew, showParticles);
  // Enhanced sounds per rarity
  if(isNew !== undefined){
    if(aura.rarity === 'Mythic' || aura.rarity === 'SECRET'){
      setTimeout(()=>{ SFX.mythicReveal(); triggerMythicFlash(); Haptic.mythic(); }, 100);
    } else if(aura.rarity === 'Legendary'){
      setTimeout(()=>{ SFX.legendaryReveal(); Haptic.heavy(); }, 80);
    } else if(aura.rarity === 'Epic'){
      setTimeout(()=>{ SFX.auraRoll('Epic'); Haptic.medium(); }, 60);
    }
  }
  // Show aura level badge
  const lvlInfo = getAuraLevelBonus(aura.name);
  if(lvlInfo.level > 1){
    const badge = document.getElementById('resBadge');
    if(badge) badge.innerHTML += ` <span class="aura-level-badge">Lv.${lvlInfo.level}</span>`;
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED BOSS WARNING â€” slow-mo + flash + haptic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origShowBossWarning = showBossWarning;
showBossWarning = function(){
  _origShowBossWarning();
  SFX.bossWarnSound();
  screenFlash('#ff0066', .25, 400);
  Haptic.boss();
  // Brief slow-mo effect
  timeScaleTarget = .35;
  setTimeout(()=>{ if(!bossSlowTimer) timeScaleTarget=1; }, 800);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED ENEMY HIT â€” hit-stop effect
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origEnemyHit = Enemy.prototype.hit;
Enemy.prototype.hit = function(dmg){
  const wasDead = this.dead;
  _origEnemyHit.call(this, dmg);
  if(!wasDead && !this.dead){
    // Hit-stop: brief canvas freeze feel via timeScale micro-dip
    timeScaleTarget = Math.min(timeScaleTarget, 0.05);
    setTimeout(()=>{ if(timeScaleTarget < 1) timeScaleTarget = 1; }, 45);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED COMBO DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origEnemyDie = Enemy.prototype.die;
Enemy.prototype.die = function(){
  const prevCombo = combo;
  _origEnemyDie.call(this);
  // Show combo popup at milestone combos
  if(combo >= 5 && combo % 5 === 0 && combo > prevCombo){
    showComboPop(combo);
    SFX.comboSound(combo);
    screenFlash('#ff00aa', .08, 200);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED DASH â€” better SFX + haptic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origTriggerDash = triggerDash;
triggerDash = function(){
  _origTriggerDash();
  Haptic.light();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLY SKILL BONUSES AT GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origComputeActiveBuff = computeActiveBuff;
computeActiveBuff = function(){
  _origComputeActiveBuff();
  // Apply skill bonuses into activeBuff
  const hp = Math.round(getSkillBonus('bonusHp') * 4); // 4 upgrades Ã— 10hp each
  const dashCd = getSkillBonus('dashCdMult');
  const luckBns = getSkillBonus('luckBonus');
  if(!activeBuff) activeBuff = {};
  activeBuff.bonusHp = (activeBuff.bonusHp||0) + hp;
  activeBuff.dashCdMult = (activeBuff.dashCdMult||1) * (1 + dashCd);
  // Apply luck bonus to state.luck
  if(luckBns > 0) state.luck = Math.min(100, (state.luck||0) + luckBns);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESSENCE FLOAT TRIGGER on essence gain
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Hook into claimDaily to show float
const _origClaimDaily = claimDaily;
claimDaily = function(){
  const prevEss = state.essence||0;
  _origClaimDaily();
  const gained = (state.essence||0) - prevEss;
  if(gained > 0){
    const btn = document.getElementById('dailyBtn');
    if(btn){ const r=btn.getBoundingClientRect(); spawnEssenceFloat(gained, r.left+r.width/2, r.top); }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLY ESSENCE SKILL MULTIPLIER ON GAME END
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origEndGame = endGame;
endGame = function(){
  _origEndGame();
  // Award bonus essence based on skill level
  const essBonus = getSkillBonus('essenceMult');
  if(essBonus > 0 && score > 0){
    const bonus = Math.floor(score / 1000 * (1 + essBonus));
    if(bonus > 0){
      state.essence = (state.essence||0) + bonus;
      save();
      spawnEssenceFloat(bonus, canvas.width/2, canvas.height/3);
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED JOYSTICK â€” deadzone + smooth lerp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function patchJoystick(){
  const DEADZONE = 0.08;
  const origGet = Object.getOwnPropertyDescriptor(input, 'joyX');
  // We directly apply deadzone by patching the touchmove handler
  joystickZone.removeEventListener('touchmove', joystickZone._moveFn);
  joystickZone.addEventListener('touchmove', e=>{
    e.preventDefault();
    for(let t of e.changedTouches){
      if(t.identifier !== joyId) continue;
      const r = joystickZone.getBoundingClientRect();
      let dx=(t.clientX-r.left)-joyOriginX, dy=(t.clientY-r.top)-joyOriginY;
      const d=Math.hypot(dx,dy);
      if(d > JOY_R){dx=dx/d*JOY_R;dy=dy/d*JOY_R;}
      const nx=dx/JOY_R, ny=dy/JOY_R;
      // Apply deadzone
      const mag=Math.hypot(nx,ny);
      if(mag<DEADZONE){input.joyX=0;input.joyY=0;}
      else{ const scale=(mag-DEADZONE)/(1-DEADZONE)/mag; input.joyX=nx*scale; input.joyY=ny*scale; }
      joystickKnob.style.left=(joyOriginX+dx-25)+'px';
      joystickKnob.style.top=(joyOriginY+dy-25)+'px';
    }
  },{passive:false});
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” PREVENT SCROLL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('touchmove', e=>{
  // Allow scroll only in scrollable overlay screens
  let el = e.target;
  while(el){
    if(el.classList && (el.classList.contains('screen') || el.classList.contains('upgrade-inner') || el.id==='shopModal')){ return; }
    el = el.parentElement;
  }
  e.preventDefault();
},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLECTION â€” show aura level badge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origBuildCollection = buildCollection;
buildCollection = function(){
  _origBuildCollection();
  // Add level badges to unlocked collection items
  const allAuras=[...AURAS,SECRET_AURA];
  allAuras.forEach(a=>{
    const div = document.getElementById(`col-${a.name.replace(/[^a-zA-Z0-9]/g,'_')}`);
    if(!div || !div.classList.contains('unlocked')) return;
    const lvl = getAuraLevel(a.name);
    if(lvl>1){
      const badge = document.createElement('span');
      badge.className = 'aura-level-badge';
      badge.textContent = 'Lv.'+lvl;
      badge.style.cssText = 'display:block;margin:2px auto 0;';
      div.appendChild(badge);
    }
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENSURE STATE has skillLevels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(!state.skillLevels) state.skillLevels = {};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('[PWA] SW registered:', reg.scope);
      // If there's a new SW waiting, auto-update after user finishes
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New version available - silent update on next visit
            newWorker.postMessage('skipWaiting');
          }
        });
      });
    }).catch(err => console.warn('[PWA] SW registration failed:', err));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANDROID "ADD TO HOME SCREEN" INSTALL PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;
let installBannerShown = false;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show install nudge after a short delay (don't interrupt intro)
  setTimeout(showInstallBanner, 4000);
});

function showInstallBanner() {
  if (installBannerShown || !deferredInstallPrompt) return;
  installBannerShown = true;

  const banner = document.createElement('div');
  banner.id = 'installBanner';
  banner.style.cssText = `
    position:fixed;bottom:0;left:0;right:0;z-index:9999;
    background:linear-gradient(135deg,#0a0520,#060218);
    border-top:1px solid rgba(0,212,255,.35);
    padding:clamp(12px,3vw,18px) clamp(14px,4vw,22px);
    display:flex;align-items:center;gap:14px;
    animation:slideUpBanner .4s cubic-bezier(.22,1,.36,1);
  `;
  banner.innerHTML = `
    <img src="icons/icon-96.png" style="width:48px;height:48px;border-radius:12px;flex-shrink:0">
    <div style="flex:1;min-width:0">
      <div style="font-family:'Cinzel Decorative',cursive;font-size:clamp(10px,2.5vw,14px);color:#fff;margin-bottom:3px">Install Neon Surge</div>
      <div style="font-size:clamp(9px,2vw,11px);color:rgba(255,255,255,.5);letter-spacing:.04em">Play offline Â· No browser chrome</div>
    </div>
    <button id="installAcceptBtn" style="
      background:linear-gradient(135deg,#00d4ff,#0060ff);border:none;
      border-radius:10px;padding:10px 18px;color:#fff;font-weight:700;
      font-size:clamp(10px,2.2vw,13px);letter-spacing:.06em;cursor:pointer;
      font-family:'Raleway',sans-serif;white-space:nowrap;flex-shrink:0;
      box-shadow:0 0 20px rgba(0,212,255,.4);
    ">Install</button>
    <button id="installDismissBtn" style="
      background:none;border:none;color:rgba(255,255,255,.35);
      font-size:20px;cursor:pointer;padding:4px 8px;flex-shrink:0;line-height:1;
    ">Ã—</button>
  `;

  // Add keyframe if not already
  if (!document.getElementById('installBannerKF')) {
    const s = document.createElement('style');
    s.id = 'installBannerKF';
    s.textContent = `@keyframes slideUpBanner{from{transform:translateY(100%);opacity:0}to{transform:none;opacity:1}}`;
    document.head.appendChild(s);
  }

  document.body.appendChild(banner);

  document.getElementById('installAcceptBtn').addEventListener('click', async () => {
    banner.remove();
    if (!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    const { outcome } = await deferredInstallPrompt.userChoice;
    console.log('[PWA] Install outcome:', outcome);
    deferredInstallPrompt = null;
  });

  document.getElementById('installDismissBtn').addEventListener('click', () => {
    banner.style.animation = 'slideUpBanner .3s reverse ease forwards';
    setTimeout(() => banner.remove(), 300);
  });
}

// Hide banner if already installed (display mode is standalone)
if (window.matchMedia('(display-mode: fullscreen)').matches ||
    window.matchMedia('(display-mode: standalone)').matches) {
  installBannerShown = true; // suppress banner
}

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installed!');
  deferredInstallPrompt = null;
  const banner = document.getElementById('installBanner');
  if (banner) banner.remove();
});

</script>
</body>
</html>
